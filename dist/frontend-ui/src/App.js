"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = require("react");
const logs_service_1 = require("./services/logs.service"); // Adjust the import path
const LogsTable_1 = __importDefault(require("./components/LogsTable")); // Adjust the import path
const Modal_1 = __importDefault(require("./components/Modal"));
const LogDetails_1 = __importDefault(require("./components/LogDetails"));
const Guardrails_1 = __importDefault(require("./components/Guardrails"));
const Config_1 = __importDefault(require("./components/Config"));
function App() {
    const [showAthenaLogs, setShowAthenaLogs] = (0, react_1.useState)(false);
    const [dynamoLogsRecord, setDynamoLogsRecord] = (0, react_1.useState)({});
    const [athenaLogsRecord, setAthenaLogsRecord] = (0, react_1.useState)({});
    const [athenaNextToken, setAthenaNextToken] = (0, react_1.useState)(null);
    const [dynamoNextToken, setDynamoNextToken] = (0, react_1.useState)(null);
    const [athenaQueryExecutionId, setAthenaQueryExecutionId] = (0, react_1.useState)(null);
    const [currentPage, setCurrentPage] = (0, react_1.useState)(0);
    const [isLoading, setIsLoading] = (0, react_1.useState)(false);
    const [isModalOpen, setIsModalOpen] = (0, react_1.useState)(false);
    const [selectedLog, setSelectedLog] = (0, react_1.useState)(null);
    const [isGuardrailsModalOpen, setIsGuardrailsModalOpen] = (0, react_1.useState)(false);
    const [isConfigModalOpen, setIsConfigModalOpen] = (0, react_1.useState)(false);
    const fetchLogsFromAthena = async () => {
        setIsLoading(true);
        try {
            const logsResponse = await (0, logs_service_1.getLogsFromAthena)(athenaNextToken, athenaQueryExecutionId);
            setAthenaLogsRecord({
                ...athenaLogsRecord,
                [currentPage + 1]: logsResponse.logs,
            });
            setCurrentPage(currentPage + 1);
            setAthenaNextToken(logsResponse.nextToken || null);
            setAthenaQueryExecutionId(logsResponse.queryExecutionId || null);
        }
        catch (error) {
            console.error(error);
        }
        finally {
            setIsLoading(false);
        }
    };
    const fetchLogsFromDynamo = async () => {
        setIsLoading(true);
        try {
            const logsResponse = await (0, logs_service_1.getLogsFromDynamo)(dynamoNextToken);
            setDynamoLogsRecord({
                ...dynamoLogsRecord,
                [currentPage + 1]: logsResponse.logs,
            });
            setCurrentPage(currentPage + 1);
            setDynamoNextToken(logsResponse.nextToken || null);
        }
        catch (error) {
            console.error(error);
        }
        finally {
            setIsLoading(false);
        }
    };
    (0, react_1.useEffect)(() => {
        if (showAthenaLogs && !athenaLogsRecord[1]) {
            fetchLogsFromAthena();
        }
        else if (!showAthenaLogs && !dynamoLogsRecord[1]) {
            fetchLogsFromDynamo();
        }
    }, [showAthenaLogs]);
    const handlePageSelect = (page) => {
        setCurrentPage(page);
    };
    const handleToggleLogs = () => {
        if (!showAthenaLogs && !athenaLogsRecord[1]) {
            setCurrentPage(0);
        }
        setShowAthenaLogs(!showAthenaLogs);
    };
    const handleNext = async () => {
        if (showAthenaLogs) {
            await fetchLogsFromAthena();
        }
        else {
            await fetchLogsFromDynamo();
        }
    };
    const handleDetailsClick = (log) => {
        console.log(log.model_routing_history);
        setSelectedLog(log);
        setIsModalOpen(true);
    };
    const handleCloseModal = () => {
        setIsModalOpen(false);
        setSelectedLog(null);
    };
    const currentLogs = showAthenaLogs
        ? athenaLogsRecord[currentPage]
        : dynamoLogsRecord[currentPage];
    const pageNumbers = showAthenaLogs
        ? Array.from(Object.keys(athenaLogsRecord))
        : Array.from(Object.keys(dynamoLogsRecord));
    const isNextButtonDisabled = showAthenaLogs
        ? !athenaNextToken
        : !dynamoNextToken;
    return (<div className="app-container">
      <header className="app-header">
        <h1>AI GATEWAY LOGS ({showAthenaLogs ? 'Athena' : 'Dynamo'})</h1>
        <div className="header-buttons">
          <button className="toggle-button" onClick={handleToggleLogs}>
            {showAthenaLogs ? 'Show Dynamo Logs' : 'Show Athena Logs'}
          </button>
          <button className="guardrails-button" onClick={() => setIsGuardrailsModalOpen(true)}>
            Manage Guardrails
          </button>
          <button className="config-button" onClick={() => setIsConfigModalOpen(true)}>
            Manage Gateway Configuration
          </button>
        </div>
      </header>
      <LogsTable_1.default logs={currentLogs || []} pageNumbers={pageNumbers} currentPage={currentPage} isNextButtonDisabled={isNextButtonDisabled} onNext={handleNext} onPageSelect={handlePageSelect} onDetailsClick={handleDetailsClick}/>
      {isLoading && (<div className="loading-overlay">
          <div className="spinner"></div>
        </div>)}
      {isModalOpen && selectedLog && (<Modal_1.default onClose={handleCloseModal}>
          <LogDetails_1.default log={selectedLog}/>
        </Modal_1.default>)}
      {isGuardrailsModalOpen && (<Modal_1.default onClose={() => setIsGuardrailsModalOpen(false)}>
          <Guardrails_1.default onClose={() => setIsGuardrailsModalOpen(false)}/>
        </Modal_1.default>)}
      {isConfigModalOpen && (<Modal_1.default onClose={() => setIsConfigModalOpen(false)}>
          <Config_1.default onClose={() => setIsConfigModalOpen(false)}/>
        </Modal_1.default>)}
    </div>);
}
exports.default = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZnJvbnRlbmQtdWkvc3JjL0FwcC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxpQ0FBNEM7QUFDNUMsMERBQStFLENBQUMseUJBQXlCO0FBQ3pHLHVFQUErQyxDQUFDLHlCQUF5QjtBQUV6RSwrREFBdUM7QUFDdkMseUVBQWdEO0FBQ2hELHlFQUFpRDtBQUNqRCxpRUFBeUM7QUFFekMsU0FBUyxHQUFHO0lBQ1YsTUFBTSxDQUFDLGNBQWMsRUFBRSxpQkFBaUIsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBVSxLQUFLLENBQUMsQ0FBQztJQUNyRSxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsbUJBQW1CLENBQUMsR0FBRyxJQUFBLGdCQUFRLEVBRXRELEVBQUUsQ0FBQyxDQUFDO0lBQ04sTUFBTSxDQUFDLGdCQUFnQixFQUFFLG1CQUFtQixDQUFDLEdBQUcsSUFBQSxnQkFBUSxFQUV0RCxFQUFFLENBQUMsQ0FBQztJQUNOLE1BQU0sQ0FBQyxlQUFlLEVBQUUsa0JBQWtCLENBQUMsR0FBRyxJQUFBLGdCQUFRLEVBQWdCLElBQUksQ0FBQyxDQUFDO0lBQzVFLE1BQU0sQ0FBQyxlQUFlLEVBQUUsa0JBQWtCLENBQUMsR0FBRyxJQUFBLGdCQUFRLEVBQWdCLElBQUksQ0FBQyxDQUFDO0lBQzVFLE1BQU0sQ0FBQyxzQkFBc0IsRUFBRSx5QkFBeUIsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFFbEUsSUFBSSxDQUFDLENBQUM7SUFDUixNQUFNLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBUyxDQUFDLENBQUMsQ0FBQztJQUMxRCxNQUFNLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBVSxLQUFLLENBQUMsQ0FBQztJQUMzRCxNQUFNLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFB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LENBQUMsU0FBUyxJQUFJLENBQ1osQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUM5QjtVQUFBLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxHQUFHLENBQ2hDO1FBQUEsRUFBRSxHQUFHLENBQUMsQ0FDUCxDQUNEO01BQUEsQ0FBQyxXQUFXLElBQUksV0FBVyxJQUFJLENBQzdCLENBQUMsZUFBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQy9CO1VBQUEsQ0FBQyxvQkFBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxFQUM5QjtRQUFBLEVBQUUsZUFBSyxDQUFDLENBQ1QsQ0FDRDtNQUFBLENBQUMscUJBQXFCLElBQUksQ0FDeEIsQ0FBQyxlQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsd0JBQXdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FDcEQ7VUFBQSxDQUFDLG9CQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsd0JBQXdCLENBQUMsS0FBSyxDQUFDLENBQUMsRUFDN0Q7UUFBQSxFQUFFLGVBQUssQ0FBQyxDQUNULENBQ0Q7TUFBQSxDQUFDLGlCQUFpQixJQUFJLENBQ3BCLENBQUMsZUFBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQ2hEO1VBQUEsQ0FBQyxnQkFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQ3JEO1FBQUEsRUFBRSxlQUFLLENBQUMsQ0FDVCxDQUNIO0lBQUEsRUFBRSxHQUFHLENBQUMsQ0FDUCxDQUFDO0FBQ0osQ0FBQztBQUVELGtCQUFlLEdBQUcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVzZUVmZmVjdCwgdXNlU3RhdGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBnZXRMb2dzRnJvbUF0aGVuYSwgZ2V0TG9nc0Zyb21EeW5hbW8gfSBmcm9tICcuL3NlcnZpY2VzL2xvZ3Muc2VydmljZSc7IC8vIEFkanVzdCB0aGUgaW1wb3J0IHBhdGhcbmltcG9ydCBMb2dzVGFibGUgZnJvbSAnLi9jb21wb25lbnRzL0xvZ3NUYWJsZSc7IC8vIEFkanVzdCB0aGUgaW1wb3J0IHBhdGhcbmltcG9ydCB7IExvZ0VudHJ5IH0gZnJvbSAnLi90eXBlcy9sb2dzLnR5cGVzJztcbmltcG9ydCBNb2RhbCBmcm9tICcuL2NvbXBvbmVudHMvTW9kYWwnO1xuaW1wb3J0IExvZ0RldGFpbCBmcm9tICcuL2NvbXBvbmVudHMvTG9nRGV0YWlscyc7XG5pbXBvcnQgR3VhcmRyYWlscyBmcm9tICcuL2NvbXBvbmVudHMvR3VhcmRyYWlscyc7XG5pbXBvcnQgQ29uZmlnIGZyb20gJy4vY29tcG9uZW50cy9Db25maWcnO1xuXG5mdW5jdGlvbiBBcHAoKSB7XG4gIGNvbnN0IFtzaG93QXRoZW5hTG9ncywgc2V0U2hvd0F0aGVuYUxvZ3NdID0gdXNlU3RhdGU8Ym9vbGVhbj4oZmFsc2UpO1xuICBjb25zdCBbZHluYW1vTG9nc1JlY29yZCwgc2V0RHluYW1vTG9nc1JlY29yZF0gPSB1c2VTdGF0ZTxcbiAgICBSZWNvcmQ8bnVtYmVyLCBMb2dFbnRyeVtdPlxuICA+KHt9KTtcbiAgY29uc3QgW2F0aGVuYUxvZ3NSZWNvcmQsIHNldEF0aGVuYUxvZ3NSZWNvcmRdID0gdXNlU3RhdGU8XG4gICAgUmVjb3JkPG51bWJlciwgTG9nRW50cnlbXT5cbiAgPih7fSk7XG4gIGNvbnN0IFthdGhlbmFOZXh0VG9rZW4sIHNldEF0aGVuYU5leHRUb2tlbl0gPSB1c2VTdGF0ZTxzdHJpbmcgfCBudWxsPihudWxsKTtcbiAgY29uc3QgW2R5bmFtb05leHRUb2tlbiwgc2V0RHluYW1vTmV4dFRva2VuXSA9IHVzZVN0YXRlPHN0cmluZyB8IG51bGw+KG51bGwpO1xuICBjb25zdCBbYXRoZW5hUXVlcnlFeGVjdXRpb25JZCwgc2V0QXRoZW5hUXVlcnlFeGVjdXRpb25JZF0gPSB1c2VTdGF0ZTxcbiAgICBzdHJpbmcgfCBudWxsXG4gID4obnVsbCk7XG4gIGNvbnN0IFtjdXJyZW50UGFnZSwgc2V0Q3VycmVudFBhZ2VdID0gdXNlU3RhdGU8bnVtYmVyPigwKTtcbiAgY29uc3QgW2lzTG9hZGluZywgc2V0SXNMb2FkaW5nXSA9IHVzZVN0YXRlPGJvb2xlYW4+KGZhbHNlKTtcbiAgY29uc3QgW2lzTW9kYWxPcGVuLCBzZXRJc01vZGFsT3Blbl0gPSB1c2VTdGF0ZTxib29sZWFuPihmYWxzZSk7XG4gIGNvbnN0IFtzZWxlY3RlZExvZywgc2V0U2VsZWN0ZWRMb2ddID0gdXNlU3RhdGU8TG9nRW50cnkgfCBudWxsPihudWxsKTtcbiAgY29uc3QgW2lzR3VhcmRyYWlsc01vZGFsT3Blbiwgc2V0SXNHdWFyZHJhaWxzTW9kYWxPcGVuXSA9XG4gICAgdXNlU3RhdGU8Ym9vbGVhbj4oZmFsc2UpO1xuICBjb25zdCBbaXNDb25maWdNb2RhbE9wZW4sIHNldElzQ29uZmlnTW9kYWxPcGVuXSA9XG4gICAgdXNlU3RhdGU8Ym9vbGVhbj4oZmFsc2UpO1xuXG4gIGNvbnN0IGZldGNoTG9nc0Zyb21BdGhlbmEgPSBhc3luYyAoKSA9PiB7XG4gICAgc2V0SXNMb2FkaW5nKHRydWUpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBsb2dzUmVzcG9uc2UgPSBhd2FpdCBnZXRMb2dzRnJvbUF0aGVuYShcbiAgICAgICAgYXRoZW5hTmV4dFRva2VuLFxuICAgICAgICBhdGhlbmFRdWVyeUV4ZWN1dGlvbklkXG4gICAgICApO1xuICAgICAgc2V0QXRoZW5hTG9nc1JlY29yZCh7XG4gICAgICAgIC4uLmF0aGVuYUxvZ3NSZWNvcmQsXG4gICAgICAgIFtjdXJyZW50UGFnZSArIDFdOiBsb2dzUmVzcG9uc2UubG9ncyxcbiAgICAgIH0pO1xuICAgICAgc2V0Q3VycmVudFBhZ2UoY3VycmVudFBhZ2UgKyAxKTtcbiAgICAgIHNldEF0aGVuYU5leHRUb2tlbihsb2dzUmVzcG9uc2UubmV4dFRva2VuIHx8IG51bGwpO1xuICAgICAgc2V0QXRoZW5hUXVlcnlFeGVjdXRpb25JZChsb2dzUmVzcG9uc2UucXVlcnlFeGVjdXRpb25JZCB8fCBudWxsKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNldElzTG9hZGluZyhmYWxzZSk7XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IGZldGNoTG9nc0Zyb21EeW5hbW8gPSBhc3luYyAoKSA9PiB7XG4gICAgc2V0SXNMb2FkaW5nKHRydWUpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBsb2dzUmVzcG9uc2UgPSBhd2FpdCBnZXRMb2dzRnJvbUR5bmFtbyhkeW5hbW9OZXh0VG9rZW4pO1xuICAgICAgc2V0RHluYW1vTG9nc1JlY29yZCh7XG4gICAgICAgIC4uLmR5bmFtb0xvZ3NSZWNvcmQsXG4gICAgICAgIFtjdXJyZW50UGFnZSArIDFdOiBsb2dzUmVzcG9uc2UubG9ncyxcbiAgICAgIH0pO1xuICAgICAgc2V0Q3VycmVudFBhZ2UoY3VycmVudFBhZ2UgKyAxKTtcbiAgICAgIHNldER5bmFtb05leHRUb2tlbihsb2dzUmVzcG9uc2UubmV4dFRva2VuIHx8IG51bGwpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgc2V0SXNMb2FkaW5nKGZhbHNlKTtcbiAgICB9XG4gIH07XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoc2hvd0F0aGVuYUxvZ3MgJiYgIWF0aGVuYUxvZ3NSZWNvcmRbMV0pIHtcbiAgICAgIGZldGNoTG9nc0Zyb21BdGhlbmEoKTtcbiAgICB9IGVsc2UgaWYgKCFzaG93QXRoZW5hTG9ncyAmJiAhZHluYW1vTG9nc1JlY29yZFsxXSkge1xuICAgICAgZmV0Y2hMb2dzRnJvbUR5bmFtbygpO1xuICAgIH1cbiAgfSwgW3Nob3dBdGhlbmFMb2dzXSk7XG5cbiAgY29uc3QgaGFuZGxlUGFnZVNlbGVjdCA9IChwYWdlOiBudW1iZXIpID0+IHtcbiAgICBzZXRDdXJyZW50UGFnZShwYWdlKTtcbiAgfTtcblxuICBjb25zdCBoYW5kbGVUb2dnbGVMb2dzID0gKCkgPT4ge1xuICAgIGlmICghc2hvd0F0aGVuYUxvZ3MgJiYgIWF0aGVuYUxvZ3NSZWNvcmRbMV0pIHtcbiAgICAgIHNldEN1cnJlbnRQYWdlKDApO1xuICAgIH1cbiAgICBzZXRTaG93QXRoZW5hTG9ncyghc2hvd0F0aGVuYUxvZ3MpO1xuICB9O1xuXG4gIGNvbnN0IGhhbmRsZU5leHQgPSBhc3luYyAoKSA9PiB7XG4gICAgaWYgKHNob3dBdGhlbmFMb2dzKSB7XG4gICAgICBhd2FpdCBmZXRjaExvZ3NGcm9tQXRoZW5hKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IGZldGNoTG9nc0Zyb21EeW5hbW8oKTtcbiAgICB9XG4gIH07XG5cbiAgY29uc3QgaGFuZGxlRGV0YWlsc0NsaWNrID0gKGxvZzogTG9nRW50cnkpID0+IHtcbiAgICBjb25zb2xlLmxvZyhsb2cubW9kZWxfcm91dGluZ19oaXN0b3J5KTtcbiAgICBzZXRTZWxlY3RlZExvZyhsb2cpO1xuICAgIHNldElzTW9kYWxPcGVuKHRydWUpO1xuICB9O1xuXG4gIGNvbnN0IGhhbmRsZUNsb3NlTW9kYWwgPSAoKSA9PiB7XG4gICAgc2V0SXNNb2RhbE9wZW4oZmFsc2UpO1xuICAgIHNldFNlbGVjdGVkTG9nKG51bGwpO1xuICB9O1xuXG4gIGNvbnN0IGN1cnJlbnRMb2dzID0gc2hvd0F0aGVuYUxvZ3NcbiAgICA/IGF0aGVuYUxvZ3NSZWNvcmRbY3VycmVudFBhZ2VdXG4gICAgOiBkeW5hbW9Mb2dzUmVjb3JkW2N1cnJlbnRQYWdlXTtcblxuICBjb25zdCBwYWdlTnVtYmVycyA9IHNob3dBdGhlbmFMb2dzXG4gICAgPyBBcnJheS5mcm9tKE9iamVjdC5rZXlzKGF0aGVuYUxvZ3NSZWNvcmQpKVxuICAgIDogQXJyYXkuZnJvbShPYmplY3Qua2V5cyhkeW5hbW9Mb2dzUmVjb3JkKSk7XG5cbiAgY29uc3QgaXNOZXh0QnV0dG9uRGlzYWJsZWQgPSBzaG93QXRoZW5hTG9nc1xuICAgID8gIWF0aGVuYU5leHRUb2tlblxuICAgIDogIWR5bmFtb05leHRUb2tlbjtcblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPVwiYXBwLWNvbnRhaW5lclwiPlxuICAgICAgPGhlYWRlciBjbGFzc05hbWU9XCJhcHAtaGVhZGVyXCI+XG4gICAgICAgIDxoMT5BSSBHQVRFV0FZIExPR1MgKHtzaG93QXRoZW5hTG9ncyA/ICdBdGhlbmEnIDogJ0R5bmFtbyd9KTwvaDE+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiaGVhZGVyLWJ1dHRvbnNcIj5cbiAgICAgICAgICA8YnV0dG9uIGNsYXNzTmFtZT1cInRvZ2dsZS1idXR0b25cIiBvbkNsaWNrPXtoYW5kbGVUb2dnbGVMb2dzfT5cbiAgICAgICAgICAgIHtzaG93QXRoZW5hTG9ncyA/ICdTaG93IER5bmFtbyBMb2dzJyA6ICdTaG93IEF0aGVuYSBMb2dzJ31cbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJndWFyZHJhaWxzLWJ1dHRvblwiXG4gICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiBzZXRJc0d1YXJkcmFpbHNNb2RhbE9wZW4odHJ1ZSl9XG4gICAgICAgICAgPlxuICAgICAgICAgICAgTWFuYWdlIEd1YXJkcmFpbHNcbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJjb25maWctYnV0dG9uXCJcbiAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHNldElzQ29uZmlnTW9kYWxPcGVuKHRydWUpfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIE1hbmFnZSBHYXRld2F5IENvbmZpZ3VyYXRpb25cbiAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2hlYWRlcj5cbiAgICAgIDxMb2dzVGFibGVcbiAgICAgICAgbG9ncz17Y3VycmVudExvZ3MgfHwgW119XG4gICAgICAgIHBhZ2VOdW1iZXJzPXtwYWdlTnVtYmVyc31cbiAgICAgICAgY3VycmVudFBhZ2U9e2N1cnJlbnRQYWdlfVxuICAgICAgICBpc05leHRCdXR0b25EaXNhYmxlZD17aXNOZXh0QnV0dG9uRGlzYWJsZWR9XG4gICAgICAgIG9uTmV4dD17aGFuZGxlTmV4dH1cbiAgICAgICAgb25QYWdlU2VsZWN0PXtoYW5kbGVQYWdlU2VsZWN0fVxuICAgICAgICBvbkRldGFpbHNDbGljaz17aGFuZGxlRGV0YWlsc0NsaWNrfVxuICAgICAgLz5cbiAgICAgIHtpc0xvYWRpbmcgJiYgKFxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImxvYWRpbmctb3ZlcmxheVwiPlxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwic3Bpbm5lclwiPjwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgICl9XG4gICAgICB7aXNNb2RhbE9wZW4gJiYgc2VsZWN0ZWRMb2cgJiYgKFxuICAgICAgICA8TW9kYWwgb25DbG9zZT17aGFuZGxlQ2xvc2VNb2RhbH0+XG4gICAgICAgICAgPExvZ0RldGFpbCBsb2c9e3NlbGVjdGVkTG9nfSAvPlxuICAgICAgICA8L01vZGFsPlxuICAgICAgKX1cbiAgICAgIHtpc0d1YXJkcmFpbHNNb2RhbE9wZW4gJiYgKFxuICAgICAgICA8TW9kYWwgb25DbG9zZT17KCkgPT4gc2V0SXNHdWFyZHJhaWxzTW9kYWxPcGVuKGZhbHNlKX0+XG4gICAgICAgICAgPEd1YXJkcmFpbHMgb25DbG9zZT17KCkgPT4gc2V0SXNHdWFyZHJhaWxzTW9kYWxPcGVuKGZhbHNlKX0gLz5cbiAgICAgICAgPC9Nb2RhbD5cbiAgICAgICl9XG4gICAgICB7aXNDb25maWdNb2RhbE9wZW4gJiYgKFxuICAgICAgICA8TW9kYWwgb25DbG9zZT17KCkgPT4gc2V0SXNDb25maWdNb2RhbE9wZW4oZmFsc2UpfT5cbiAgICAgICAgICA8Q29uZmlnIG9uQ2xvc2U9eygpID0+IHNldElzQ29uZmlnTW9kYWxPcGVuKGZhbHNlKX0gLz5cbiAgICAgICAgPC9Nb2RhbD5cbiAgICAgICl9XG4gICAgPC9kaXY+XG4gICk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IEFwcDtcbiJdfQ==
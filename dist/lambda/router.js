"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const validateRequest_1 = require("./util/validateRequest");
const extractRequestData_1 = require("./util/extractRequestData");
const getAndSaveMessages_1 = require("./util/getAndSaveMessages");
const routeRequest_1 = require("./util/routeRequest");
const modelValidation_1 = require("./util/modelValidation");
const logger_1 = require("./util/logger");
const simpleCache_1 = require("./util/simpleCache");
const semanticCache_1 = require("./util/semanticCache");
const handler = async (event) => {
    const logData = {
        requestStartTime: Date.now(),
        provider: null,
        model: null,
        tokens_used: 0,
        cost: 0,
        RawRequest: JSON.stringify(event),
    };
    try {
        const parsed = (0, validateRequest_1.validateRequest)(event);
        if (!parsed.success) {
            await (0, logger_1.logFailedRequest)({
                ...logData,
                errorMessage: 'Invalid Request Body',
            });
            return {
                statusCode: 400,
                body: JSON.stringify({
                    error: "Invalid request body.",
                    details: parsed.error.flatten(),
                }),
            };
        }
        const payload = parsed.data;
        const { threadID, prompt, provider, model, userId } = (0, extractRequestData_1.extractRequestData)(payload);
        const metadata = (0, extractRequestData_1.extractRequestMetadata)(event, payload);
        logData.model = model;
        logData.provider = provider;
        if (!prompt) {
            await (0, logger_1.logFailedRequest)({
                ...logData,
                errorMessage: 'No prompt provided in the request body',
            });
            return {
                statusCode: 400,
                body: JSON.stringify({ message: "No prompt provided in the request body." }),
            };
        }
        if (provider && model && !(0, modelValidation_1.validateModel)({ provider, model })) {
            await (0, logger_1.logFailedRequest)({
                ...logData,
                errorMessage: 'Provider and model combination invalid.',
            });
            return {
                statusCode: 400,
                body: JSON.stringify({ message: 'Provider and model combination invalid. ' })
            };
        }
        const simpleCacheResponse = await (0, simpleCache_1.checkSimpleCache)(prompt, userId, provider, model);
        if (simpleCacheResponse) {
            return {
                statusCode: 200,
                body: JSON.stringify({
                    provider,
                    simpleCacheResponse,
                }),
            };
        }
        const requestEmbedding = await (0, semanticCache_1.getEmbedding)(prompt);
        const semanticCacheResponse = await (0, semanticCache_1.checkSemanticCache)(requestEmbedding, userId, provider, model);
        if (semanticCacheResponse) {
            return {
                statusCode: 200,
                body: JSON.stringify({
                    provider,
                    semanticCacheResponse,
                }),
            };
        }
        const history = await (0, getAndSaveMessages_1.getMessageHistory)(threadID);
        const response = await (0, routeRequest_1.routeRequest)({ history, prompt, provider, model, metadata });
        await (0, getAndSaveMessages_1.saveMessages)(prompt, response.text, threadID);
        await (0, logger_1.logSuccessfulRequest)({
            ...logData,
            RawResponse: JSON.stringify(response),
        });
        // don't await - no need to wait here
        (0, simpleCache_1.addToSimpleCache)(prompt, response.text, userId, provider, model);
        (0, semanticCache_1.addToSemanticCache)(requestEmbedding, prompt, response.text, userId, provider, model);
        return {
            statusCode: 200,
            body: JSON.stringify({
                threadID,
                response
            }),
        };
    }
    catch (error) {
        console.error(error);
        const errorMessage = error instanceof Error ? error.message : 'Unknown Error';
        await (0, logger_1.logFailedRequest)({ ...logData, errorMessage });
        return {
            statusCode: 500,
            body: JSON.stringify({
                error: errorMessage,
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGFtYmRhL3JvdXRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0REFBeUQ7QUFDekQsa0VBQXVGO0FBQ3ZGLGtFQUE0RTtBQUM1RSxzREFBbUQ7QUFDbkQsNERBQXVEO0FBRXZELDBDQUl1QjtBQUN2QixvREFBd0U7QUFDeEUsd0RBQTRGO0FBR3JGLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUFVLEVBQUUsRUFBRTtJQUN4QyxNQUFNLE9BQU8sR0FBa0I7UUFDM0IsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUM1QixRQUFRLEVBQUUsSUFBSTtRQUNkLEtBQUssRUFBRSxJQUFJO1FBQ1gsV0FBVyxFQUFFLENBQUM7UUFDZCxJQUFJLEVBQUUsQ0FBQztRQUNQLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztLQUNwQyxDQUFDO0lBRUYsSUFBSSxDQUFDO1FBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBQSxpQ0FBZSxFQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDbEIsTUFBTSxJQUFBLHlCQUFnQixFQUFDO2dCQUNuQixHQUFHLE9BQU87Z0JBQ1YsWUFBWSxFQUFFLHNCQUFzQjthQUN2QyxDQUFDLENBQUM7WUFFSCxPQUFPO2dCQUNILFVBQVUsRUFBRSxHQUFHO2dCQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO29CQUNqQixLQUFLLEVBQUUsdUJBQXVCO29CQUM5QixPQUFPLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7aUJBQ2xDLENBQUM7YUFDTCxDQUFBO1FBQ0wsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDNUIsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsUUFBUSxF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QUFLLENBQUMsQ0FBQztRQUVyRixPQUFPO1lBQ0gsVUFBVSxFQUFFLEdBQUc7WUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDakIsUUFBUTtnQkFDUixRQUFRO2FBQ1gsQ0FBQztTQUNMLENBQUM7SUFDTixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFckIsTUFBTSxZQUFZLEdBQ2hCLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQztRQUUzRCxNQUFNLElBQUEseUJBQWdCLEVBQUMsRUFBRSxHQUFHLE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBRXJELE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNuQixLQUFLLEVBQUUsWUFBWTthQUNwQixDQUFDO1NBQ0gsQ0FBQTtJQUNMLENBQUM7QUFDTCxDQUFDLENBQUE7QUF0SFksUUFBQSxPQUFPLFdBc0huQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHZhbGlkYXRlUmVxdWVzdCB9IGZyb20gXCIuL3V0aWwvdmFsaWRhdGVSZXF1ZXN0XCI7XG5pbXBvcnQgeyBleHRyYWN0UmVxdWVzdERhdGEsIGV4dHJhY3RSZXF1ZXN0TWV0YWRhdGEgfSBmcm9tIFwiLi91dGlsL2V4dHJhY3RSZXF1ZXN0RGF0YVwiO1xuaW1wb3J0IHsgZ2V0TWVzc2FnZUhpc3RvcnksIHNhdmVNZXNzYWdlcyB9IGZyb20gXCIuL3V0aWwvZ2V0QW5kU2F2ZU1lc3NhZ2VzXCI7XG5pbXBvcnQgeyByb3V0ZVJlcXVlc3QgfSBmcm9tIFwiLi91dGlsL3JvdXRlUmVxdWVzdFwiO1xuaW1wb3J0IHsgdmFsaWRhdGVNb2RlbCB9IGZyb20gXCIuL3V0aWwvbW9kZWxWYWxpZGF0aW9uXCI7XG5pbXBvcnQgeyBTdXBwb3J0ZWRMTE1zLCBBbGxNb2RlbHMgfSBmcm9tIFwiLi91dGlsL3R5cGVzXCI7XG5pbXBvcnQge1xuICAgIGxvZ1N1Y2Nlc3NmdWxSZXF1ZXN0LFxuICAgIGxvZ0ZhaWxlZFJlcXVlc3QsXG4gICAgQ29tbW9uTG9nRGF0YSxcbn0gZnJvbSAnLi91dGlsL2xvZ2dlcic7XG5pbXBvcnQgeyBhZGRUb1NpbXBsZUNhY2hlLCBjaGVja1NpbXBsZUNhY2hlIH0gZnJvbSAnLi91dGlsL3NpbXBsZUNhY2hlJztcbmltcG9ydCB7IGFkZFRvU2VtYW50aWNDYWNoZSwgY2hlY2tTZW1hbnRpY0NhY2hlLCBnZXRFbWJlZGRpbmcgfSBmcm9tICcuL3V0aWwvc2VtYW50aWNDYWNoZSc7XG5pbXBvcnQgeyBwYXJzZSB9IGZyb20gJ3BhdGgnO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogYW55KSA9PiB7XG4gICAgY29uc3QgbG9nRGF0YTogQ29tbW9uTG9nRGF0YSA9IHtcbiAgICAgICAgcmVxdWVzdFN0YXJ0VGltZTogRGF0ZS5ub3coKSxcbiAgICAgICAgcHJvdmlkZXI6IG51bGwsXG4gICAgICAgIG1vZGVsOiBudWxsLFxuICAgICAgICB0b2tlbnNfdXNlZDogMCxcbiAgICAgICAgY29zdDogMCxcbiAgICAgICAgUmF3UmVxdWVzdDogSlNPTi5zdHJpbmdpZnkoZXZlbnQpLFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgICBjb25zdCBwYXJzZWQgPSB2YWxpZGF0ZVJlcXVlc3QoZXZlbnQpO1xuICAgICAgICBpZiAoIXBhcnNlZC5zdWNjZXNzKSB7XG4gICAgICAgICAgICBhd2FpdCBsb2dGYWlsZWRSZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAuLi5sb2dEYXRhLFxuICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZTogJ0ludmFsaWQgUmVxdWVzdCBCb2R5JyxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiBcIkludmFsaWQgcmVxdWVzdCBib2R5LlwiLFxuICAgICAgICAgICAgICAgICAgICBkZXRhaWxzOiBwYXJzZWQuZXJyb3IuZmxhdHRlbigpLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgfVxuICAgICAgICB9IFxuXG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSBwYXJzZWQuZGF0YTtcbiAgICAgICAgY29uc3QgeyB0aHJlYWRJRCwgcHJvbXB0LCBwcm92aWRlciwgbW9kZWwsIHVzZXJJZCB9ID0gZXh0cmFjdFJlcXVlc3REYXRhKHBheWxvYWQpO1xuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IGV4dHJhY3RSZXF1ZXN0TWV0YWRhdGEoZXZlbnQsIHBheWxvYWQpO1xuICAgICAgICBcbiAgICAgICAgbG9nRGF0YS5tb2RlbCA9IG1vZGVsIGFzIEFsbE1vZGVscztcbiAgICAgICAgbG9nRGF0YS5wcm92aWRlciA9IHByb3ZpZGVyIGFzIFN1cHBvcnRlZExMTXM7XG5cbiAgICAgICAgaWYgKCFwcm9tcHQpIHtcbiAgICAgICAgICAgIGF3YWl0IGxvZ0ZhaWxlZFJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgIC4uLmxvZ0RhdGEsXG4gICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiAnTm8gcHJvbXB0IHByb3ZpZGVkIGluIHRoZSByZXF1ZXN0IGJvZHknLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJObyBwcm9tcHQgcHJvdmlkZWQgaW4gdGhlIHJlcXVlc3QgYm9keS5cIiB9KSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocHJvdmlkZXIgJiYgbW9kZWwgJiYgIXZhbGlkYXRlTW9kZWwoeyBwcm92aWRlciwgbW9kZWwgfSkpIHtcbiAgICAgICAgICAgIGF3YWl0IGxvZ0ZhaWxlZFJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgIC4uLmxvZ0RhdGEsXG4gICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiAnUHJvdmlkZXIgYW5kIG1vZGVsIGNvbWJpbmF0aW9uIGludmFsaWQuJyxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICdQcm92aWRlciBhbmQgbW9kZWwgY29tYmluYXRpb24gaW52YWxpZC4gJ30pXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzaW1wbGVDYWNoZVJlc3BvbnNlID0gYXdhaXQgY2hlY2tTaW1wbGVDYWNoZShwcm9tcHQsIHVzZXJJZCwgcHJvdmlkZXIsIG1vZGVsKTtcbiAgICAgICAgaWYgKHNpbXBsZUNhY2hlUmVzcG9uc2UpIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLFxuICAgICAgICAgICAgICAgICAgc2ltcGxlQ2FjaGVSZXNwb25zZSxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlcXVlc3RFbWJlZGRpbmcgPSBhd2FpdCBnZXRFbWJlZGRpbmcocHJvbXB0KTtcbiAgICAgICAgY29uc3Qgc2VtYW50aWNDYWNoZVJlc3BvbnNlID0gXG4gICAgICAgICAgYXdhaXQgY2hlY2tTZW1hbnRpY0NhY2hlKHJlcXVlc3RFbWJlZGRpbmcsIHVzZXJJZCwgcHJvdmlkZXIsIG1vZGVsKTtcbiAgICAgICAgaWYgKHNlbWFudGljQ2FjaGVSZXNwb25zZSkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgIHByb3ZpZGVyLFxuICAgICAgICAgICAgICBzZW1hbnRpY0NhY2hlUmVzcG9uc2UsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGhpc3RvcnkgPSBhd2FpdCBnZXRNZXNzYWdlSGlzdG9yeSh0aHJlYWRJRCk7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcm91dGVSZXF1ZXN0KHsgaGlzdG9yeSwgcHJvbXB0LCBwcm92aWRlciwgbW9kZWwsIG1ldGFkYXRhIH0pO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgc2F2ZU1lc3NhZ2VzKHByb21wdCwgcmVzcG9uc2UudGV4dCwgdGhyZWFkSUQpOyBcblxuICAgICAgICBhd2FpdCBsb2dTdWNjZXNzZnVsUmVxdWVzdCh7XG4gICAgICAgICAgICAuLi5sb2dEYXRhLFxuICAgICAgICAgICAgUmF3UmVzcG9uc2U6IEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gZG9uJ3QgYXdhaXQgLSBubyBuZWVkIHRvIHdhaXQgaGVyZVxuICAgICAgICBhZGRUb1NpbXBsZUNhY2hlKHByb21wdCwgcmVzcG9uc2UudGV4dCwgdXNlcklkLCBwcm92aWRlciwgbW9kZWwpO1xuICAgICAgICBhZGRUb1NlbWFudGljQ2FjaGUocmVxdWVzdEVtYmVkZGluZywgcHJvbXB0LCByZXNwb25zZS50ZXh0LCB1c2VySWQsIHByb3ZpZGVyLCBtb2RlbCk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICB0aHJlYWRJRCxcbiAgICAgICAgICAgICAgICByZXNwb25zZVxuICAgICAgICAgICAgfSksXG4gICAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG5cbiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID1cbiAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIEVycm9yJztcbiAgICBcbiAgICAgICAgYXdhaXQgbG9nRmFpbGVkUmVxdWVzdCh7IC4uLmxvZ0RhdGEsIGVycm9yTWVzc2FnZSB9KTtcbiAgICBcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgZXJyb3I6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfVxuICAgIH1cbn1cblxuXG5cblxuXG5cbiJdfQ==
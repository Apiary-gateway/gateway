"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.logFailedRequest = exports.logSuccessfulRequest = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const uuid_1 = require("uuid");
const parquets = require("parquets");
const os = require("os");
const path = require("path");
const promises_1 = require("fs/promises");
const s3 = new client_s3_1.S3Client({});
const ddb = new client_dynamodb_1.DynamoDBClient({});
const LOG_BUCKET = process.env.LOG_BUCKET_NAME;
const LOG_TABLE_NAME = process.env.LOG_TABLE_NAME;
if (!LOG_BUCKET || !LOG_TABLE_NAME) {
    throw new Error('LOG_BUCKET_NAME and LOG_TABLE_NAME must be set');
}
process.on('warning', (warning) => {
    if (warning.name !== 'DeprecationWarning') {
        console.warn(warning);
    }
});
const saveLog = async (log, status) => {
    try {
        const now = new Date();
        const timestamp = now.toISOString(); // e.g., "2025-03-27T21:41:07.770Z"
        const thread_ts = timestamp;
        const latency = BigInt(Date.now() - log.requestStartTime);
        const date = timestamp.split('T')[0]; // "2025-03-27"
        const provider = log.provider ?? 'unknown';
        const model = log.model ?? 'unknown';
        const id = (0, uuid_1.v4)();
        const structuredLog = {
            id,
            thread_ts,
            timestamp,
            latency,
            provider,
            model,
            tokens_used: BigInt(log.tokens_used),
            cost: log.cost,
            raw_request: log.RawRequest,
            raw_response: log.RawResponse,
            error_message: log.errorMessage,
            status,
        };
        // Write to Parquet
        const schema = new parquets.ParquetSchema({
            id: { type: 'UTF8' },
            thread_ts: { type: 'UTF8' },
            timestamp: { type: 'UTF8' },
            latency: { type: 'INT64' },
            provider: { type: 'UTF8' },
            model: { type: 'UTF8' },
            tokens_used: { type: 'INT64' },
            cost: { type: 'DOUBLE' },
            raw_request: { type: 'UTF8' },
            raw_response: { type: 'UTF8', optional: true },
            error_message: { type: 'UTF8', optional: true },
            status: { type: 'UTF8' },
        });
        const tmpFilePath = path.join(os.tmpdir(), `${id}.parquet`);
        const writer = await parquets.ParquetWriter.openFile(schema, tmpFilePath);
        await writer.appendRow(structuredLog);
        await writer.close();
        const buffer = await (0, promises_1.readFile)(tmpFilePath);
        await (0, promises_1.unlink)(tmpFilePath);
        const key = `logs/parquet/status=${status}/date=${date}/provider=${provider}/model=${model}/${id}.parquet`;
        await s3.send(new client_s3_1.PutObjectCommand({
            Bucket: LOG_BUCKET,
            Key: key,
            Body: buffer,
            ContentType: 'application/octet-stream',
        }));
        // Write to DynamoDB with single-table design:
        // PK is a constant ("LOG") and SK is "TS#<timestamp>"
        await ddb.send(new client_dynamodb_1.PutItemCommand({
            TableName: LOG_TABLE_NAME,
            Item: {
                PK: { S: 'LOG' },
                SK: { S: `TS#${timestamp}` },
                id: { S: id },
                thread_ts: { S: thread_ts },
                timestamp: { S: timestamp },
                latency: { N: latency.toString() },
                provider: { S: provider },
                model: { S: model },
                tokens_used: { N: log.tokens_used.toString() },
                cost: { N: log.cost.toString() },
                raw_request: { S: log.RawRequest },
                raw_response: log.RawResponse
                    ? { S: log.RawResponse }
                    : { NULL: true },
                error_message: log.errorMessage
                    ? { S: log.errorMessage }
                    : { NULL: true },
                status: { S: status },
            },
        }));
    }
    catch (err) {
        console.error('[LogError] Failed to write log to S3 or DynamoDB:', err);
        throw err; // Optional: rethrow to allow caller to handle
    }
};
const logSuccessfulRequest = async (logData) => {
    console.log('[Success]', logData);
    await saveLog(logData, 'success');
};
exports.logSuccessfulRequest = logSuccessfulRequest;
const logFailedRequest = async (logData) => {
    console.error('[Failure]', logData);
    await saveLog(logData, 'failure');
};
exports.logFailedRequest = logFailedRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL3V0aWwvbG9nZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGtEQUFnRTtBQUNoRSw4REFBMEU7QUFDMUUsK0JBQW9DO0FBQ3BDLHFDQUFxQztBQUNyQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLDBDQUErQztBQThCL0MsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVCLE1BQU0sR0FBRyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVuQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztBQUMvQyxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztBQUVsRCxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO0FBQ3BFLENBQUM7QUFFRCxPQUFPLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFO0lBQ2hDLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxvQkFBb0IsRUFBRSxDQUFDO1FBQzFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDeEIsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEdBQWtCLEVBQUUsTUFBNkIsRUFBRSxFQUFFO0lBQzFFLElBQUksQ0FBQztRQUNILE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsbUNBQW1DO1FBQ3hFLE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUM1QixN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QUFFLE1BQU0sRUFBRTthQUN0QjtTQUNGLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLG1EQUFtRCxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3hFLE1BQU0sR0FBRyxDQUFDLENBQUMsOENBQThDO0lBQzNELENBQUM7QUFDSCxDQUFDLENBQUM7QUFFSyxNQUFNLG9CQUFvQixHQUFHLEtBQUssRUFDdkMsT0FBZ0QsRUFDaEQsRUFBRTtJQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2xDLE1BQU0sT0FBTyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNwQyxDQUFDLENBQUM7QUFMVyxRQUFBLG9CQUFvQix3QkFLL0I7QUFFSyxNQUFNLGdCQUFnQixHQUFHLEtBQUssRUFDbkMsT0FBaUQsRUFDakQsRUFBRTtJQUNGLE9BQU8sQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sT0FBTyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNwQyxDQUFDLENBQUM7QUFMVyxRQUFBLGdCQUFnQixvQkFLM0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTM0NsaWVudCwgUHV0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgKiBhcyBwYXJxdWV0cyBmcm9tICdwYXJxdWV0cyc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcmVhZEZpbGUsIHVubGluayB9IGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IFN1cHBvcnRlZExMTXMsIEFsbE1vZGVscyB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbW1vbkxvZ0RhdGEge1xuICByZXF1ZXN0U3RhcnRUaW1lOiBudW1iZXI7XG4gIHByb3ZpZGVyOiBTdXBwb3J0ZWRMTE1zIHwgbnVsbDtcbiAgbW9kZWw6IEFsbE1vZGVscyB8IG51bGw7XG4gIHRva2Vuc191c2VkOiBudW1iZXI7XG4gIGNvc3Q6IG51bWJlcjtcbiAgUmF3UmVxdWVzdDogc3RyaW5nO1xuICBSYXdSZXNwb25zZT86IHN0cmluZztcbiAgZXJyb3JNZXNzYWdlPzogc3RyaW5nO1xuICBjYWNoZWQ/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgSW50ZXJuYWxMb2dEYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgdGhyZWFkX3RzOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogc3RyaW5nO1xuICBsYXRlbmN5OiBiaWdpbnQ7XG4gIHByb3ZpZGVyOiBzdHJpbmc7XG4gIG1vZGVsOiBzdHJpbmc7XG4gIHRva2Vuc191c2VkOiBiaWdpbnQ7XG4gIGNvc3Q6IG51bWJlcjtcbiAgcmF3X3JlcXVlc3Q6IHN0cmluZztcbiAgcmF3X3Jlc3BvbnNlPzogc3RyaW5nO1xuICBlcnJvcl9tZXNzYWdlPzogc3RyaW5nO1xuICBzdGF0dXM6IHN0cmluZztcbn1cblxuY29uc3QgczMgPSBuZXcgUzNDbGllbnQoe30pO1xuY29uc3QgZGRiID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcblxuY29uc3QgTE9HX0JVQ0tFVCA9IHByb2Nlc3MuZW52LkxPR19CVUNLRVRfTkFNRTtcbmNvbnN0IExPR19UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuTE9HX1RBQkxFX05BTUU7XG5cbmlmICghTE9HX0JVQ0tFVCB8fCAhTE9HX1RBQkxFX05BTUUpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdMT0dfQlVDS0VUX05BTUUgYW5kIExPR19UQUJMRV9OQU1FIG11c3QgYmUgc2V0Jyk7XG59XG5cbnByb2Nlc3Mub24oJ3dhcm5pbmcnLCAod2FybmluZykgPT4ge1xuICBpZiAod2FybmluZy5uYW1lICE9PSAnRGVwcmVjYXRpb25XYXJuaW5nJykge1xuICAgIGNvbnNvbGUud2Fybih3YXJuaW5nKTtcbiAgfVxufSk7XG5cbmNvbnN0IHNhdmVMb2cgPSBhc3luYyAobG9nOiBDb21tb25Mb2dEYXRhLCBzdGF0dXM6ICdzdWNjZXNzJyB8ICdmYWlsdXJlJykgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgdGltZXN0YW1wID0gbm93LnRvSVNPU3RyaW5nKCk7IC8vIGUuZy4sIFwiMjAyNS0wMy0yN1QyMTo0MTowNy43NzBaXCJcbiAgICBjb25zdCB0aHJlYWRfdHMgPSB0aW1lc3RhbXA7XG4gICAgY29uc3QgbGF0ZW5jeSA9IEJpZ0ludChEYXRlLm5vdygpIC0gbG9nLnJlcXVlc3RTdGFydFRpbWUpO1xuICAgIGNvbnN0IGRhdGUgPSB0aW1lc3RhbXAuc3BsaXQoJ1QnKVswXTsgLy8gXCIyMDI1LTAzLTI3XCJcbiAgICBjb25zdCBwcm92aWRlciA9IGxvZy5wcm92aWRlciA/PyAndW5rbm93bic7XG4gICAgY29uc3QgbW9kZWwgPSBsb2cubW9kZWwgPz8gJ3Vua25vd24nO1xuICAgIGNvbnN0IGlkID0gdXVpZHY0KCk7XG5cbiAgICBjb25zdCBzdHJ1Y3R1cmVkTG9nOiBJbnRlcm5hbExvZ0RhdGEgPSB7XG4gICAgICBpZCxcbiAgICAgIHRocmVhZF90cyxcbiAgICAgIHRpbWVzdGFtcCxcbiAgICAgIGxhdGVuY3ksXG4gICAgICBwcm92aWRlcixcbiAgICAgIG1vZGVsLFxuICAgICAgdG9rZW5zX3VzZWQ6IEJpZ0ludChsb2cudG9rZW5zX3VzZWQpLFxuICAgICAgY29zdDogbG9nLmNvc3QsXG4gICAgICByYXdfcmVxdWVzdDogbG9nLlJhd1JlcXVlc3QsXG4gICAgICByYXdfcmVzcG9uc2U6IGxvZy5SYXdSZXNwb25zZSxcbiAgICAgIGVycm9yX21lc3NhZ2U6IGxvZy5lcnJvck1lc3NhZ2UsXG4gICAgICBzdGF0dXMsXG4gICAgfTtcblxuICAgIC8vIFdyaXRlIHRvIFBhcnF1ZXRcbiAgICBjb25zdCBzY2hlbWEgPSBuZXcgcGFycXVldHMuUGFycXVldFNjaGVtYSh7XG4gICAgICBpZDogeyB0eXBlOiAnVVRGOCcgfSxcbiAgICAgIHRocmVhZF90czogeyB0eXBlOiAnVVRGOCcgfSxcbiAgICAgIHRpbWVzdGFtcDogeyB0eXBlOiAnVVRGOCcgfSxcbiAgICAgIGxhdGVuY3k6IHsgdHlwZTogJ0lOVDY0JyB9LFxuICAgICAgcHJvdmlkZXI6IHsgdHlwZTogJ1VURjgnIH0sXG4gICAgICBtb2RlbDogeyB0eXBlOiAnVVRGOCcgfSxcbiAgICAgIHRva2Vuc191c2VkOiB7IHR5cGU6ICdJTlQ2NCcgfSxcbiAgICAgIGNvc3Q6IHsgdHlwZTogJ0RPVUJMRScgfSxcbiAgICAgIHJhd19yZXF1ZXN0OiB7IHR5cGU6ICdVVEY4JyB9LFxuICAgICAgcmF3X3Jlc3BvbnNlOiB7IHR5cGU6ICdVVEY4Jywgb3B0aW9uYWw6IHRydWUgfSxcbiAgICAgIGVycm9yX21lc3NhZ2U6IHsgdHlwZTogJ1VURjgnLCBvcHRpb25hbDogdHJ1ZSB9LFxuICAgICAgc3RhdHVzOiB7IHR5cGU6ICdVVEY4JyB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgdG1wRmlsZVBhdGggPSBwYXRoLmpvaW4ob3MudG1wZGlyKCksIGAke2lkfS5wYXJxdWV0YCk7XG4gICAgY29uc3Qgd3JpdGVyID0gYXdhaXQgcGFycXVldHMuUGFycXVldFdyaXRlci5vcGVuRmlsZShzY2hlbWEsIHRtcEZpbGVQYXRoKTtcbiAgICBhd2FpdCB3cml0ZXIuYXBwZW5kUm93KHN0cnVjdHVyZWRMb2cpO1xuICAgIGF3YWl0IHdyaXRlci5jbG9zZSgpO1xuXG4gICAgY29uc3QgYnVmZmVyID0gYXdhaXQgcmVhZEZpbGUodG1wRmlsZVBhdGgpO1xuICAgIGF3YWl0IHVubGluayh0bXBGaWxlUGF0aCk7XG5cbiAgICBjb25zdCBrZXkgPSBgbG9ncy9wYXJxdWV0L3N0YXR1cz0ke3N0YXR1c30vZGF0ZT0ke2RhdGV9L3Byb3ZpZGVyPSR7cHJvdmlkZXJ9L21vZGVsPSR7bW9kZWx9LyR7aWR9LnBhcnF1ZXRgO1xuXG4gICAgYXdhaXQgczMuc2VuZChcbiAgICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgQnVja2V0OiBMT0dfQlVDS0VULFxuICAgICAgICBLZXk6IGtleSxcbiAgICAgICAgQm9keTogYnVmZmVyLFxuICAgICAgICBDb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScsXG4gICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBXcml0ZSB0byBEeW5hbW9EQiB3aXRoIHNpbmdsZS10YWJsZSBkZXNpZ246XG4gICAgLy8gUEsgaXMgYSBjb25zdGFudCAoXCJMT0dcIikgYW5kIFNLIGlzIFwiVFMjPHRpbWVzdGFtcD5cIlxuICAgIGF3YWl0IGRkYi5zZW5kKFxuICAgICAgbmV3IFB1dEl0ZW1Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBMT0dfVEFCTEVfTkFNRSxcbiAgICAgICAgSXRlbToge1xuICAgICAgICAgIFBLOiB7IFM6ICdMT0cnIH0sXG4gICAgICAgICAgU0s6IHsgUzogYFRTIyR7dGltZXN0YW1wfWAgfSxcbiAgICAgICAgICBpZDogeyBTOiBpZCB9LFxuICAgICAgICAgIHRocmVhZF90czogeyBTOiB0aHJlYWRfdHMgfSxcbiAgICAgICAgICB0aW1lc3RhbXA6IHsgUzogdGltZXN0YW1wIH0sXG4gICAgICAgICAgbGF0ZW5jeTogeyBOOiBsYXRlbmN5LnRvU3RyaW5nKCkgfSxcbiAgICAgICAgICBwcm92aWRlcjogeyBTOiBwcm92aWRlciB9LFxuICAgICAgICAgIG1vZGVsOiB7IFM6IG1vZGVsIH0sXG4gICAgICAgICAgdG9rZW5zX3VzZWQ6IHsgTjogbG9nLnRva2Vuc191c2VkLnRvU3RyaW5nKCkgfSxcbiAgICAgICAgICBjb3N0OiB7IE46IGxvZy5jb3N0LnRvU3RyaW5nKCkgfSxcbiAgICAgICAgICByYXdfcmVxdWVzdDogeyBTOiBsb2cuUmF3UmVxdWVzdCB9LFxuICAgICAgICAgIHJhd19yZXNwb25zZTogbG9nLlJhd1Jlc3BvbnNlXG4gICAgICAgICAgICA/IHsgUzogbG9nLlJhd1Jlc3BvbnNlIH1cbiAgICAgICAgICAgIDogeyBOVUxMOiB0cnVlIH0sXG4gICAgICAgICAgZXJyb3JfbWVzc2FnZTogbG9nLmVycm9yTWVzc2FnZVxuICAgICAgICAgICAgPyB7IFM6IGxvZy5lcnJvck1lc3NhZ2UgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICBzdGF0dXM6IHsgUzogc3RhdHVzIH0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1tMb2dFcnJvcl0gRmFpbGVkIHRvIHdyaXRlIGxvZyB0byBTMyBvciBEeW5hbW9EQjonLCBlcnIpO1xuICAgIHRocm93IGVycjsgLy8gT3B0aW9uYWw6IHJldGhyb3cgdG8gYWxsb3cgY2FsbGVyIHRvIGhhbmRsZVxuICB9XG59O1xuXG5leHBvcnQgY29uc3QgbG9nU3VjY2Vzc2Z1bFJlcXVlc3QgPSBhc3luYyAoXG4gIGxvZ0RhdGE6IENvbW1vbkxvZ0RhdGEgJiB7IFJhd1Jlc3BvbnNlOiBzdHJpbmcgfVxuKSA9PiB7XG4gIGNvbnNvbGUubG9nKCdbU3VjY2Vzc10nLCBsb2dEYXRhKTtcbiAgYXdhaXQgc2F2ZUxvZyhsb2dEYXRhLCAnc3VjY2VzcycpO1xufTtcblxuZXhwb3J0IGNvbnN0IGxvZ0ZhaWxlZFJlcXVlc3QgPSBhc3luYyAoXG4gIGxvZ0RhdGE6IENvbW1vbkxvZ0RhdGEgJiB7IGVycm9yTWVzc2FnZTogc3RyaW5nIH1cbikgPT4ge1xuICBjb25zb2xlLmVycm9yKCdbRmFpbHVyZV0nLCBsb2dEYXRhKTtcbiAgYXdhaXQgc2F2ZUxvZyhsb2dEYXRhLCAnZmFpbHVyZScpO1xufTtcbiJdfQ==
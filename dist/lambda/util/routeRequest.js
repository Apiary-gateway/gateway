"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.routeRequest = routeRequest;
const routingConfigData_1 = require("./routingConfigData");
const callLLM_1 = require("./callLLM");
const errorHandling_1 = require("./errorHandling");
const constants_1 = require("./constants");
const constants_2 = require("./constants");
async function routeRequest({ history, prompt, provider, model, metadata }) {
    const conditions = routingConfigData_1.routingConfig.conditions || [];
    if (provider) {
        model = model || constants_2.MODELS[provider][0];
        return await routeToSpecified({ history, prompt, provider, model });
    }
    if (conditions.length > 0 && metadata) {
        for (const cond of conditions) {
            if (cond.query(metadata)) { // fulfills condition, call load balance
                try {
                    const selectedModel = weightedPick(cond.loadBalance);
                    return await (0, callLLM_1.default)({
                        history,
                        prompt,
                        provider: selectedModel.provider,
                        model: selectedModel.model
                    });
                }
                catch (error) {
                    return await handleRoutingError(error, history, prompt, cond);
                }
            }
        }
    }
    return await routeToDefault({ history, prompt });
}
async function handleRoutingError(error, history, prompt, condition) {
    const statusCode = (0, errorHandling_1.getErrorStatusCode)(error);
    console.log('statusCode:', statusCode);
    const fallbackStatuses = routingConfigData_1.routingConfig.fallbackOnStatus || constants_1.FALLBACK_STATUS_CODES;
    if (statusCode && fallbackStatuses.includes(statusCode)) {
        return await routeToFallback({ history, prompt, condition });
    }
    else {
        console.error('Error routing request:', error);
        throw error;
    }
}
async function routeToDefault({ history, prompt, condition }) {
    try {
        const { provider, model } = routingConfigData_1.routingConfig.defaultModel;
        return await (0, callLLM_1.default)({ history, prompt, provider, model });
    }
    catch (error) {
        return handleRoutingError(error, history, prompt, condition);
    }
}
async function routeToFallback({ history, prompt, condition }) {
    const fallbackModel = condition?.fallbackModel || routingConfigData_1.routingConfig.fallbackModel;
    const result = await (0, callLLM_1.default)({
        history,
        prompt,
        provider: fallbackModel.provider,
        model: fallbackModel.model
    });
    return result;
}
async function routeToSpecified({ history, prompt, provider, model }) {
    try {
        return await (0, callLLM_1.default)({ history, prompt, provider, model });
    }
    catch (error) {
        return handleRoutingError(error, history, prompt);
    }
}
function weightedPick(choices) {
    if (!choices.length) {
        throw new Error('No choices provided for weighted selection');
    }
    const totalWeight = choices.reduce((acc, choice) => acc + choice.weight, 0);
    const randomWeight = Math.random() * totalWeight;
    let currentWeight = 0;
    for (const choice of choices) {
        currentWeight += choice.weight;
        if (randomWeight < currentWeight) {
            return choice;
        }
    }
    return choices[choices.length - 1];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVSZXF1ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL3V0aWwvcm91dGVSZXF1ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBU0Esb0NBOEJDO0FBdkNELDJEQUFtRDtBQUVuRCx1Q0FBZ0M7QUFFaEMsbURBQXFEO0FBQ3JELDJDQUFvRDtBQUNwRCwyQ0FBcUM7QUFHOUIsS0FBSyxVQUFVLFlBQVksQ0FBQyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQW9CO0lBRS9GLE1BQU0sVUFBVSxHQUFHLGlDQUFhLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztJQUVsRCxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBQ2IsS0FBSyxHQUFHLEtBQUssSUFBSSxrQkFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3BDLE9BQU8sTUFBTSxnQkFBZ0IsQ0FBQyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7SUFDckUsQ0FBQztJQUVELElBQUksVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksUUFBUSxFQUFFLENBQUM7UUFDdEMsS0FBSyxNQUFNLElBQUksSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUU5QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLHdDQUF3QztnQkFDbEUsSUFBSSxDQUFDO29CQUNILE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBQ3JELE9BQU8sTUFBTSxJQUFBLGlCQUFPLEVBQUM7d0JBQ25CLE9BQU87d0JBQ1AsTUFBTTt3QkFDTixRQUFRLEVBQUUsYUFBYSxDQUFDLFFBQVE7d0JBQ2hDLEtBQUssRUFBRSxhQUFhLENBQUMsS0FBSztxQkFDM0IsQ0FBQyxDQUFBO2dCQUVK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QUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM1RSxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFDO0lBRWpELElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztJQUN0QixLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzdCLGFBQWEsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQy9CLElBQUksWUFBWSxHQUFHLGFBQWEsRUFBRSxDQUFDO1lBQ2pDLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUM7SUFDSCxDQUFDO0lBRUQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNyQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcm91dGluZ0NvbmZpZyB9IGZyb20gJy4vcm91dGluZ0NvbmZpZ0RhdGEnXG5pbXBvcnQgeyBDYWxsTExNQXJncywgV2VpZ2h0ZWRQcm92aWRlck1vZGVsLCBQcm92aWRlck1vZGVsLCBSb3V0ZVJlcXVlc3RBcmdzIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgY2FsbExMTSBmcm9tICcuL2NhbGxMTE0nO1xuaW1wb3J0IHsgQ29tcGxldGlvblJlc3BvbnNlIH0gZnJvbSAndG9rZW4uanMnO1xuaW1wb3J0IHsgZ2V0RXJyb3JTdGF0dXNDb2RlIH0gZnJvbSAnLi9lcnJvckhhbmRsaW5nJztcbmltcG9ydCB7IEZBTExCQUNLX1NUQVRVU19DT0RFUyB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IE1PREVMUyB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcm91dGVSZXF1ZXN0KHsgaGlzdG9yeSwgcHJvbXB0LCBwcm92aWRlciwgbW9kZWwsIG1ldGFkYXRhIH06IFJvdXRlUmVxdWVzdEFyZ3MpOlxuUHJvbWlzZTx7IHRleHQ6IHN0cmluZywgdXNhZ2U6IENvbXBsZXRpb25SZXNwb25zZVsndXNhZ2UnXSB9PiB7XG4gICAgY29uc3QgY29uZGl0aW9ucyA9IHJvdXRpbmdDb25maWcuY29uZGl0aW9ucyB8fCBbXTtcblxuICAgIGlmIChwcm92aWRlcikge1xuICAgICAgbW9kZWwgPSBtb2RlbCB8fCBNT0RFTFNbcHJvdmlkZXJdWzBdXG4gICAgICByZXR1cm4gYXdhaXQgcm91dGVUb1NwZWNpZmllZCh7IGhpc3RvcnksIHByb21wdCwgcHJvdmlkZXIsIG1vZGVsIH0pXG4gICAgfVxuXG4gICAgaWYgKGNvbmRpdGlvbnMubGVuZ3RoID4gMCAmJiBtZXRhZGF0YSkge1xuICAgICAgZm9yIChjb25zdCBjb25kIG9mIGNvbmRpdGlvbnMpIHtcblxuICAgICAgICBpZiAoY29uZC5xdWVyeShtZXRhZGF0YSkpIHsgLy8gZnVsZmlsbHMgY29uZGl0aW9uLCBjYWxsIGxvYWQgYmFsYW5jZVxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZE1vZGVsID0gd2VpZ2h0ZWRQaWNrKGNvbmQubG9hZEJhbGFuY2UpO1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNhbGxMTE0oeyBcbiAgICAgICAgICAgICAgaGlzdG9yeSwgXG4gICAgICAgICAgICAgIHByb21wdCwgXG4gICAgICAgICAgICAgIHByb3ZpZGVyOiBzZWxlY3RlZE1vZGVsLnByb3ZpZGVyLCBcbiAgICAgICAgICAgICAgbW9kZWw6IHNlbGVjdGVkTW9kZWwubW9kZWwgXG4gICAgICAgICAgICB9KVxuICBcbiAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZVJvdXRpbmdFcnJvcihlcnJvciwgaGlzdG9yeSwgcHJvbXB0LCBjb25kKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHJvdXRlVG9EZWZhdWx0KHsgaGlzdG9yeSwgcHJvbXB0IH0pXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVJvdXRpbmdFcnJvcihcbiAgZXJyb3I6IGFueSxcbiAgaGlzdG9yeTogUm91dGVSZXF1ZXN0QXJnc1snaGlzdG9yeSddLFxuICBwcm9tcHQ6IFJvdXRlUmVxdWVzdEFyZ3NbJ3Byb21wdCddLFxuICBjb25kaXRpb24/OiBSb3V0ZVJlcXVlc3RBcmdzWydjb25kaXRpb24nXVxuKSB7XG4gIGNvbnN0IHN0YXR1c0NvZGUgPSBnZXRFcnJvclN0YXR1c0NvZGUoZXJyb3IpO1xuICBjb25zb2xlLmxvZygnc3RhdHVzQ29kZTonLCBzdGF0dXNDb2RlKTtcblxuICBjb25zdCBmYWxsYmFja1N0YXR1c2VzID0gcm91dGluZ0NvbmZpZy5mYWxsYmFja09uU3RhdHVzIHx8IEZBTExCQUNLX1NUQVRVU19DT0RFUztcbiAgaWYgKHN0YXR1c0NvZGUgJiYgZmFsbGJhY2tTdGF0dXNlcy5pbmNsdWRlcyhzdGF0dXNDb2RlKSkge1xuICAgIHJldHVybiBhd2FpdCByb3V0ZVRvRmFsbGJhY2soeyBoaXN0b3J5LCBwcm9tcHQsIGNvbmRpdGlvbiB9KTtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciByb3V0aW5nIHJlcXVlc3Q6JywgZXJyb3IpXG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcm91dGVUb0RlZmF1bHQoeyBoaXN0b3J5LCBwcm9tcHQsIGNvbmRpdGlvbiB9OiBSb3V0ZVJlcXVlc3RBcmdzKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBwcm92aWRlciwgbW9kZWwgfSA9IHJvdXRpbmdDb25maWcuZGVmYXVsdE1vZGVsO1xuICAgIHJldHVybiBhd2FpdCBjYWxsTExNKHsgaGlzdG9yeSwgcHJvbXB0LCBwcm92aWRlciwgbW9kZWwgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZVJvdXRpbmdFcnJvcihlcnJvciwgaGlzdG9yeSwgcHJvbXB0LCBjb25kaXRpb24pO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJvdXRlVG9GYWxsYmFjayh7IGhpc3RvcnksIHByb21wdCwgY29uZGl0aW9uIH06IFJvdXRlUmVxdWVzdEFyZ3MpIHtcbiAgY29uc3QgZmFsbGJhY2tNb2RlbCA9IGNvbmRpdGlvbj8uZmFsbGJhY2tNb2RlbCB8fCByb3V0aW5nQ29uZmlnLmZhbGxiYWNrTW9kZWw7XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY2FsbExMTSh7IFxuICAgICAgaGlzdG9yeSwgXG4gICAgICBwcm9tcHQsIFxuICAgICAgcHJvdmlkZXI6IGZhbGxiYWNrTW9kZWwucHJvdmlkZXIsIFxuICAgICAgbW9kZWw6IGZhbGxiYWNrTW9kZWwubW9kZWwgXG4gIH0pO1xuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJvdXRlVG9TcGVjaWZpZWQoeyBoaXN0b3J5LCBwcm9tcHQsIHByb3ZpZGVyLCBtb2RlbCB9OiBDYWxsTExNQXJncykge1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBjYWxsTExNKHsgaGlzdG9yeSwgcHJvbXB0LCBwcm92aWRlciwgbW9kZWwgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZVJvdXRpbmdFcnJvcihlcnJvciwgaGlzdG9yeSwgcHJvbXB0KTtcbiAgfVxufVxuXG5mdW5jdGlvbiB3ZWlnaHRlZFBpY2soY2hvaWNlczogV2VpZ2h0ZWRQcm92aWRlck1vZGVsW10pOiBQcm92aWRlck1vZGVsIHtcbiAgaWYgKCFjaG9pY2VzLmxlbmd0aCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm8gY2hvaWNlcyBwcm92aWRlZCBmb3Igd2VpZ2h0ZWQgc2VsZWN0aW9uJyk7XG4gIH1cblxuICBjb25zdCB0b3RhbFdlaWdodCA9IGNob2ljZXMucmVkdWNlKChhY2MsIGNob2ljZSkgPT4gYWNjICsgY2hvaWNlLndlaWdodCwgMCk7XG4gIGNvbnN0IHJhbmRvbVdlaWdodCA9IE1hdGgucmFuZG9tKCkgKiB0b3RhbFdlaWdodDtcblxuICBsZXQgY3VycmVudFdlaWdodCA9IDA7XG4gIGZvciAoY29uc3QgY2hvaWNlIG9mIGNob2ljZXMpIHtcbiAgICBjdXJyZW50V2VpZ2h0ICs9IGNob2ljZS53ZWlnaHQ7XG4gICAgaWYgKHJhbmRvbVdlaWdodCA8IGN1cnJlbnRXZWlnaHQpIHtcbiAgICAgIHJldHVybiBjaG9pY2U7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGNob2ljZXNbY2hvaWNlcy5sZW5ndGggLSAxXTtcbn1cblxuIl19
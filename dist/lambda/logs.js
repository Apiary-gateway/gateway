"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_athena_1 = require("@aws-sdk/client-athena");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const athenaClient = new client_athena_1.AthenaClient({});
const LOG_TABLE_NAME = process.env.LOG_TABLE_NAME || '';
const LOG_BUCKET_NAME = process.env.LOG_BUCKET_NAME || '';
const ATHENA_WORKGROUP = process.env.ATHENA_WORKGROUP || 'llm_logs_workgroup';
const ATHENA_DATABASE = 'ai_gateway_logs_db';
const PAGE_SIZE = 15;
const CORS_HEADERS = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key',
    'Access-Control-Allow-Methods': 'GET,OPTIONS',
};
const mapDynamoItem = (item) => ({
    id: item.id?.S || '',
    timestamp: item.timestamp?.S || '',
    latency: item.latency?.N || '',
    is_successful: item.is_successful?.BOOL ?? null,
    success_reason: item.success_reason?.S || null,
    error_reason: item.error_reason?.S || null,
    model_routing_history: item.model_routing_history?.S || '',
    user_id: item.user_id?.S || null,
    metadata: item.metadata?.S || null,
    thread_id: item.thread_id?.S || null,
    provider: item.provider?.S || null,
    model: item.model?.S || null,
    cost: item.cost?.N || null,
    raw_request: item.raw_request?.S || null,
    raw_response: item.raw_response?.S || null,
    error_message: item.error_message?.S || null,
});
const mapAthenaRow = (row) => {
    const d = row.Data || [];
    return {
        id: d[0]?.VarCharValue || '',
        timestamp: d[1]?.VarCharValue || '',
        latency: d[2]?.VarCharValue || '',
        is_successful: d[3]?.VarCharValue === 'true',
        success_reason: d[4]?.VarCharValue || null,
        error_reason: d[5]?.VarCharValue || null,
        model_routing_history: d[6]?.VarCharValue || '',
        user_id: d[7]?.VarCharValue || null,
        metadata: d[8]?.VarCharValue || null,
        thread_id: d[9]?.VarCharValue || null,
        provider: d[10]?.VarCharValue || null,
        model: d[11]?.VarCharValue || null,
        cost: d[12]?.VarCharValue || null,
        raw_request: d[13]?.VarCharValue || null,
        raw_response: d[14]?.VarCharValue || null,
        error_message: d[15]?.VarCharValue || null,
    };
};
const handler = async (event) => {
    console.log('Full raw event:', JSON.stringify(event, null, 2));
    const queryParams = event.queryStringParameters || {};
    console.log('Query params:', queryParams);
    try {
        const older = queryParams.older === 'true';
        const page = parseInt(queryParams.page || '1', 10);
        const nextToken = queryParams.nextToken || null;
        let queryExecutionId = queryParams.queryExecutionId || null;
        if (isNaN(page) || page < 1) {
            return {
                statusCode: 400,
                headers: CORS_HEADERS,
                body: JSON.stringify({ message: 'Invalid page number' }),
            };
        }
        let logs = [];
        let responseNextToken = null;
        if (older) {
            // When querying Athena:
            if (!queryExecutionId) {
                // IMPORTANT: List columns in the same order as mapAthenaRow expects:
                const athenaQuery = `
          SELECT
            id,
            timestamp,
            latency,
            is_successful,
            success_reason,
            error_reason,
            model_routing_history,
            user_id,
            metadata,
            thread_id,
            provider,
            model,
            cost,
            raw_request,
            raw_response,
            error_message
          FROM ai_gateway_logs
          ORDER BY date DESC, timestamp DESC
        `;
                const startQuery = new client_athena_1.StartQueryExecutionCommand({
                    QueryString: athenaQuery,
                    WorkGroup: ATHENA_WORKGROUP,
                    ResultConfiguration: {
                        OutputLocation: `s3://${LOG_BUCKET_NAME}/athena-results/`,
                    },
                    QueryExecutionContext: {
                        Database: ATHENA_DATABASE,
                    },
                });
                const queryExecution = await athenaClient.send(startQuery);
                queryExecutionId = queryExecution.QueryExecutionId;
                let queryState;
                // Wait for the query to finish
                do {
                    await new Promise((resolve) => setTimeout(resolve, 1000));
                    const queryExecutionResult = await athenaClient.send(new client_athena_1.GetQueryExecutionCommand({ QueryExecutionId: queryExecutionId }));
                    queryState = queryExecutionResult.QueryExecution?.Status?.State;
                } while (queryState === 'RUNNING' || queryState === 'QUEUED');
                if (queryState === 'FAILED') {
                    const errorDetails = await athenaClient.send(new client_athena_1.GetQueryExecutionCommand({ QueryExecutionId: queryExecutionId }));
                    throw new Error('Athena query failed: ' +
                        errorDetails.QueryExecution?.Status?.StateChangeReason);
                }
            }
            // Retrieve the results page-by-page
            const getQueryResultsInput = {
                QueryExecutionId: queryExecutionId,
                MaxResults: PAGE_SIZE + 1,
            };
            if (nextToken) {
                getQueryResultsInput.NextToken = nextToken;
            }
            const queryResults = await athenaClient.send(new client_athena_1.GetQueryResultsCommand(getQueryResultsInput));
            const rows = queryResults.ResultSet?.Rows || [];
            // Drop the header row if this is the first page of results
            logs = rows.length > 1 ? rows.slice(1).map(mapAthenaRow) : [];
            responseNextToken = queryResults.NextToken || null;
            return {
                statusCode: 200,
                headers: CORS_HEADERS,
                body: JSON.stringify({
                    logs,
                    page,
                    pageSize: PAGE_SIZE,
                    nextToken: responseNextToken,
                    queryExecutionId,
                }),
            };
        }
        // Otherwise, fetch logs from DynamoDB
        const clientLastKey = nextToken
            ? JSON.parse(decodeURIComponent(nextToken))
            : undefined;
        const dynamoQuery = new client_dynamodb_1.QueryCommand({
            TableName: LOG_TABLE_NAME,
            KeyConditionExpression: 'PK = :pk',
            ExpressionAttributeValues: {
                ':pk': { S: 'LOG' },
            },
            Limit: PAGE_SIZE,
            ExclusiveStartKey: clientLastKey,
            ScanIndexForward: false,
        });
        const dynamoResult = await dynamoClient.send(dynamoQuery);
        logs = dynamoResult.Items?.map(mapDynamoItem) || [];
        responseNextToken = dynamoResult.LastEvaluatedKey
            ? encodeURIComponent(JSON.stringify(dynamoResult.LastEvaluatedKey))
            : null;
        return {
            statusCode: 200,
            headers: CORS_HEADERS,
            body: JSON.stringify({
                logs,
                page,
                pageSize: PAGE_SIZE,
                nextToken: responseNextToken,
            }),
        };
    }
    catch (error) {
        console.error('Error in logs handler:', error);
        return {
            statusCode: 500,
            headers: CORS_HEADERS,
            body: JSON.stringify({
                message: 'Error fetching logs',
                error: String(error),
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xhbWJkYS9sb2dzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDhEQUF3RTtBQUN4RSwwREFLZ0M7QUFFaEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sWUFBWSxHQUFHLElBQUksNEJBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUUxQyxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUM7QUFDeEQsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksRUFBRSxDQUFDO0FBQzFELE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxvQkFBb0IsQ0FBQztBQUM5RSxNQUFNLGVBQWUsR0FBRyxvQkFBb0IsQ0FBQztBQUM3QyxNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUM7QUFFckIsTUFBTSxZQUFZLEdBQUc7SUFDbkIsNkJBQTZCLEVBQUUsR0FBRztJQUNsQyw4QkFBOEIsRUFDNUIsaURBQWlEO0lBQ25ELDhCQUE4QixFQUFFLGFBQWE7Q0FDOUMsQ0FBQztBQUVGLE1BQU0sYUFBYSxHQUFHLENBQUMsSUFBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxFQUFFO0lBQ3BCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxFQUFFO0lBQ2xDLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFO0lBQzlCLGFBQWEsRUFBRSxJQUFJLENBQUMsYUFBYSxFQUFFLElBQUksSUFBSSxJQUFJO0lBQy9DLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsSUFBSSxJQUFJO0lB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QUUsS0FBSztTQUN4QixDQUFDLENBQUM7UUFFSCxNQUFNLFlBQVksR0FBRyxNQUFNLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDMUQsSUFBSSxHQUFHLFlBQVksQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwRCxpQkFBaUIsR0FBRyxZQUFZLENBQUMsZ0JBQWdCO1lBQy9DLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ25FLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFFVCxPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPLEVBQUUsWUFBWTtZQUNyQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDbkIsSUFBSTtnQkFDSixJQUFJO2dCQUNKLFFBQVEsRUFBRSxTQUFTO2dCQUNuQixTQUFTLEVBQUUsaUJBQWlCO2FBQzdCLENBQUM7U0FDSCxDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9DLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSxZQUFZO1lBQ3JCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNuQixPQUFPLEVBQUUscUJBQXFCO2dCQUM5QixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQzthQUNyQixDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDLENBQUM7QUFoS1csUUFBQSxPQUFPLFdBZ0tsQiIsInNvdXJjZXNDb250ZW50IjpbIi8vID09PSBsYW1iZGEvbG9ncy50cyA9PT1cbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIFF1ZXJ5Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQge1xuICBBdGhlbmFDbGllbnQsXG4gIFN0YXJ0UXVlcnlFeGVjdXRpb25Db21tYW5kLFxuICBHZXRRdWVyeUV4ZWN1dGlvbkNvbW1hbmQsXG4gIEdldFF1ZXJ5UmVzdWx0c0NvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1hdGhlbmEnO1xuXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgYXRoZW5hQ2xpZW50ID0gbmV3IEF0aGVuYUNsaWVudCh7fSk7XG5cbmNvbnN0IExPR19UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuTE9HX1RBQkxFX05BTUUgfHwgJyc7XG5jb25zdCBMT0dfQlVDS0VUX05BTUUgPSBwcm9jZXNzLmVudi5MT0dfQlVDS0VUX05BTUUgfHwgJyc7XG5jb25zdCBBVEhFTkFfV09SS0dST1VQID0gcHJvY2Vzcy5lbnYuQVRIRU5BX1dPUktHUk9VUCB8fCAnbGxtX2xvZ3Nfd29ya2dyb3VwJztcbmNvbnN0IEFUSEVOQV9EQVRBQkFTRSA9ICdhaV9nYXRld2F5X2xvZ3NfZGInO1xuY29uc3QgUEFHRV9TSVpFID0gMTU7XG5cbmNvbnN0IENPUlNfSEVBREVSUyA9IHtcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOlxuICAgICdDb250ZW50LVR5cGUsWC1BbXotRGF0ZSxBdXRob3JpemF0aW9uLFgtQXBpLUtleScsXG4gICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxPUFRJT05TJyxcbn07XG5cbmNvbnN0IG1hcER5bmFtb0l0ZW0gPSAoaXRlbTogYW55KSA9PiAoe1xuICBpZDogaXRlbS5pZD8uUyB8fCAnJyxcbiAgdGltZXN0YW1wOiBpdGVtLnRpbWVzdGFtcD8uUyB8fCAnJyxcbiAgbGF0ZW5jeTogaXRlbS5sYXRlbmN5Py5OIHx8ICcnLFxuICBpc19zdWNjZXNzZnVsOiBpdGVtLmlzX3N1Y2Nlc3NmdWw/LkJPT0wgPz8gbnVsbCxcbiAgc3VjY2Vzc19yZWFzb246IGl0ZW0uc3VjY2Vzc19yZWFzb24/LlMgfHwgbnVsbCxcbiAgZXJyb3JfcmVhc29uOiBpdGVtLmVycm9yX3JlYXNvbj8uUyB8fCBudWxsLFxuICBtb2RlbF9yb3V0aW5nX2hpc3Rvcnk6IGl0ZW0ubW9kZWxfcm91dGluZ19oaXN0b3J5Py5TIHx8ICcnLFxuICB1c2VyX2lkOiBpdGVtLnVzZXJfaWQ/LlMgfHwgbnVsbCxcbiAgbWV0YWRhdGE6IGl0ZW0ubWV0YWRhdGE/LlMgfHwgbnVsbCxcbiAgdGhyZWFkX2lkOiBpdGVtLnRocmVhZF9pZD8uUyB8fCBudWxsLFxuICBwcm92aWRlcjogaXRlbS5wcm92aWRlcj8uUyB8fCBudWxsLFxuICBtb2RlbDogaXRlbS5tb2RlbD8uUyB8fCBudWxsLFxuICBjb3N0OiBpdGVtLmNvc3Q/Lk4gfHwgbnVsbCxcbiAgcmF3X3JlcXVlc3Q6IGl0ZW0ucmF3X3JlcXVlc3Q/LlMgfHwgbnVsbCxcbiAgcmF3X3Jlc3BvbnNlOiBpdGVtLnJhd19yZXNwb25zZT8uUyB8fCBudWxsLFxuICBlcnJvcl9tZXNzYWdlOiBpdGVtLmVycm9yX21lc3NhZ2U/LlMgfHwgbnVsbCxcbn0pO1xuXG5jb25zdCBtYXBBdGhlbmFSb3cgPSAocm93OiBhbnkpID0+IHtcbiAgY29uc3QgZCA9IHJvdy5EYXRhIHx8IFtdO1xuICByZXR1cm4ge1xuICAgIGlkOiBkWzBdPy5WYXJDaGFyVmFsdWUgfHwgJycsXG4gICAgdGltZXN0YW1wOiBkWzFdPy5WYXJDaGFyVmFsdWUgfHwgJycsXG4gICAgbGF0ZW5jeTogZFsyXT8uVmFyQ2hhclZhbHVlIHx8ICcnLFxuICAgIGlzX3N1Y2Nlc3NmdWw6IGRbM10/LlZhckNoYXJWYWx1ZSA9PT0gJ3RydWUnLFxuICAgIHN1Y2Nlc3NfcmVhc29uOiBkWzRdPy5WYXJDaGFyVmFsdWUgfHwgbnVsbCxcbiAgICBlcnJvcl9yZWFzb246IGRbNV0/LlZhckNoYXJWYWx1ZSB8fCBudWxsLFxuICAgIG1vZGVsX3JvdXRpbmdfaGlzdG9yeTogZFs2XT8uVmFyQ2hhclZhbHVlIHx8ICcnLFxuICAgIHVzZXJfaWQ6IGRbN10/LlZhckNoYXJWYWx1ZSB8fCBudWxsLFxuICAgIG1ldGFkYXRhOiBkWzhdPy5WYXJDaGFyVmFsdWUgfHwgbnVsbCxcbiAgICB0aHJlYWRfaWQ6IGRbOV0/LlZhckNoYXJWYWx1ZSB8fCBudWxsLFxuICAgIHByb3ZpZGVyOiBkWzEwXT8uVmFyQ2hhclZhbHVlIHx8IG51bGwsXG4gICAgbW9kZWw6IGRbMTFdPy5WYXJDaGFyVmFsdWUgfHwgbnVsbCxcbiAgICBjb3N0OiBkWzEyXT8uVmFyQ2hhclZhbHVlIHx8IG51bGwsXG4gICAgcmF3X3JlcXVlc3Q6IGRbMTNdPy5WYXJDaGFyVmFsdWUgfHwgbnVsbCxcbiAgICByYXdfcmVzcG9uc2U6IGRbMTRdPy5WYXJDaGFyVmFsdWUgfHwgbnVsbCxcbiAgICBlcnJvcl9tZXNzYWdlOiBkWzE1XT8uVmFyQ2hhclZhbHVlIHx8IG51bGwsXG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjJcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIGNvbnNvbGUubG9nKCdGdWxsIHJhdyBldmVudDonLCBKU09OLnN0cmluZ2lmeShldmVudCwgbnVsbCwgMikpO1xuICBjb25zdCBxdWVyeVBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcbiAgY29uc29sZS5sb2coJ1F1ZXJ5IHBhcmFtczonLCBxdWVyeVBhcmFtcyk7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBvbGRlciA9IHF1ZXJ5UGFyYW1zLm9sZGVyID09PSAndHJ1ZSc7XG4gICAgY29uc3QgcGFnZSA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLnBhZ2UgfHwgJzEnLCAxMCk7XG4gICAgY29uc3QgbmV4dFRva2VuID0gcXVlcnlQYXJhbXMubmV4dFRva2VuIHx8IG51bGw7XG4gICAgbGV0IHF1ZXJ5RXhlY3V0aW9uSWQgPSBxdWVyeVBhcmFtcy5xdWVyeUV4ZWN1dGlvbklkIHx8IG51bGw7XG5cbiAgICBpZiAoaXNOYU4ocGFnZSkgfHwgcGFnZSA8IDEpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgaGVhZGVyczogQ09SU19IRUFERVJTLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICdJbnZhbGlkIHBhZ2UgbnVtYmVyJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgbGV0IGxvZ3M6IGFueVtdID0gW107XG4gICAgbGV0IHJlc3BvbnNlTmV4dFRva2VuOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuICAgIGlmIChvbGRlcikge1xuICAgICAgLy8gV2hlbiBxdWVyeWluZyBBdGhlbmE6XG4gICAgICBpZiAoIXF1ZXJ5RXhlY3V0aW9uSWQpIHtcbiAgICAgICAgLy8gSU1QT1JUQU5UOiBMaXN0IGNvbHVtbnMgaW4gdGhlIHNhbWUgb3JkZXIgYXMgbWFwQXRoZW5hUm93IGV4cGVjdHM6XG4gICAgICAgIGNvbnN0IGF0aGVuYVF1ZXJ5ID0gYFxuICAgICAgICAgIFNFTEVDVFxuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICB0aW1lc3RhbXAsXG4gICAgICAgICAgICBsYXRlbmN5LFxuICAgICAgICAgICAgaXNfc3VjY2Vzc2Z1bCxcbiAgICAgICAgICAgIHN1Y2Nlc3NfcmVhc29uLFxuICAgICAgICAgICAgZXJyb3JfcmVhc29uLFxuICAgICAgICAgICAgbW9kZWxfcm91dGluZ19oaXN0b3J5LFxuICAgICAgICAgICAgdXNlcl9pZCxcbiAgICAgICAgICAgIG1ldGFkYXRhLFxuICAgICAgICAgICAgdGhyZWFkX2lkLFxuICAgICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgICBtb2RlbCxcbiAgICAgICAgICAgIGNvc3QsXG4gICAgICAgICAgICByYXdfcmVxdWVzdCxcbiAgICAgICAgICAgIHJhd19yZXNwb25zZSxcbiAgICAgICAgICAgIGVycm9yX21lc3NhZ2VcbiAgICAgICAgICBGUk9NIGFpX2dhdGV3YXlfbG9nc1xuICAgICAgICAgIE9SREVSIEJZIGRhdGUgREVTQywgdGltZXN0YW1wIERFU0NcbiAgICAgICAgYDtcblxuICAgICAgICBjb25zdCBzdGFydFF1ZXJ5ID0gbmV3IFN0YXJ0UXVlcnlFeGVjdXRpb25Db21tYW5kKHtcbiAgICAgICAgICBRdWVyeVN0cmluZzogYXRoZW5hUXVlcnksXG4gICAgICAgICAgV29ya0dyb3VwOiBBVEhFTkFfV09SS0dST1VQLFxuICAgICAgICAgIFJlc3VsdENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICAgIE91dHB1dExvY2F0aW9uOiBgczM6Ly8ke0xPR19CVUNLRVRfTkFNRX0vYXRoZW5hLXJlc3VsdHMvYCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIFF1ZXJ5RXhlY3V0aW9uQ29udGV4dDoge1xuICAgICAgICAgICAgRGF0YWJhc2U6IEFUSEVOQV9EQVRBQkFTRSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBxdWVyeUV4ZWN1dGlvbiA9IGF3YWl0IGF0aGVuYUNsaWVudC5zZW5kKHN0YXJ0UXVlcnkpO1xuICAgICAgICBxdWVyeUV4ZWN1dGlvbklkID0gcXVlcnlFeGVjdXRpb24uUXVlcnlFeGVjdXRpb25JZCE7XG4gICAgICAgIGxldCBxdWVyeVN0YXRlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgLy8gV2FpdCBmb3IgdGhlIHF1ZXJ5IHRvIGZpbmlzaFxuICAgICAgICBkbyB7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMCkpO1xuICAgICAgICAgIGNvbnN0IHF1ZXJ5RXhlY3V0aW9uUmVzdWx0ID0gYXdhaXQgYXRoZW5hQ2xpZW50LnNlbmQoXG4gICAgICAgICAgICBuZXcgR2V0UXVlcnlFeGVjdXRpb25Db21tYW5kKHsgUXVlcnlFeGVjdXRpb25JZDogcXVlcnlFeGVjdXRpb25JZCB9KVxuICAgICAgICAgICk7XG4gICAgICAgICAgcXVlcnlTdGF0ZSA9IHF1ZXJ5RXhlY3V0aW9uUmVzdWx0LlF1ZXJ5RXhlY3V0aW9uPy5TdGF0dXM/LlN0YXRlO1xuICAgICAgICB9IHdoaWxlIChxdWVyeVN0YXRlID09PSAnUlVOTklORycgfHwgcXVlcnlTdGF0ZSA9PT0gJ1FVRVVFRCcpO1xuXG4gICAgICAgIGlmIChxdWVyeVN0YXRlID09PSAnRkFJTEVEJykge1xuICAgICAgICAgIGNvbnN0IGVycm9yRGV0YWlscyA9IGF3YWl0IGF0aGVuYUNsaWVudC5zZW5kKFxuICAgICAgICAgICAgbmV3IEdldFF1ZXJ5RXhlY3V0aW9uQ29tbWFuZCh7IFF1ZXJ5RXhlY3V0aW9uSWQ6IHF1ZXJ5RXhlY3V0aW9uSWQgfSlcbiAgICAgICAgICApO1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICdBdGhlbmEgcXVlcnkgZmFpbGVkOiAnICtcbiAgICAgICAgICAgICAgZXJyb3JEZXRhaWxzLlF1ZXJ5RXhlY3V0aW9uPy5TdGF0dXM/LlN0YXRlQ2hhbmdlUmVhc29uXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBSZXRyaWV2ZSB0aGUgcmVzdWx0cyBwYWdlLWJ5LXBhZ2VcbiAgICAgIGNvbnN0IGdldFF1ZXJ5UmVzdWx0c0lucHV0OiBhbnkgPSB7XG4gICAgICAgIFF1ZXJ5RXhlY3V0aW9uSWQ6IHF1ZXJ5RXhlY3V0aW9uSWQsXG4gICAgICAgIE1heFJlc3VsdHM6IFBBR0VfU0laRSArIDEsXG4gICAgICB9O1xuXG4gICAgICBpZiAobmV4dFRva2VuKSB7XG4gICAgICAgIGdldFF1ZXJ5UmVzdWx0c0lucHV0Lk5leHRUb2tlbiA9IG5leHRUb2tlbjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcXVlcnlSZXN1bHRzID0gYXdhaXQgYXRoZW5hQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXRRdWVyeVJlc3VsdHNDb21tYW5kKGdldFF1ZXJ5UmVzdWx0c0lucHV0KVxuICAgICAgKTtcbiAgICAgIGNvbnN0IHJvd3MgPSBxdWVyeVJlc3VsdHMuUmVzdWx0U2V0Py5Sb3dzIHx8IFtdO1xuXG4gICAgICAvLyBEcm9wIHRoZSBoZWFkZXIgcm93IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHBhZ2Ugb2YgcmVzdWx0c1xuICAgICAgbG9ncyA9IHJvd3MubGVuZ3RoID4gMSA/IHJvd3Muc2xpY2UoMSkubWFwKG1hcEF0aGVuYVJvdykgOiBbXTtcbiAgICAgIHJlc3BvbnNlTmV4dFRva2VuID0gcXVlcnlSZXN1bHRzLk5leHRUb2tlbiB8fCBudWxsO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgIGhlYWRlcnM6IENPUlNfSEVBREVSUyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGxvZ3MsXG4gICAgICAgICAgcGFnZSxcbiAgICAgICAgICBwYWdlU2l6ZTogUEFHRV9TSVpFLFxuICAgICAgICAgIG5leHRUb2tlbjogcmVzcG9uc2VOZXh0VG9rZW4sXG4gICAgICAgICAgcXVlcnlFeGVjdXRpb25JZCxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSwgZmV0Y2ggbG9ncyBmcm9tIER5bmFtb0RCXG4gICAgY29uc3QgY2xpZW50TGFzdEtleSA9IG5leHRUb2tlblxuICAgICAgPyBKU09OLnBhcnNlKGRlY29kZVVSSUNvbXBvbmVudChuZXh0VG9rZW4pKVxuICAgICAgOiB1bmRlZmluZWQ7XG5cbiAgICBjb25zdCBkeW5hbW9RdWVyeSA9IG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBMT0dfVEFCTEVfTkFNRSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdQSyA9IDpwaycsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6cGsnOiB7IFM6ICdMT0cnIH0sXG4gICAgICB9LFxuICAgICAgTGltaXQ6IFBBR0VfU0laRSxcbiAgICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5OiBjbGllbnRMYXN0S2V5LFxuICAgICAgU2NhbkluZGV4Rm9yd2FyZDogZmFsc2UsXG4gICAgfSk7XG5cbiAgICBjb25zdCBkeW5hbW9SZXN1bHQgPSBhd2FpdCBkeW5hbW9DbGllbnQuc2VuZChkeW5hbW9RdWVyeSk7XG4gICAgbG9ncyA9IGR5bmFtb1Jlc3VsdC5JdGVtcz8ubWFwKG1hcER5bmFtb0l0ZW0pIHx8IFtdO1xuICAgIHJlc3BvbnNlTmV4dFRva2VuID0gZHluYW1vUmVzdWx0Lkxhc3RFdmFsdWF0ZWRLZXlcbiAgICAgID8gZW5jb2RlVVJJQ29tcG9uZW50KEpTT04uc3RyaW5naWZ5KGR5bmFtb1Jlc3VsdC5MYXN0RXZhbHVhdGVkS2V5KSlcbiAgICAgIDogbnVsbDtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiBDT1JTX0hFQURFUlMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGxvZ3MsXG4gICAgICAgIHBhZ2UsXG4gICAgICAgIHBhZ2VTaXplOiBQQUdFX1NJWkUsXG4gICAgICAgIG5leHRUb2tlbjogcmVzcG9uc2VOZXh0VG9rZW4sXG4gICAgICB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIGxvZ3MgaGFuZGxlcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IENPUlNfSEVBREVSUyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgbWVzc2FnZTogJ0Vycm9yIGZldGNoaW5nIGxvZ3MnLFxuICAgICAgICBlcnJvcjogU3RyaW5nKGVycm9yKSxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cbn07XG4iXX0=
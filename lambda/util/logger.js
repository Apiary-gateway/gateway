"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.logFailedRequest = exports.logSuccessfulRequest = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const uuid_1 = require("uuid");
const parquets = require("parquets");
const os = require("os");
const path = require("path");
const promises_1 = require("fs/promises");
const s3 = new client_s3_1.S3Client({});
const ddb = new client_dynamodb_1.DynamoDBClient({});
const LOG_BUCKET = process.env.LOG_BUCKET_NAME;
const LOG_TABLE_NAME = process.env.LOG_TABLE_NAME;
if (!LOG_BUCKET || !LOG_TABLE_NAME) {
    throw new Error('LOG_BUCKET_NAME and LOG_TABLE_NAME must be set');
}
process.on('warning', (warning) => {
    if (warning.name !== 'DeprecationWarning') {
        console.warn(warning);
    }
});
const saveLog = async (log, status) => {
    try {
        const now = new Date();
        const timestamp = now.toISOString();
        const thread_ts = timestamp;
        const latency = BigInt(Date.now() - log.requestStartTime);
        const date = timestamp.split('T')[0];
        const provider = log.provider ?? 'unknown';
        const model = log.model ?? 'unknown';
        const id = (0, uuid_1.v4)();
        const structuredLog = {
            id,
            thread_ts,
            timestamp,
            latency,
            provider,
            model,
            tokens_used: BigInt(log.tokens_used),
            cost: log.cost,
            raw_request: log.RawRequest,
            raw_response: log.RawResponse,
            error_message: log.errorMessage,
            status,
        };
        // Write to Parquet
        const schema = new parquets.ParquetSchema({
            id: { type: 'UTF8' },
            thread_ts: { type: 'UTF8' },
            timestamp: { type: 'UTF8' },
            latency: { type: 'INT64' },
            provider: { type: 'UTF8' },
            model: { type: 'UTF8' },
            tokens_used: { type: 'INT64' },
            cost: { type: 'DOUBLE' },
            raw_request: { type: 'UTF8' },
            raw_response: { type: 'UTF8', optional: true },
            error_message: { type: 'UTF8', optional: true },
            status: { type: 'UTF8' },
        });
        const tmpFilePath = path.join(os.tmpdir(), `${id}.parquet`);
        const writer = await parquets.ParquetWriter.openFile(schema, tmpFilePath);
        await writer.appendRow(structuredLog);
        await writer.close();
        const buffer = await (0, promises_1.readFile)(tmpFilePath);
        await (0, promises_1.unlink)(tmpFilePath);
        const key = `logs/parquet/status=${status}/date=${date}/provider=${provider}/model=${model}/${id}.parquet`;
        await s3.send(new client_s3_1.PutObjectCommand({
            Bucket: LOG_BUCKET,
            Key: key,
            Body: buffer,
            ContentType: 'application/octet-stream',
        }));
        // Write to DynamoDB with single-table design
        await ddb.send(new client_dynamodb_1.PutItemCommand({
            TableName: LOG_TABLE_NAME,
            Item: {
                PK: { S: `LOG#${id}` },
                SK: { S: `TS#${thread_ts}` },
                id: { S: id },
                thread_ts: { S: thread_ts },
                timestamp: { S: timestamp },
                latency: { N: latency.toString() },
                provider: { S: provider },
                model: { S: model },
                tokens_used: { N: log.tokens_used.toString() },
                cost: { N: log.cost.toString() },
                raw_request: { S: log.RawRequest },
                raw_response: log.RawResponse
                    ? { S: log.RawResponse }
                    : { NULL: true },
                error_message: log.errorMessage
                    ? { S: log.errorMessage }
                    : { NULL: true },
                status: { S: status },
            },
        }));
    }
    catch (err) {
        console.error('[LogError] Failed to write log to S3 or DynamoDB:', err);
        throw err; // Optional: rethrow to allow caller to handle
    }
};
const logSuccessfulRequest = async (logData) => {
    console.log('[Success]', logData);
    await saveLog(logData, 'success');
};
exports.logSuccessfulRequest = logSuccessfulRequest;
const logFailedRequest = async (logData) => {
    console.error('[Failure]', logData);
    await saveLog(logData, 'failure');
};
exports.logFailedRequest = logFailedRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibG9nZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGtEQUFnRTtBQUNoRSw4REFBMEU7QUFDMUUsK0JBQW9DO0FBQ3BDLHFDQUFxQztBQUNyQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLDBDQUErQztBQW1DL0MsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVCLE1BQU0sR0FBRyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVuQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztBQUMvQyxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztBQUVsRCxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO0FBQ3BFLENBQUM7QUFFRCxPQUFPLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFO0lBQ2hDLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxvQkFBb0IsRUFBRSxDQUFDO1FBQzFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDeEIsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEdBQWtCLEVBQUUsTUFBNkIsRUFBRSxFQUFFO0lBQzFFLElBQUksQ0FBQztRQUNILE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3BDLE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUM1QixNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFD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QUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsbURBQW1ELEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDeEUsTUFBTSxHQUFHLENBQUMsQ0FBQyw4Q0FBOEM7SUFDM0QsQ0FBQztBQUNILENBQUMsQ0FBQztBQUVLLE1BQU0sb0JBQW9CLEdBQUcsS0FBSyxFQUN2QyxPQUFnRCxFQUNoRCxFQUFFO0lBQ0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbEMsTUFBTSxPQUFPLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQ3BDLENBQUMsQ0FBQztBQUxXLFFBQUEsb0JBQW9CLHdCQUsvQjtBQUVLLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxFQUNuQyxPQUFpRCxFQUNqRCxFQUFFO0lBQ0YsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDcEMsTUFBTSxPQUFPLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQ3BDLENBQUMsQ0FBQztBQUxXLFFBQUEsZ0JBQWdCLG9CQUszQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFMzQ2xpZW50LCBQdXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBQdXRJdGVtQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCAqIGFzIHBhcnF1ZXRzIGZyb20gJ3BhcnF1ZXRzJztcbmltcG9ydCAqIGFzIG9zIGZyb20gJ29zJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyByZWFkRmlsZSwgdW5saW5rIH0gZnJvbSAnZnMvcHJvbWlzZXMnO1xuXG5leHBvcnQgdHlwZSBWQUxJRF9QUk9WSURFUlMgPSAnb3BlbmFpJyB8ICdhbnRocm9waWMnIHwgJ2dlbWluaSc7XG5leHBvcnQgdHlwZSBWQUxJRF9NT0RFTFMgPVxuICB8ICdncHQtMy41LXR1cmJvJ1xuICB8ICdncHQtNCdcbiAgfCAnY2xhdWRlLTMtb3B1cy0yMDI0MDIyOSdcbiAgfCAnZ2VtaW5pLTEuNS1wcm8nO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbW1vbkxvZ0RhdGEge1xuICByZXF1ZXN0U3RhcnRUaW1lOiBudW1iZXI7XG4gIHByb3ZpZGVyOiBWQUxJRF9QUk9WSURFUlMgfCBudWxsO1xuICBtb2RlbDogVkFMSURfTU9ERUxTIHwgbnVsbDtcbiAgdG9rZW5zX3VzZWQ6IG51bWJlcjtcbiAgY29zdDogbnVtYmVyO1xuICBSYXdSZXF1ZXN0OiBzdHJpbmc7XG4gIFJhd1Jlc3BvbnNlPzogc3RyaW5nO1xuICBlcnJvck1lc3NhZ2U/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJbnRlcm5hbExvZ0RhdGEge1xuICBpZDogc3RyaW5nO1xuICB0aHJlYWRfdHM6IHN0cmluZztcbiAgdGltZXN0YW1wOiBzdHJpbmc7XG4gIGxhdGVuY3k6IGJpZ2ludDtcbiAgcHJvdmlkZXI6IHN0cmluZztcbiAgbW9kZWw6IHN0cmluZztcbiAgdG9rZW5zX3VzZWQ6IGJpZ2ludDtcbiAgY29zdDogbnVtYmVyO1xuICByYXdfcmVxdWVzdDogc3RyaW5nO1xuICByYXdfcmVzcG9uc2U/OiBzdHJpbmc7XG4gIGVycm9yX21lc3NhZ2U/OiBzdHJpbmc7XG4gIHN0YXR1czogc3RyaW5nO1xufVxuXG5jb25zdCBzMyA9IG5ldyBTM0NsaWVudCh7fSk7XG5jb25zdCBkZGIgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuXG5jb25zdCBMT0dfQlVDS0VUID0gcHJvY2Vzcy5lbnYuTE9HX0JVQ0tFVF9OQU1FO1xuY29uc3QgTE9HX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5MT0dfVEFCTEVfTkFNRTtcblxuaWYgKCFMT0dfQlVDS0VUIHx8ICFMT0dfVEFCTEVfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0xPR19CVUNLRVRfTkFNRSBhbmQgTE9HX1RBQkxFX05BTUUgbXVzdCBiZSBzZXQnKTtcbn1cblxucHJvY2Vzcy5vbignd2FybmluZycsICh3YXJuaW5nKSA9PiB7XG4gIGlmICh3YXJuaW5nLm5hbWUgIT09ICdEZXByZWNhdGlvbldhcm5pbmcnKSB7XG4gICAgY29uc29sZS53YXJuKHdhcm5pbmcpO1xuICB9XG59KTtcblxuY29uc3Qgc2F2ZUxvZyA9IGFzeW5jIChsb2c6IENvbW1vbkxvZ0RhdGEsIHN0YXR1czogJ3N1Y2Nlc3MnIHwgJ2ZhaWx1cmUnKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBub3cudG9JU09TdHJpbmcoKTtcbiAgICBjb25zdCB0aHJlYWRfdHMgPSB0aW1lc3RhbXA7XG4gICAgY29uc3QgbGF0ZW5jeSA9IEJpZ0ludChEYXRlLm5vdygpIC0gbG9nLnJlcXVlc3RTdGFydFRpbWUpO1xuICAgIGNvbnN0IGRhdGUgPSB0aW1lc3RhbXAuc3BsaXQoJ1QnKVswXTtcbiAgICBjb25zdCBwcm92aWRlciA9IGxvZy5wcm92aWRlciA/PyAndW5rbm93bic7XG4gICAgY29uc3QgbW9kZWwgPSBsb2cubW9kZWwgPz8gJ3Vua25vd24nO1xuICAgIGNvbnN0IGlkID0gdXVpZHY0KCk7XG5cbiAgICBjb25zdCBzdHJ1Y3R1cmVkTG9nOiBJbnRlcm5hbExvZ0RhdGEgPSB7XG4gICAgICBpZCxcbiAgICAgIHRocmVhZF90cyxcbiAgICAgIHRpbWVzdGFtcCxcbiAgICAgIGxhdGVuY3ksXG4gICAgICBwcm92aWRlcixcbiAgICAgIG1vZGVsLFxuICAgICAgdG9rZW5zX3VzZWQ6IEJpZ0ludChsb2cudG9rZW5zX3VzZWQpLFxuICAgICAgY29zdDogbG9nLmNvc3QsXG4gICAgICByYXdfcmVxdWVzdDogbG9nLlJhd1JlcXVlc3QsXG4gICAgICByYXdfcmVzcG9uc2U6IGxvZy5SYXdSZXNwb25zZSxcbiAgICAgIGVycm9yX21lc3NhZ2U6IGxvZy5lcnJvck1lc3NhZ2UsXG4gICAgICBzdGF0dXMsXG4gICAgfTtcblxuICAgIC8vIFdyaXRlIHRvIFBhcnF1ZXRcbiAgICBjb25zdCBzY2hlbWEgPSBuZXcgcGFycXVldHMuUGFycXVldFNjaGVtYSh7XG4gICAgICBpZDogeyB0eXBlOiAnVVRGOCcgfSxcbiAgICAgIHRocmVhZF90czogeyB0eXBlOiAnVVRGOCcgfSxcbiAgICAgIHRpbWVzdGFtcDogeyB0eXBlOiAnVVRGOCcgfSxcbiAgICAgIGxhdGVuY3k6IHsgdHlwZTogJ0lOVDY0JyB9LFxuICAgICAgcHJvdmlkZXI6IHsgdHlwZTogJ1VURjgnIH0sXG4gICAgICBtb2RlbDogeyB0eXBlOiAnVVRGOCcgfSxcbiAgICAgIHRva2Vuc191c2VkOiB7IHR5cGU6ICdJTlQ2NCcgfSxcbiAgICAgIGNvc3Q6IHsgdHlwZTogJ0RPVUJMRScgfSxcbiAgICAgIHJhd19yZXF1ZXN0OiB7IHR5cGU6ICdVVEY4JyB9LFxuICAgICAgcmF3X3Jlc3BvbnNlOiB7IHR5cGU6ICdVVEY4Jywgb3B0aW9uYWw6IHRydWUgfSxcbiAgICAgIGVycm9yX21lc3NhZ2U6IHsgdHlwZTogJ1VURjgnLCBvcHRpb25hbDogdHJ1ZSB9LFxuICAgICAgc3RhdHVzOiB7IHR5cGU6ICdVVEY4JyB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgdG1wRmlsZVBhdGggPSBwYXRoLmpvaW4ob3MudG1wZGlyKCksIGAke2lkfS5wYXJxdWV0YCk7XG4gICAgY29uc3Qgd3JpdGVyID0gYXdhaXQgcGFycXVldHMuUGFycXVldFdyaXRlci5vcGVuRmlsZShzY2hlbWEsIHRtcEZpbGVQYXRoKTtcbiAgICBhd2FpdCB3cml0ZXIuYXBwZW5kUm93KHN0cnVjdHVyZWRMb2cpO1xuICAgIGF3YWl0IHdyaXRlci5jbG9zZSgpO1xuXG4gICAgY29uc3QgYnVmZmVyID0gYXdhaXQgcmVhZEZpbGUodG1wRmlsZVBhdGgpO1xuICAgIGF3YWl0IHVubGluayh0bXBGaWxlUGF0aCk7XG5cbiAgICBjb25zdCBrZXkgPSBgbG9ncy9wYXJxdWV0L3N0YXR1cz0ke3N0YXR1c30vZGF0ZT0ke2RhdGV9L3Byb3ZpZGVyPSR7cHJvdmlkZXJ9L21vZGVsPSR7bW9kZWx9LyR7aWR9LnBhcnF1ZXRgO1xuXG4gICAgYXdhaXQgczMuc2VuZChcbiAgICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgQnVja2V0OiBMT0dfQlVDS0VULFxuICAgICAgICBLZXk6IGtleSxcbiAgICAgICAgQm9keTogYnVmZmVyLFxuICAgICAgICBDb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScsXG4gICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBXcml0ZSB0byBEeW5hbW9EQiB3aXRoIHNpbmdsZS10YWJsZSBkZXNpZ25cbiAgICBhd2FpdCBkZGIuc2VuZChcbiAgICAgIG5ldyBQdXRJdGVtQ29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogTE9HX1RBQkxFX05BTUUsXG4gICAgICAgIEl0ZW06IHtcbiAgICAgICAgICBQSzogeyBTOiBgTE9HIyR7aWR9YCB9LFxuICAgICAgICAgIFNLOiB7IFM6IGBUUyMke3RocmVhZF90c31gIH0sXG4gICAgICAgICAgaWQ6IHsgUzogaWQgfSxcbiAgICAgICAgICB0aHJlYWRfdHM6IHsgUzogdGhyZWFkX3RzIH0sXG4gICAgICAgICAgdGltZXN0YW1wOiB7IFM6IHRpbWVzdGFtcCB9LFxuICAgICAgICAgIGxhdGVuY3k6IHsgTjogbGF0ZW5jeS50b1N0cmluZygpIH0sXG4gICAgICAgICAgcHJvdmlkZXI6IHsgUzogcHJvdmlkZXIgfSxcbiAgICAgICAgICBtb2RlbDogeyBTOiBtb2RlbCB9LFxuICAgICAgICAgIHRva2Vuc191c2VkOiB7IE46IGxvZy50b2tlbnNfdXNlZC50b1N0cmluZygpIH0sXG4gICAgICAgICAgY29zdDogeyBOOiBsb2cuY29zdC50b1N0cmluZygpIH0sXG4gICAgICAgICAgcmF3X3JlcXVlc3Q6IHsgUzogbG9nLlJhd1JlcXVlc3QgfSxcbiAgICAgICAgICByYXdfcmVzcG9uc2U6IGxvZy5SYXdSZXNwb25zZVxuICAgICAgICAgICAgPyB7IFM6IGxvZy5SYXdSZXNwb25zZSB9XG4gICAgICAgICAgICA6IHsgTlVMTDogdHJ1ZSB9LFxuICAgICAgICAgIGVycm9yX21lc3NhZ2U6IGxvZy5lcnJvck1lc3NhZ2VcbiAgICAgICAgICAgID8geyBTOiBsb2cuZXJyb3JNZXNzYWdlIH1cbiAgICAgICAgICAgIDogeyBOVUxMOiB0cnVlIH0sXG4gICAgICAgICAgc3RhdHVzOiB7IFM6IHN0YXR1cyB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb25zb2xlLmVycm9yKCdbTG9nRXJyb3JdIEZhaWxlZCB0byB3cml0ZSBsb2cgdG8gUzMgb3IgRHluYW1vREI6JywgZXJyKTtcbiAgICB0aHJvdyBlcnI7IC8vIE9wdGlvbmFsOiByZXRocm93IHRvIGFsbG93IGNhbGxlciB0byBoYW5kbGVcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGxvZ1N1Y2Nlc3NmdWxSZXF1ZXN0ID0gYXN5bmMgKFxuICBsb2dEYXRhOiBDb21tb25Mb2dEYXRhICYgeyBSYXdSZXNwb25zZTogc3RyaW5nIH1cbikgPT4ge1xuICBjb25zb2xlLmxvZygnW1N1Y2Nlc3NdJywgbG9nRGF0YSk7XG4gIGF3YWl0IHNhdmVMb2cobG9nRGF0YSwgJ3N1Y2Nlc3MnKTtcbn07XG5cbmV4cG9ydCBjb25zdCBsb2dGYWlsZWRSZXF1ZXN0ID0gYXN5bmMgKFxuICBsb2dEYXRhOiBDb21tb25Mb2dEYXRhICYgeyBlcnJvck1lc3NhZ2U6IHN0cmluZyB9XG4pID0+IHtcbiAgY29uc29sZS5lcnJvcignW0ZhaWx1cmVdJywgbG9nRGF0YSk7XG4gIGF3YWl0IHNhdmVMb2cobG9nRGF0YSwgJ2ZhaWx1cmUnKTtcbn07XG4iXX0=
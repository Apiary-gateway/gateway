"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Logger = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const uuid_1 = require("uuid");
const parquets = require("parquets");
const os = require("os");
const path = require("path");
const promises_1 = require("fs/promises");
const LOG_BUCKET = process.env.LOG_BUCKET_NAME;
const LOG_TABLE_NAME = process.env.LOG_TABLE_NAME;
if (!LOG_BUCKET || !LOG_TABLE_NAME) {
    throw new Error('LOG_BUCKET_NAME and LOG_TABLE_NAME must be set');
}
class Logger {
    constructor() {
        this.requestStartTime = new Date();
        this.is_successful = false;
        this.user_id = null;
        this.metadata = null;
        this.success_reason = null;
        this.error_reason = null;
        this.model_routing_history = [];
        this.thread_id = null;
        this.provider = null;
        this.model = null;
        this.cost = null;
        this.raw_request = null;
        this.raw_response = null;
        this.error_message = null;
    }
    async log() {
        const structuredLog = {
            id: (0, uuid_1.v4)(),
            timestamp: this.requestStartTime.getTime(),
            latency: BigInt(Date.now() - this.requestStartTime.getTime()),
            is_successful: this.is_successful,
            success_reason: this.success_reason,
            error_reason: this.error_reason,
            model_routing_history: JSON.stringify(this.model_routing_history),
            user_id: this.user_id,
            metadata: this.metadata,
            thread_id: this.thread_id,
            provider: this.provider,
            model: this.model,
            cost: this.cost,
            raw_request: this.raw_request,
            raw_response: this.raw_response,
            error_message: this.error_message,
        };
        const schema = new parquets.ParquetSchema({
            id: { type: 'UTF8' },
            timestamp: { type: 'INT64', originalType: 'TIMESTAMP_MILLIS' },
            latency: { type: 'INT64' },
            is_successful: { type: 'BOOLEAN' },
            success_reason: { type: 'UTF8', optional: true },
            error_reason: { type: 'UTF8', optional: true },
            model_routing_history: { type: 'UTF8' },
            user_id: { type: 'UTF8', optional: true },
            metadata: { type: 'UTF8', optional: true },
            thread_id: { type: 'UTF8', optional: true },
            provider: { type: 'UTF8', optional: true },
            model: { type: 'UTF8', optional: true },
            cost: { type: 'DOUBLE', optional: true },
            raw_request: { type: 'UTF8', optional: true },
            raw_response: { type: 'UTF8', optional: true },
            error_message: { type: 'UTF8', optional: true },
        });
        const tmpFilePath = path.join(os.tmpdir(), `${structuredLog.id}.parquet`);
        const writer = await parquets.ParquetWriter.openFile(schema, tmpFilePath);
        await writer.appendRow(structuredLog);
        await writer.close();
        const buffer = await (0, promises_1.readFile)(tmpFilePath);
        await (0, promises_1.unlink)(tmpFilePath);
        const isoDate = new Date(structuredLog.timestamp).toISOString();
        const date = isoDate.split('T')[0];
        const key = `logs/parquet/is_successful=${structuredLog.is_successful}/date=${date}/provider=${structuredLog.provider ?? ''}/model=${structuredLog.model ?? ''}/${structuredLog.id}.parquet`;
        await Logger.s3.send(new client_s3_1.PutObjectCommand({
            Bucket: LOG_BUCKET,
            Key: key,
            Body: buffer,
            ContentType: 'application/octet-stream',
        }));
        await Logger.ddb.send(new client_dynamodb_1.PutItemCommand({
            TableName: LOG_TABLE_NAME,
            Item: {
                PK: { S: 'LOG' },
                SK: { S: `TS#${isoDate}` },
                id: { S: structuredLog.id },
                timestamp: { S: isoDate },
                latency: { N: structuredLog.latency.toString() },
                is_successful: { BOOL: structuredLog.is_successful },
                success_reason: structuredLog.success_reason
                    ? { S: structuredLog.success_reason }
                    : { NULL: true },
                error_reason: structuredLog.error_reason
                    ? { S: structuredLog.error_reason }
                    : { NULL: true },
                model_routing_history: { S: structuredLog.model_routing_history },
                user_id: structuredLog.user_id
                    ? { S: structuredLog.user_id }
                    : { NULL: true },
                metadata: structuredLog.metadata
                    ? { S: structuredLog.metadata }
                    : { NULL: true },
                thread_id: structuredLog.thread_id
                    ? { S: structuredLog.thread_id }
                    : { NULL: true },
                provider: structuredLog.provider
                    ? { S: structuredLog.provider }
                    : { NULL: true },
                model: structuredLog.model
                    ? { S: structuredLog.model }
                    : { NULL: true },
                cost: structuredLog.cost !== null
                    ? { N: structuredLog.cost.toString() }
                    : { NULL: true },
                raw_request: structuredLog.raw_request
                    ? { S: structuredLog.raw_request }
                    : { NULL: true },
                raw_response: structuredLog.raw_response
                    ? { S: structuredLog.raw_response }
                    : { NULL: true },
                error_message: structuredLog.error_message
                    ? { S: structuredLog.error_message }
                    : { NULL: true },
            },
        }));
    }
    setRawRequest(rawRequest) {
        this.raw_request = rawRequest;
    }
    setInitialData(threadId, userId, metadata) {
        this.thread_id = threadId;
        this.user_id = userId || null;
        this.metadata = metadata;
    }
    async logSuccessData(model, provider, modelRoutingHistory, successReason, rawResponse) {
        const modelRoutingHistoryJsonArray = modelRoutingHistory.events.map((e) => JSON.stringify(e, null, 2));
        this.model = model;
        this.provider = provider;
        this.model_routing_history = modelRoutingHistoryJsonArray;
        this.success_reason = successReason;
        this.raw_response = rawResponse;
        this.is_successful = true;
        await this.log();
    }
    async logErrorData(errorReason, errorMessage) {
        this.error_reason = errorReason;
        this.error_message = errorMessage;
        await this.log();
    }
}
exports.Logger = Logger;
Logger.s3 = new client_s3_1.S3Client({});
Logger.ddb = new client_dynamodb_1.DynamoDBClient({});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL3V0aWwvbG9nZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGtEQUFnRTtBQUNoRSw4REFBMEU7QUFDMUUsK0JBQW9DO0FBQ3BDLHFDQUFxQztBQUNyQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLDBDQUErQztBQUcvQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztBQUMvQyxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztBQUVsRCxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO0FBQ3BFLENBQUM7QUFxQkQsTUFBYSxNQUFNO0lBbUJqQjtRQUNFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ25DLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1FBQzNCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1FBQzNCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLFlBQVks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ZXNDb250ZW50IjpbImltcG9ydCB7IFMzQ2xpZW50LCBQdXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBQdXRJdGVtQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCAqIGFzIHBhcnF1ZXRzIGZyb20gJ3BhcnF1ZXRzJztcbmltcG9ydCAqIGFzIG9zIGZyb20gJ29zJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyByZWFkRmlsZSwgdW5saW5rIH0gZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHsgUm91dGluZ0xvZyB9IGZyb20gJy4vdHlwZXMnO1xuXG5jb25zdCBMT0dfQlVDS0VUID0gcHJvY2Vzcy5lbnYuTE9HX0JVQ0tFVF9OQU1FO1xuY29uc3QgTE9HX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5MT0dfVEFCTEVfTkFNRTtcblxuaWYgKCFMT0dfQlVDS0VUIHx8ICFMT0dfVEFCTEVfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0xPR19CVUNLRVRfTkFNRSBhbmQgTE9HX1RBQkxFX05BTUUgbXVzdCBiZSBzZXQnKTtcbn1cblxuaW50ZXJmYWNlIFN0cnVjdHVyZWRMb2dEYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgdGltZXN0YW1wOiBudW1iZXI7IC8vIGVwb2NoIG1pbGxpc1xuICBsYXRlbmN5OiBiaWdpbnQ7XG4gIGlzX3N1Y2Nlc3NmdWw6IGJvb2xlYW47XG4gIHN1Y2Nlc3NfcmVhc29uOiBzdHJpbmcgfCBudWxsO1xuICBlcnJvcl9yZWFzb246IHN0cmluZyB8IG51bGw7XG4gIG1vZGVsX3JvdXRpbmdfaGlzdG9yeTogc3RyaW5nO1xuICB1c2VyX2lkOiBzdHJpbmcgfCBudWxsO1xuICBtZXRhZGF0YTogc3RyaW5nIHwgbnVsbDtcbiAgdGhyZWFkX2lkOiBzdHJpbmcgfCBudWxsO1xuICBwcm92aWRlcjogc3RyaW5nIHwgbnVsbDtcbiAgbW9kZWw6IHN0cmluZyB8IG51bGw7XG4gIGNvc3Q6IG51bWJlciB8IG51bGw7XG4gIHJhd19yZXF1ZXN0OiBzdHJpbmcgfCBudWxsO1xuICByYXdfcmVzcG9uc2U6IHN0cmluZyB8IG51bGw7XG4gIGVycm9yX21lc3NhZ2U6IHN0cmluZyB8IG51bGw7XG59XG5cbmV4cG9ydCBjbGFzcyBMb2dnZXIge1xuICBwcml2YXRlIHN0YXRpYyBzMzogUzNDbGllbnQgPSBuZXcgUzNDbGllbnQoe30pO1xuICBwcml2YXRlIHN0YXRpYyBkZGI6IER5bmFtb0RCQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcblxuICBwcml2YXRlIHJlcXVlc3RTdGFydFRpbWU6IERhdGU7XG4gIHByaXZhdGUgaXNfc3VjY2Vzc2Z1bDogYm9vbGVhbjtcbiAgcHJpdmF0ZSB1c2VyX2lkOiBzdHJpbmcgfCBudWxsO1xuICBwcml2YXRlIG1ldGFkYXRhOiBzdHJpbmcgfCBudWxsO1xuICBwcml2YXRlIHN1Y2Nlc3NfcmVhc29uOiBzdHJpbmcgfCBudWxsO1xuICBwcml2YXRlIGVycm9yX3JlYXNvbjogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBtb2RlbF9yb3V0aW5nX2hpc3Rvcnk6IHN0cmluZ1tdO1xuICBwcml2YXRlIHRocmVhZF9pZDogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBwcm92aWRlcjogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBtb2RlbDogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBjb3N0OiBudW1iZXIgfCBudWxsO1xuICBwcml2YXRlIHJhd19yZXF1ZXN0OiBzdHJpbmcgfCBudWxsO1xuICBwcml2YXRlIHJhd19yZXNwb25zZTogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBlcnJvcl9tZXNzYWdlOiBzdHJpbmcgfCBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMucmVxdWVzdFN0YXJ0VGltZSA9IG5ldyBEYXRlKCk7XG4gICAgdGhpcy5pc19zdWNjZXNzZnVsID0gZmFsc2U7XG4gICAgdGhpcy51c2VyX2lkID0gbnVsbDtcbiAgICB0aGlzLm1ldGFkYXRhID0gbnVsbDtcbiAgICB0aGlzLnN1Y2Nlc3NfcmVhc29uID0gbnVsbDtcbiAgICB0aGlzLmVycm9yX3JlYXNvbiA9IG51bGw7XG4gICAgdGhpcy5tb2RlbF9yb3V0aW5nX2hpc3RvcnkgPSBbXTtcbiAgICB0aGlzLnRocmVhZF9pZCA9IG51bGw7XG4gICAgdGhpcy5wcm92aWRlciA9IG51bGw7XG4gICAgdGhpcy5tb2RlbCA9IG51bGw7XG4gICAgdGhpcy5jb3N0ID0gbnVsbDtcbiAgICB0aGlzLnJhd19yZXF1ZXN0ID0gbnVsbDtcbiAgICB0aGlzLnJhd19yZXNwb25zZSA9IG51bGw7XG4gICAgdGhpcy5lcnJvcl9tZXNzYWdlID0gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9nKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHN0cnVjdHVyZWRMb2c6IFN0cnVjdHVyZWRMb2dEYXRhID0ge1xuICAgICAgaWQ6IHV1aWR2NCgpLFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnJlcXVlc3RTdGFydFRpbWUuZ2V0VGltZSgpLFxuICAgICAgbGF0ZW5jeTogQmlnSW50KERhdGUubm93KCkgLSB0aGlzLnJlcXVlc3RTdGFydFRpbWUuZ2V0VGltZSgpKSxcbiAgICAgIGlzX3N1Y2Nlc3NmdWw6IHRoaXMuaXNfc3VjY2Vzc2Z1bCxcbiAgICAgIHN1Y2Nlc3NfcmVhc29uOiB0aGlzLnN1Y2Nlc3NfcmVhc29uLFxuICAgICAgZXJyb3JfcmVhc29uOiB0aGlzLmVycm9yX3JlYXNvbixcbiAgICAgIG1vZGVsX3JvdXRpbmdfaGlzdG9yeTogSlNPTi5zdHJpbmdpZnkodGhpcy5tb2RlbF9yb3V0aW5nX2hpc3RvcnkpLFxuICAgICAgdXNlcl9pZDogdGhpcy51c2VyX2lkLFxuICAgICAgbWV0YWRhdGE6IHRoaXMubWV0YWRhdGEsXG4gICAgICB0aHJlYWRfaWQ6IHRoaXMudGhyZWFkX2lkLFxuICAgICAgcHJvdmlkZXI6IHRoaXMucHJvdmlkZXIsXG4gICAgICBtb2RlbDogdGhpcy5tb2RlbCxcbiAgICAgIGNvc3Q6IHRoaXMuY29zdCxcbiAgICAgIHJhd19yZXF1ZXN0OiB0aGlzLnJhd19yZXF1ZXN0LFxuICAgICAgcmF3X3Jlc3BvbnNlOiB0aGlzLnJhd19yZXNwb25zZSxcbiAgICAgIGVycm9yX21lc3NhZ2U6IHRoaXMuZXJyb3JfbWVzc2FnZSxcbiAgICB9O1xuXG4gICAgY29uc3Qgc2NoZW1hID0gbmV3IHBhcnF1ZXRzLlBhcnF1ZXRTY2hlbWEoe1xuICAgICAgaWQ6IHsgdHlwZTogJ1VURjgnIH0sXG4gICAgICB0aW1lc3RhbXA6IHsgdHlwZTogJ0lOVDY0Jywgb3JpZ2luYWxUeXBlOiAnVElNRVNUQU1QX01JTExJUycgfSBhcyBhbnksXG4gICAgICBsYXRlbmN5OiB7IHR5cGU6ICdJTlQ2NCcgfSxcbiAgICAgIGlzX3N1Y2Nlc3NmdWw6IHsgdHlwZTogJ0JPT0xFQU4nIH0sXG4gICAgICBzdWNjZXNzX3JlYXNvbjogeyB0eXBlOiAnVVRGOCcsIG9wdGlvbmFsOiB0cnVlIH0sXG4gICAgICBlcnJvcl9yZWFzb246IHsgdHlwZTogJ1VURjgnLCBvcHRpb25hbDogdHJ1ZSB9LFxuICAgICAgbW9kZWxfcm91dGluZ19oaXN0b3J5OiB7IHR5cGU6ICdVVEY4JyB9LFxuICAgICAgdXNlcl9pZDogeyB0eXBlOiAnVVRGOCcsIG9wdGlvbmFsOiB0cnVlIH0sXG4gICAgICBtZXRhZGF0YTogeyB0eXBlOiAnVVRGOCcsIG9wdGlvbmFsOiB0cnVlIH0sXG4gICAgICB0aHJlYWRfaWQ6IHsgdHlwZTogJ1VURjgnLCBvcHRpb25hbDogdHJ1ZSB9LFxuICAgICAgcHJvdmlkZXI6IHsgdHlwZTogJ1VURjgnLCBvcHRpb25hbDogdHJ1ZSB9LFxuICAgICAgbW9kZWw6IHsgdHlwZTogJ1VURjgnLCBvcHRpb25hbDogdHJ1ZSB9LFxuICAgICAgY29zdDogeyB0eXBlOiAnRE9VQkxFJywgb3B0aW9uYWw6IHRydWUgfSxcbiAgICAgIHJhd19yZXF1ZXN0OiB7IHR5cGU6ICdVVEY4Jywgb3B0aW9uYWw6IHRydWUgfSxcbiAgICAgIHJhd19yZXNwb25zZTogeyB0eXBlOiAnVVRGOCcsIG9wdGlvbmFsOiB0cnVlIH0sXG4gICAgICBlcnJvcl9tZXNzYWdlOiB7IHR5cGU6ICdVVEY4Jywgb3B0aW9uYWw6IHRydWUgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHRtcEZpbGVQYXRoID0gcGF0aC5qb2luKG9zLnRtcGRpcigpLCBgJHtzdHJ1Y3R1cmVkTG9nLmlkfS5wYXJxdWV0YCk7XG4gICAgY29uc3Qgd3JpdGVyID0gYXdhaXQgcGFycXVldHMuUGFycXVldFdyaXRlci5vcGVuRmlsZShzY2hlbWEsIHRtcEZpbGVQYXRoKTtcbiAgICBhd2FpdCB3cml0ZXIuYXBwZW5kUm93KHN0cnVjdHVyZWRMb2cpO1xuICAgIGF3YWl0IHdyaXRlci5jbG9zZSgpO1xuXG4gICAgY29uc3QgYnVmZmVyID0gYXdhaXQgcmVhZEZpbGUodG1wRmlsZVBhdGgpO1xuICAgIGF3YWl0IHVubGluayh0bXBGaWxlUGF0aCk7XG5cbiAgICBjb25zdCBpc29EYXRlID0gbmV3IERhdGUoc3RydWN0dXJlZExvZy50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCk7XG4gICAgY29uc3QgZGF0ZSA9IGlzb0RhdGUuc3BsaXQoJ1QnKVswXTtcblxuICAgIGNvbnN0IGtleSA9IGBsb2dzL3BhcnF1ZXQvaXNfc3VjY2Vzc2Z1bD0ke1xuICAgICAgc3RydWN0dXJlZExvZy5pc19zdWNjZXNzZnVsXG4gICAgfS9kYXRlPSR7ZGF0ZX0vcHJvdmlkZXI9JHtzdHJ1Y3R1cmVkTG9nLnByb3ZpZGVyID8/ICcnfS9tb2RlbD0ke1xuICAgICAgc3RydWN0dXJlZExvZy5tb2RlbCA/PyAnJ1xuICAgIH0vJHtzdHJ1Y3R1cmVkTG9nLmlkfS5wYXJxdWV0YDtcblxuICAgIGF3YWl0IExvZ2dlci5zMy5zZW5kKFxuICAgICAgbmV3IFB1dE9iamVjdENvbW1hbmQoe1xuICAgICAgICBCdWNrZXQ6IExPR19CVUNLRVQsXG4gICAgICAgIEtleToga2V5LFxuICAgICAgICBCb2R5OiBidWZmZXIsXG4gICAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGF3YWl0IExvZ2dlci5kZGIuc2VuZChcbiAgICAgIG5ldyBQdXRJdGVtQ29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogTE9HX1RBQkxFX05BTUUsXG4gICAgICAgIEl0ZW06IHtcbiAgICAgICAgICBQSzogeyBTOiAnTE9HJyB9LFxuICAgICAgICAgIFNLOiB7IFM6IGBUUyMke2lzb0RhdGV9YCB9LFxuICAgICAgICAgIGlkOiB7IFM6IHN0cnVjdHVyZWRMb2cuaWQgfSxcbiAgICAgICAgICB0aW1lc3RhbXA6IHsgUzogaXNvRGF0ZSB9LFxuICAgICAgICAgIGxhdGVuY3k6IHsgTjogc3RydWN0dXJlZExvZy5sYXRlbmN5LnRvU3RyaW5nKCkgfSxcbiAgICAgICAgICBpc19zdWNjZXNzZnVsOiB7IEJPT0w6IHN0cnVjdHVyZWRMb2cuaXNfc3VjY2Vzc2Z1bCB9LFxuICAgICAgICAgIHN1Y2Nlc3NfcmVhc29uOiBzdHJ1Y3R1cmVkTG9nLnN1Y2Nlc3NfcmVhc29uXG4gICAgICAgICAgICA/IHsgUzogc3RydWN0dXJlZExvZy5zdWNjZXNzX3JlYXNvbiB9XG4gICAgICAgICAgICA6IHsgTlVMTDogdHJ1ZSB9LFxuICAgICAgICAgIGVycm9yX3JlYXNvbjogc3RydWN0dXJlZExvZy5lcnJvcl9yZWFzb25cbiAgICAgICAgICAgID8geyBTOiBzdHJ1Y3R1cmVkTG9nLmVycm9yX3JlYXNvbiB9XG4gICAgICAgICAgICA6IHsgTlVMTDogdHJ1ZSB9LFxuICAgICAgICAgIG1vZGVsX3JvdXRpbmdfaGlzdG9yeTogeyBTOiBzdHJ1Y3R1cmVkTG9nLm1vZGVsX3JvdXRpbmdfaGlzdG9yeSB9LFxuICAgICAgICAgIHVzZXJfaWQ6IHN0cnVjdHVyZWRMb2cudXNlcl9pZFxuICAgICAgICAgICAgPyB7IFM6IHN0cnVjdHVyZWRMb2cudXNlcl9pZCB9XG4gICAgICAgICAgICA6IHsgTlVMTDogdHJ1ZSB9LFxuICAgICAgICAgIG1ldGFkYXRhOiBzdHJ1Y3R1cmVkTG9nLm1ldGFkYXRhXG4gICAgICAgICAgICA/IHsgUzogc3RydWN0dXJlZExvZy5tZXRhZGF0YSB9XG4gICAgICAgICAgICA6IHsgTlVMTDogdHJ1ZSB9LFxuICAgICAgICAgIHRocmVhZF9pZDogc3RydWN0dXJlZExvZy50aHJlYWRfaWRcbiAgICAgICAgICAgID8geyBTOiBzdHJ1Y3R1cmVkTG9nLnRocmVhZF9pZCB9XG4gICAgICAgICAgICA6IHsgTlVMTDogdHJ1ZSB9LFxuICAgICAgICAgIHByb3ZpZGVyOiBzdHJ1Y3R1cmVkTG9nLnByb3ZpZGVyXG4gICAgICAgICAgICA/IHsgUzogc3RydWN0dXJlZExvZy5wcm92aWRlciB9XG4gICAgICAgICAgICA6IHsgTlVMTDogdHJ1ZSB9LFxuICAgICAgICAgIG1vZGVsOiBzdHJ1Y3R1cmVkTG9nLm1vZGVsXG4gICAgICAgICAgICA/IHsgUzogc3RydWN0dXJlZExvZy5tb2RlbCB9XG4gICAgICAgICAgICA6IHsgTlVMTDogdHJ1ZSB9LFxuICAgICAgICAgIGNvc3Q6XG4gICAgICAgICAgICBzdHJ1Y3R1cmVkTG9nLmNvc3QgIT09IG51bGxcbiAgICAgICAgICAgICAgPyB7IE46IHN0cnVjdHVyZWRMb2cuY29zdC50b1N0cmluZygpIH1cbiAgICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICByYXdfcmVxdWVzdDogc3RydWN0dXJlZExvZy5yYXdfcmVxdWVzdFxuICAgICAgICAgICAgPyB7IFM6IHN0cnVjdHVyZWRMb2cucmF3X3JlcXVlc3QgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICByYXdfcmVzcG9uc2U6IHN0cnVjdHVyZWRMb2cucmF3X3Jlc3BvbnNlXG4gICAgICAgICAgICA/IHsgUzogc3RydWN0dXJlZExvZy5yYXdfcmVzcG9uc2UgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICBlcnJvcl9tZXNzYWdlOiBzdHJ1Y3R1cmVkTG9nLmVycm9yX21lc3NhZ2VcbiAgICAgICAgICAgID8geyBTOiBzdHJ1Y3R1cmVkTG9nLmVycm9yX21lc3NhZ2UgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHNldFJhd1JlcXVlc3QocmF3UmVxdWVzdDogc3RyaW5nKSB7XG4gICAgdGhpcy5yYXdfcmVxdWVzdCA9IHJhd1JlcXVlc3Q7XG4gIH1cblxuICBzZXRJbml0aWFsRGF0YShcbiAgICB0aHJlYWRJZDogc3RyaW5nLFxuICAgIHVzZXJJZDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICAgIG1ldGFkYXRhOiBzdHJpbmdcbiAgKSB7XG4gICAgdGhpcy50aHJlYWRfaWQgPSB0aHJlYWRJZDtcbiAgICB0aGlzLnVzZXJfaWQgPSB1c2VySWQgfHwgbnVsbDtcbiAgICB0aGlzLm1ldGFkYXRhID0gbWV0YWRhdGE7XG4gIH1cblxuICBhc3luYyBsb2dTdWNjZXNzRGF0YShcbiAgICBtb2RlbDogc3RyaW5nLFxuICAgIHByb3ZpZGVyOiBzdHJpbmcsXG4gICAgbW9kZWxSb3V0aW5nSGlzdG9yeTogUm91dGluZ0xvZyxcbiAgICBzdWNjZXNzUmVhc29uOiBzdHJpbmcsXG4gICAgcmF3UmVzcG9uc2U6IHN0cmluZ1xuICApIHtcbiAgICBjb25zdCBtb2RlbFJvdXRpbmdIaXN0b3J5SnNvbkFycmF5ID0gbW9kZWxSb3V0aW5nSGlzdG9yeS5ldmVudHMubWFwKChlKSA9PlxuICAgICAgSlNPTi5zdHJpbmdpZnkoZSwgbnVsbCwgMilcbiAgICApO1xuXG4gICAgdGhpcy5tb2RlbCA9IG1vZGVsO1xuICAgIHRoaXMucHJvdmlkZXIgPSBwcm92aWRlcjtcbiAgICB0aGlzLm1vZGVsX3JvdXRpbmdfaGlzdG9yeSA9IG1vZGVsUm91dGluZ0hpc3RvcnlKc29uQXJyYXk7XG4gICAgdGhpcy5zdWNjZXNzX3JlYXNvbiA9IHN1Y2Nlc3NSZWFzb247XG4gICAgdGhpcy5yYXdfcmVzcG9uc2UgPSByYXdSZXNwb25zZTtcbiAgICB0aGlzLmlzX3N1Y2Nlc3NmdWwgPSB0cnVlO1xuXG4gICAgYXdhaXQgdGhpcy5sb2coKTtcbiAgfVxuXG4gIGFzeW5jIGxvZ0Vycm9yRGF0YShlcnJvclJlYXNvbjogc3RyaW5nLCBlcnJvck1lc3NhZ2U6IHN0cmluZykge1xuICAgIHRoaXMuZXJyb3JfcmVhc29uID0gZXJyb3JSZWFzb247XG4gICAgdGhpcy5lcnJvcl9tZXNzYWdlID0gZXJyb3JNZXNzYWdlO1xuXG4gICAgYXdhaXQgdGhpcy5sb2coKTtcbiAgfVxufVxuIl19
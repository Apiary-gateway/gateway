"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Logger = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const uuid_1 = require("uuid");
const LOG_TABLE_NAME = process.env.LOG_TABLE_NAME;
if (!LOG_TABLE_NAME) {
    throw new Error('LOG_TABLE_NAME must be set');
}
class Logger {
    constructor() {
        this.requestStartTime = new Date();
        this.is_successful = false;
        this.user_id = null;
        this.metadata = null;
        this.success_reason = null;
        this.error_reason = null;
        this.model_routing_history = [];
        this.thread_id = null;
        this.provider = null;
        this.model = null;
        this.cost = null;
        this.raw_request = null;
        this.raw_response = null;
        this.error_message = null;
    }
    async log() {
        // Build the log object
        const structuredLog = {
            id: (0, uuid_1.v4)(),
            timestamp: this.requestStartTime.getTime(),
            latency: BigInt(Date.now() - this.requestStartTime.getTime()),
            is_successful: this.is_successful,
            success_reason: this.success_reason,
            error_reason: this.error_reason,
            model_routing_history: JSON.stringify(this.model_routing_history),
            user_id: this.user_id,
            metadata: this.metadata,
            thread_id: this.thread_id,
            provider: this.provider,
            model: this.model,
            cost: this.cost,
            raw_request: this.raw_request,
            raw_response: this.raw_response,
            error_message: this.error_message,
        };
        // Write to DynamoDB only
        const isoDate = new Date(structuredLog.timestamp).toISOString();
        await Logger.ddb.send(new client_dynamodb_1.PutItemCommand({
            TableName: LOG_TABLE_NAME,
            Item: {
                PK: { S: 'LOG' },
                SK: { S: `TS#${isoDate}` },
                id: { S: structuredLog.id },
                timestamp: { S: isoDate },
                latency: { N: structuredLog.latency.toString() },
                is_successful: { BOOL: structuredLog.is_successful },
                success_reason: structuredLog.success_reason
                    ? { S: structuredLog.success_reason }
                    : { NULL: true },
                error_reason: structuredLog.error_reason
                    ? { S: structuredLog.error_reason }
                    : { NULL: true },
                model_routing_history: { S: structuredLog.model_routing_history },
                user_id: structuredLog.user_id
                    ? { S: structuredLog.user_id }
                    : { NULL: true },
                metadata: structuredLog.metadata
                    ? { S: structuredLog.metadata }
                    : { NULL: true },
                thread_id: structuredLog.thread_id
                    ? { S: structuredLog.thread_id }
                    : { NULL: true },
                provider: structuredLog.provider
                    ? { S: structuredLog.provider }
                    : { NULL: true },
                model: structuredLog.model
                    ? { S: structuredLog.model }
                    : { NULL: true },
                cost: structuredLog.cost !== null
                    ? { N: structuredLog.cost.toString() }
                    : { NULL: true },
                raw_request: structuredLog.raw_request
                    ? { S: structuredLog.raw_request }
                    : { NULL: true },
                raw_response: structuredLog.raw_response
                    ? { S: structuredLog.raw_response }
                    : { NULL: true },
                error_message: structuredLog.error_message
                    ? { S: structuredLog.error_message }
                    : { NULL: true },
            },
        }));
    }
    setRawRequest(rawRequest) {
        this.raw_request = rawRequest;
    }
    setInitialData(threadId, userId, metadata) {
        this.thread_id = threadId;
        this.user_id = userId || null;
        this.metadata = metadata;
    }
    async logSuccessData(model, provider, modelRoutingHistory, successReason, rawResponse) {
        const modelRoutingHistoryJsonArray = modelRoutingHistory.events.map((e) => JSON.stringify(e, null, 2));
        this.model = model;
        this.provider = provider;
        this.model_routing_history = modelRoutingHistoryJsonArray;
        this.success_reason = successReason;
        this.raw_response = rawResponse;
        this.is_successful = true;
        await this.log();
    }
    async logErrorData(errorReason, errorMessage) {
        this.error_reason = errorReason;
        this.error_message = errorMessage;
        await this.log();
    }
}
exports.Logger = Logger;
Logger.ddb = new client_dynamodb_1.DynamoDBClient({});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGFtYmRhL3V0aWwvbG9nZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDhEQUEwRTtBQUMxRSwrQkFBb0M7QUFHcEMsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7QUFDbEQsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztBQUNoRCxDQUFDO0FBcUJELE1BQWEsTUFBTTtJQWtCakI7UUFDRSxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztRQUMzQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztRQUMzQixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztRQUN6QixJQUFJLENBQUMscUJBQXFCLEdBQUcsRUFBRSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0lBQzVCLENBQUM7SUFFTyxLQUFLLENBQUMsR0FBRztRQUNmLHVCQUF1QjtRQUN2QixNQUFNLGFBQWEsR0FBc0I7WUFDdkMsRUFBRSxFQUFF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ZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgUm91dGluZ0xvZyB9IGZyb20gJy4vdHlwZXMnO1xuXG5jb25zdCBMT0dfVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LkxPR19UQUJMRV9OQU1FO1xuaWYgKCFMT0dfVEFCTEVfTkFNRSkge1xuICB0aHJvdyBuZXcgRXJyb3IoJ0xPR19UQUJMRV9OQU1FIG11c3QgYmUgc2V0Jyk7XG59XG5cbmludGVyZmFjZSBTdHJ1Y3R1cmVkTG9nRGF0YSB7XG4gIGlkOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogbnVtYmVyOyAvLyBlcG9jaCBtaWxsaXNcbiAgbGF0ZW5jeTogYmlnaW50O1xuICBpc19zdWNjZXNzZnVsOiBib29sZWFuO1xuICBzdWNjZXNzX3JlYXNvbjogc3RyaW5nIHwgbnVsbDtcbiAgZXJyb3JfcmVhc29uOiBzdHJpbmcgfCBudWxsO1xuICBtb2RlbF9yb3V0aW5nX2hpc3Rvcnk6IHN0cmluZztcbiAgdXNlcl9pZDogc3RyaW5nIHwgbnVsbDtcbiAgbWV0YWRhdGE6IHN0cmluZyB8IG51bGw7XG4gIHRocmVhZF9pZDogc3RyaW5nIHwgbnVsbDtcbiAgcHJvdmlkZXI6IHN0cmluZyB8IG51bGw7XG4gIG1vZGVsOiBzdHJpbmcgfCBudWxsO1xuICBjb3N0OiBudW1iZXIgfCBudWxsO1xuICByYXdfcmVxdWVzdDogc3RyaW5nIHwgbnVsbDtcbiAgcmF3X3Jlc3BvbnNlOiBzdHJpbmcgfCBudWxsO1xuICBlcnJvcl9tZXNzYWdlOiBzdHJpbmcgfCBudWxsO1xufVxuXG5leHBvcnQgY2xhc3MgTG9nZ2VyIHtcbiAgcHJpdmF0ZSBzdGF0aWMgZGRiOiBEeW5hbW9EQkNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5cbiAgcHJpdmF0ZSByZXF1ZXN0U3RhcnRUaW1lOiBEYXRlO1xuICBwcml2YXRlIGlzX3N1Y2Nlc3NmdWw6IGJvb2xlYW47XG4gIHByaXZhdGUgdXNlcl9pZDogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBtZXRhZGF0YTogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBzdWNjZXNzX3JlYXNvbjogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSBlcnJvcl9yZWFzb246IHN0cmluZyB8IG51bGw7XG4gIHByaXZhdGUgbW9kZWxfcm91dGluZ19oaXN0b3J5OiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSB0aHJlYWRfaWQ6IHN0cmluZyB8IG51bGw7XG4gIHByaXZhdGUgcHJvdmlkZXI6IHN0cmluZyB8IG51bGw7XG4gIHByaXZhdGUgbW9kZWw6IHN0cmluZyB8IG51bGw7XG4gIHByaXZhdGUgY29zdDogbnVtYmVyIHwgbnVsbDtcbiAgcHJpdmF0ZSByYXdfcmVxdWVzdDogc3RyaW5nIHwgbnVsbDtcbiAgcHJpdmF0ZSByYXdfcmVzcG9uc2U6IHN0cmluZyB8IG51bGw7XG4gIHByaXZhdGUgZXJyb3JfbWVzc2FnZTogc3RyaW5nIHwgbnVsbDtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnJlcXVlc3RTdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgIHRoaXMuaXNfc3VjY2Vzc2Z1bCA9IGZhbHNlO1xuICAgIHRoaXMudXNlcl9pZCA9IG51bGw7XG4gICAgdGhpcy5tZXRhZGF0YSA9IG51bGw7XG4gICAgdGhpcy5zdWNjZXNzX3JlYXNvbiA9IG51bGw7XG4gICAgdGhpcy5lcnJvcl9yZWFzb24gPSBudWxsO1xuICAgIHRoaXMubW9kZWxfcm91dGluZ19oaXN0b3J5ID0gW107XG4gICAgdGhpcy50aHJlYWRfaWQgPSBudWxsO1xuICAgIHRoaXMucHJvdmlkZXIgPSBudWxsO1xuICAgIHRoaXMubW9kZWwgPSBudWxsO1xuICAgIHRoaXMuY29zdCA9IG51bGw7XG4gICAgdGhpcy5yYXdfcmVxdWVzdCA9IG51bGw7XG4gICAgdGhpcy5yYXdfcmVzcG9uc2UgPSBudWxsO1xuICAgIHRoaXMuZXJyb3JfbWVzc2FnZSA9IG51bGw7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvZygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBCdWlsZCB0aGUgbG9nIG9iamVjdFxuICAgIGNvbnN0IHN0cnVjdHVyZWRMb2c6IFN0cnVjdHVyZWRMb2dEYXRhID0ge1xuICAgICAgaWQ6IHV1aWR2NCgpLFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnJlcXVlc3RTdGFydFRpbWUuZ2V0VGltZSgpLFxuICAgICAgbGF0ZW5jeTogQmlnSW50KERhdGUubm93KCkgLSB0aGlzLnJlcXVlc3RTdGFydFRpbWUuZ2V0VGltZSgpKSxcbiAgICAgIGlzX3N1Y2Nlc3NmdWw6IHRoaXMuaXNfc3VjY2Vzc2Z1bCxcbiAgICAgIHN1Y2Nlc3NfcmVhc29uOiB0aGlzLnN1Y2Nlc3NfcmVhc29uLFxuICAgICAgZXJyb3JfcmVhc29uOiB0aGlzLmVycm9yX3JlYXNvbixcbiAgICAgIG1vZGVsX3JvdXRpbmdfaGlzdG9yeTogSlNPTi5zdHJpbmdpZnkodGhpcy5tb2RlbF9yb3V0aW5nX2hpc3RvcnkpLFxuICAgICAgdXNlcl9pZDogdGhpcy51c2VyX2lkLFxuICAgICAgbWV0YWRhdGE6IHRoaXMubWV0YWRhdGEsXG4gICAgICB0aHJlYWRfaWQ6IHRoaXMudGhyZWFkX2lkLFxuICAgICAgcHJvdmlkZXI6IHRoaXMucHJvdmlkZXIsXG4gICAgICBtb2RlbDogdGhpcy5tb2RlbCxcbiAgICAgIGNvc3Q6IHRoaXMuY29zdCxcbiAgICAgIHJhd19yZXF1ZXN0OiB0aGlzLnJhd19yZXF1ZXN0LFxuICAgICAgcmF3X3Jlc3BvbnNlOiB0aGlzLnJhd19yZXNwb25zZSxcbiAgICAgIGVycm9yX21lc3NhZ2U6IHRoaXMuZXJyb3JfbWVzc2FnZSxcbiAgICB9O1xuXG4gICAgLy8gV3JpdGUgdG8gRHluYW1vREIgb25seVxuICAgIGNvbnN0IGlzb0RhdGUgPSBuZXcgRGF0ZShzdHJ1Y3R1cmVkTG9nLnRpbWVzdGFtcCkudG9JU09TdHJpbmcoKTtcbiAgICBhd2FpdCBMb2dnZXIuZGRiLnNlbmQoXG4gICAgICBuZXcgUHV0SXRlbUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IExPR19UQUJMRV9OQU1FLFxuICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgUEs6IHsgUzogJ0xPRycgfSxcbiAgICAgICAgICBTSzogeyBTOiBgVFMjJHtpc29EYXRlfWAgfSxcbiAgICAgICAgICBpZDogeyBTOiBzdHJ1Y3R1cmVkTG9nLmlkIH0sXG4gICAgICAgICAgdGltZXN0YW1wOiB7IFM6IGlzb0RhdGUgfSxcbiAgICAgICAgICBsYXRlbmN5OiB7IE46IHN0cnVjdHVyZWRMb2cubGF0ZW5jeS50b1N0cmluZygpIH0sXG4gICAgICAgICAgaXNfc3VjY2Vzc2Z1bDogeyBCT09MOiBzdHJ1Y3R1cmVkTG9nLmlzX3N1Y2Nlc3NmdWwgfSxcbiAgICAgICAgICBzdWNjZXNzX3JlYXNvbjogc3RydWN0dXJlZExvZy5zdWNjZXNzX3JlYXNvblxuICAgICAgICAgICAgPyB7IFM6IHN0cnVjdHVyZWRMb2cuc3VjY2Vzc19yZWFzb24gfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICBlcnJvcl9yZWFzb246IHN0cnVjdHVyZWRMb2cuZXJyb3JfcmVhc29uXG4gICAgICAgICAgICA/IHsgUzogc3RydWN0dXJlZExvZy5lcnJvcl9yZWFzb24gfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICBtb2RlbF9yb3V0aW5nX2hpc3Rvcnk6IHsgUzogc3RydWN0dXJlZExvZy5tb2RlbF9yb3V0aW5nX2hpc3RvcnkgfSxcbiAgICAgICAgICB1c2VyX2lkOiBzdHJ1Y3R1cmVkTG9nLnVzZXJfaWRcbiAgICAgICAgICAgID8geyBTOiBzdHJ1Y3R1cmVkTG9nLnVzZXJfaWQgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICBtZXRhZGF0YTogc3RydWN0dXJlZExvZy5tZXRhZGF0YVxuICAgICAgICAgICAgPyB7IFM6IHN0cnVjdHVyZWRMb2cubWV0YWRhdGEgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICB0aHJlYWRfaWQ6IHN0cnVjdHVyZWRMb2cudGhyZWFkX2lkXG4gICAgICAgICAgICA/IHsgUzogc3RydWN0dXJlZExvZy50aHJlYWRfaWQgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICBwcm92aWRlcjogc3RydWN0dXJlZExvZy5wcm92aWRlclxuICAgICAgICAgICAgPyB7IFM6IHN0cnVjdHVyZWRMb2cucHJvdmlkZXIgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICBtb2RlbDogc3RydWN0dXJlZExvZy5tb2RlbFxuICAgICAgICAgICAgPyB7IFM6IHN0cnVjdHVyZWRMb2cubW9kZWwgfVxuICAgICAgICAgICAgOiB7IE5VTEw6IHRydWUgfSxcbiAgICAgICAgICBjb3N0OlxuICAgICAgICAgICAgc3RydWN0dXJlZExvZy5jb3N0ICE9PSBudWxsXG4gICAgICAgICAgICAgID8geyBOOiBzdHJ1Y3R1cmVkTG9nLmNvc3QudG9TdHJpbmcoKSB9XG4gICAgICAgICAgICAgIDogeyBOVUxMOiB0cnVlIH0sXG4gICAgICAgICAgcmF3X3JlcXVlc3Q6IHN0cnVjdHVyZWRMb2cucmF3X3JlcXVlc3RcbiAgICAgICAgICAgID8geyBTOiBzdHJ1Y3R1cmVkTG9nLnJhd19yZXF1ZXN0IH1cbiAgICAgICAgICAgIDogeyBOVUxMOiB0cnVlIH0sXG4gICAgICAgICAgcmF3X3Jlc3BvbnNlOiBzdHJ1Y3R1cmVkTG9nLnJhd19yZXNwb25zZVxuICAgICAgICAgICAgPyB7IFM6IHN0cnVjdHVyZWRMb2cucmF3X3Jlc3BvbnNlIH1cbiAgICAgICAgICAgIDogeyBOVUxMOiB0cnVlIH0sXG4gICAgICAgICAgZXJyb3JfbWVzc2FnZTogc3RydWN0dXJlZExvZy5lcnJvcl9tZXNzYWdlXG4gICAgICAgICAgICA/IHsgUzogc3RydWN0dXJlZExvZy5lcnJvcl9tZXNzYWdlIH1cbiAgICAgICAgICAgIDogeyBOVUxMOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBzZXRSYXdSZXF1ZXN0KHJhd1JlcXVlc3Q6IHN0cmluZykge1xuICAgIHRoaXMucmF3X3JlcXVlc3QgPSByYXdSZXF1ZXN0O1xuICB9XG5cbiAgc2V0SW5pdGlhbERhdGEoXG4gICAgdGhyZWFkSWQ6IHN0cmluZyxcbiAgICB1c2VySWQ6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICBtZXRhZGF0YTogc3RyaW5nXG4gICkge1xuICAgIHRoaXMudGhyZWFkX2lkID0gdGhyZWFkSWQ7XG4gICAgdGhpcy51c2VyX2lkID0gdXNlcklkIHx8IG51bGw7XG4gICAgdGhpcy5tZXRhZGF0YSA9IG1ldGFkYXRhO1xuICB9XG5cbiAgYXN5bmMgbG9nU3VjY2Vzc0RhdGEoXG4gICAgbW9kZWw6IHN0cmluZyxcbiAgICBwcm92aWRlcjogc3RyaW5nLFxuICAgIG1vZGVsUm91dGluZ0hpc3Rvcnk6IFJvdXRpbmdMb2csXG4gICAgc3VjY2Vzc1JlYXNvbjogc3RyaW5nLFxuICAgIHJhd1Jlc3BvbnNlOiBzdHJpbmdcbiAgKSB7XG4gICAgY29uc3QgbW9kZWxSb3V0aW5nSGlzdG9yeUpzb25BcnJheSA9IG1vZGVsUm91dGluZ0hpc3RvcnkuZXZlbnRzLm1hcCgoZSkgPT5cbiAgICAgIEpTT04uc3RyaW5naWZ5KGUsIG51bGwsIDIpXG4gICAgKTtcblxuICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcbiAgICB0aGlzLnByb3ZpZGVyID0gcHJvdmlkZXI7XG4gICAgdGhpcy5tb2RlbF9yb3V0aW5nX2hpc3RvcnkgPSBtb2RlbFJvdXRpbmdIaXN0b3J5SnNvbkFycmF5O1xuICAgIHRoaXMuc3VjY2Vzc19yZWFzb24gPSBzdWNjZXNzUmVhc29uO1xuICAgIHRoaXMucmF3X3Jlc3BvbnNlID0gcmF3UmVzcG9uc2U7XG4gICAgdGhpcy5pc19zdWNjZXNzZnVsID0gdHJ1ZTtcblxuICAgIGF3YWl0IHRoaXMubG9nKCk7XG4gIH1cblxuICBhc3luYyBsb2dFcnJvckRhdGEoZXJyb3JSZWFzb246IHN0cmluZywgZXJyb3JNZXNzYWdlOiBzdHJpbmcpIHtcbiAgICB0aGlzLmVycm9yX3JlYXNvbiA9IGVycm9yUmVhc29uO1xuICAgIHRoaXMuZXJyb3JfbWVzc2FnZSA9IGVycm9yTWVzc2FnZTtcblxuICAgIGF3YWl0IHRoaXMubG9nKCk7XG4gIH1cbn1cbiJdfQ==
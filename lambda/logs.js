"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_athena_1 = require("@aws-sdk/client-athena");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const athenaClient = new client_athena_1.AthenaClient({});
const LOG_TABLE_NAME = process.env.LOG_TABLE_NAME || '';
const LOG_BUCKET_NAME = process.env.LOG_BUCKET_NAME || '';
const ATHENA_DATABASE = 'ai_gateway_logs_db';
const ATHENA_WORKGROUP = 'llm_logs_workgroup';
const PAGE_SIZE = 15;
// Utility to get today's date in yyyy-MM-dd format
const getTodayDate = () => {
    return new Date().toISOString().split('T')[0]; // e.g., "2025-03-27"
};
// Map DynamoDB items to a consistent format
const mapDynamoItem = (item) => ({
    id: item.id?.S,
    timestamp: item.timestamp?.S,
    status: item.status?.S,
    provider: item.provider?.S,
    model: item.model?.S,
    latency: item.latency?.N,
});
// Map Athena rows to a consistent format
const mapAthenaRow = (row) => {
    const data = row.Data || [];
    return {
        id: data[0]?.VarCharValue,
        timestamp: data[1]?.VarCharValue,
        status: data[2]?.VarCharValue,
        provider: data[3]?.VarCharValue,
        model: data[4]?.VarCharValue,
        latency: data[5]?.VarCharValue,
    };
};
const handler = async (event) => {
    try {
        const queryParams = event.queryStringParameters || {};
        const older = queryParams.older === 'true'; // ?older=true for Athena, otherwise DynamoDB
        const page = parseInt(queryParams.page || '1', 10); // Default to page 1
        if (isNaN(page) || page < 1) {
            return {
                statusCode: 400,
                body: JSON.stringify({ message: 'Invalid page number' }),
            };
        }
        const offset = (page - 1) * PAGE_SIZE; // Calculate offset based on page number
        let logs = [];
        let totalPages;
        if (older) {
            // Query Athena for older logs with offset
            const today = getTodayDate();
            const athenaQuery = `
        SELECT id, timestamp, status, provider, model, latency
        FROM "ai_gateway_logs"
        WHERE date < '${today}'
        ORDER BY date DESC, timestamp DESC
        LIMIT ${PAGE_SIZE} OFFSET ${offset}
      `;
            const startQuery = new client_athena_1.StartQueryExecutionCommand({
                QueryString: athenaQuery,
                WorkGroup: ATHENA_WORKGROUP,
                ResultConfiguration: {
                    OutputLocation: `s3://${LOG_BUCKET_NAME}/athena-results/`,
                },
                QueryExecutionContext: {
                    Database: ATHENA_DATABASE,
                },
            });
            const queryExecution = await athenaClient.send(startQuery);
            const queryExecutionId = queryExecution.QueryExecutionId;
            // Poll for query completion using GetQueryExecutionCommand
            let queryState;
            do {
                await new Promise((resolve) => setTimeout(resolve, 1000)); // Wait 1 second
                const queryExecutionResult = await athenaClient.send(new client_athena_1.GetQueryExecutionCommand({ QueryExecutionId: queryExecutionId }));
                queryState = queryExecutionResult.QueryExecution?.Status?.State;
            } while (queryState === 'RUNNING' || queryState === 'QUEUED');
            if (queryState === 'FAILED') {
                throw new Error('Athena query failed: ' +
                    (await athenaClient.send(new client_athena_1.GetQueryExecutionCommand({
                        QueryExecutionId: queryExecutionId,
                    }))).QueryExecution?.Status?.StateChangeReason);
            }
            // Fetch results once query succeeds
            const queryResults = await athenaClient.send(new client_athena_1.GetQueryResultsCommand({ QueryExecutionId: queryExecutionId }));
            logs = queryResults.ResultSet?.Rows?.slice(1).map(mapAthenaRow) || []; // Skip header row
            // Calculate total pages for Athena only on page 1
            if (page === 1) {
                const countQuery = `
          SELECT COUNT(*) as total
          FROM "ai_gateway_logs"
          WHERE date < '${today}'
        `;
                const startCountQuery = new client_athena_1.StartQueryExecutionCommand({
                    QueryString: countQuery,
                    WorkGroup: ATHENA_WORKGROUP,
                    ResultConfiguration: {
                        OutputLocation: `s3://${LOG_BUCKET_NAME}/athena-results/`,
                    },
                    QueryExecutionContext: { Database: ATHENA_DATABASE },
                });
                const countExecution = await athenaClient.send(startCountQuery);
                let countState;
                do {
                    await new Promise((resolve) => setTimeout(resolve, 1000));
                    const countExecutionResult = await athenaClient.send(new client_athena_1.GetQueryExecutionCommand({
                        QueryExecutionId: countExecution.QueryExecutionId,
                    }));
                    countState = countExecutionResult.QueryExecution?.Status?.State;
                } while (countState === 'RUNNING' || countState === 'QUEUED');
                if (countState === 'SUCCEEDED') {
                    const countResults = await athenaClient.send(new client_athena_1.GetQueryResultsCommand({
                        QueryExecutionId: countExecution.QueryExecutionId,
                    }));
                    const totalRows = parseInt(countResults.ResultSet?.Rows?.[1].Data?.[0].VarCharValue || '0', 10);
                    totalPages = Math.ceil(totalRows / PAGE_SIZE);
                }
            }
        }
        else {
            // Query DynamoDB for today's logs with offset
            const today = getTodayDate();
            const dynamoQuery = new client_dynamodb_1.QueryCommand({
                TableName: LOG_TABLE_NAME,
                KeyConditionExpression: 'PK = :pk AND begins_with(SK, :sk)',
                ExpressionAttributeValues: {
                    ':pk': { S: 'LOG' }, // Adjust if your PK is different
                    ':sk': { S: today }, // SK starts with today's date
                },
                ScanIndexForward: true, // Ascending order (adjust if needed)
            });
            // Fetch all items and manually paginate
            const dynamoResult = await dynamoClient.send(dynamoQuery);
            const allLogs = dynamoResult.Items?.map(mapDynamoItem) || [];
            logs = allLogs.slice(offset, offset + PAGE_SIZE); // Slice to get the requested page
            totalPages = Math.ceil(allLogs.length / PAGE_SIZE); // Calculate total pages for DynamoDB
        }
        return {
            statusCode: 200,
            body: JSON.stringify({
                logs,
                page,
                pageSize: PAGE_SIZE,
                totalPages, // Included for DynamoDB always, Athena on page 1
            }),
        };
    }
    catch (error) {
        console.error('Error fetching logs:', error);
        return {
            statusCode: 500,
            body: JSON.stringify({
                message: 'Error fetching logs',
                error: String(error),
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxvZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQXdFO0FBQ3hFLDBEQUtnQztBQUVoQyxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxZQUFZLEdBQUcsSUFBSSw0QkFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzFDLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLEVBQUUsQ0FBQztBQUN4RCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxFQUFFLENBQUM7QUFDMUQsTUFBTSxlQUFlLEdBQUcsb0JBQW9CLENBQUM7QUFDN0MsTUFBTSxnQkFBZ0IsR0FBRyxvQkFBb0IsQ0FBQztBQUM5QyxNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUM7QUFFckIsbURBQW1EO0FBQ25ELE1BQU0sWUFBWSxHQUFHLEdBQVcsRUFBRTtJQUNoQyxPQUFPLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMscUJBQXFCO0FBQ3RFLENBQUMsQ0FBQztBQUVGLDRDQUE0QztBQUM1QyxNQUFNLGFBQWEsR0FBRyxDQUFDLElBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNwQyxFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQ2QsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUM1QixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3RCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDMUIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNwQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8s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QUFDLENBQUM7QUF2SlcsUUFBQSxPQUFPLFdBdUpsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBRdWVyeUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHtcbiAgQXRoZW5hQ2xpZW50LFxuICBTdGFydFF1ZXJ5RXhlY3V0aW9uQ29tbWFuZCxcbiAgR2V0UXVlcnlFeGVjdXRpb25Db21tYW5kLFxuICBHZXRRdWVyeVJlc3VsdHNDb21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtYXRoZW5hJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGF0aGVuYUNsaWVudCA9IG5ldyBBdGhlbmFDbGllbnQoe30pO1xuY29uc3QgTE9HX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5MT0dfVEFCTEVfTkFNRSB8fCAnJztcbmNvbnN0IExPR19CVUNLRVRfTkFNRSA9IHByb2Nlc3MuZW52LkxPR19CVUNLRVRfTkFNRSB8fCAnJztcbmNvbnN0IEFUSEVOQV9EQVRBQkFTRSA9ICdhaV9nYXRld2F5X2xvZ3NfZGInO1xuY29uc3QgQVRIRU5BX1dPUktHUk9VUCA9ICdsbG1fbG9nc193b3JrZ3JvdXAnO1xuY29uc3QgUEFHRV9TSVpFID0gMTU7XG5cbi8vIFV0aWxpdHkgdG8gZ2V0IHRvZGF5J3MgZGF0ZSBpbiB5eXl5LU1NLWRkIGZvcm1hdFxuY29uc3QgZ2V0VG9kYXlEYXRlID0gKCk6IHN0cmluZyA9PiB7XG4gIHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXTsgLy8gZS5nLiwgXCIyMDI1LTAzLTI3XCJcbn07XG5cbi8vIE1hcCBEeW5hbW9EQiBpdGVtcyB0byBhIGNvbnNpc3RlbnQgZm9ybWF0XG5jb25zdCBtYXBEeW5hbW9JdGVtID0gKGl0ZW06IGFueSkgPT4gKHtcbiAgaWQ6IGl0ZW0uaWQ/LlMsXG4gIHRpbWVzdGFtcDogaXRlbS50aW1lc3RhbXA/LlMsXG4gIHN0YXR1czogaXRlbS5zdGF0dXM/LlMsXG4gIHByb3ZpZGVyOiBpdGVtLnByb3ZpZGVyPy5TLFxuICBtb2RlbDogaXRlbS5tb2RlbD8uUyxcbiAgbGF0ZW5jeTogaXRlbS5sYXRlbmN5Py5OLFxufSk7XG5cbi8vIE1hcCBBdGhlbmEgcm93cyB0byBhIGNvbnNpc3RlbnQgZm9ybWF0XG5jb25zdCBtYXBBdGhlbmFSb3cgPSAocm93OiBhbnkpID0+IHtcbiAgY29uc3QgZGF0YSA9IHJvdy5EYXRhIHx8IFtdO1xuICByZXR1cm4ge1xuICAgIGlkOiBkYXRhWzBdPy5WYXJDaGFyVmFsdWUsXG4gICAgdGltZXN0YW1wOiBkYXRhWzFdPy5WYXJDaGFyVmFsdWUsXG4gICAgc3RhdHVzOiBkYXRhWzJdPy5WYXJDaGFyVmFsdWUsXG4gICAgcHJvdmlkZXI6IGRhdGFbM10/LlZhckNoYXJWYWx1ZSxcbiAgICBtb2RlbDogZGF0YVs0XT8uVmFyQ2hhclZhbHVlLFxuICAgIGxhdGVuY3k6IGRhdGFbNV0/LlZhckNoYXJWYWx1ZSxcbiAgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcXVlcnlQYXJhbXMgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMgfHwge307XG4gICAgY29uc3Qgb2xkZXIgPSBxdWVyeVBhcmFtcy5vbGRlciA9PT0gJ3RydWUnOyAvLyA/b2xkZXI9dHJ1ZSBmb3IgQXRoZW5hLCBvdGhlcndpc2UgRHluYW1vREJcbiAgICBjb25zdCBwYWdlID0gcGFyc2VJbnQocXVlcnlQYXJhbXMucGFnZSB8fCAnMScsIDEwKTsgLy8gRGVmYXVsdCB0byBwYWdlIDFcbiAgICBpZiAoaXNOYU4ocGFnZSkgfHwgcGFnZSA8IDEpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlOiAnSW52YWxpZCBwYWdlIG51bWJlcicgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IG9mZnNldCA9IChwYWdlIC0gMSkgKiBQQUdFX1NJWkU7IC8vIENhbGN1bGF0ZSBvZmZzZXQgYmFzZWQgb24gcGFnZSBudW1iZXJcbiAgICBsZXQgbG9nczogYW55W10gPSBbXTtcbiAgICBsZXQgdG90YWxQYWdlczogbnVtYmVyIHwgdW5kZWZpbmVkO1xuXG4gICAgaWYgKG9sZGVyKSB7XG4gICAgICAvLyBRdWVyeSBBdGhlbmEgZm9yIG9sZGVyIGxvZ3Mgd2l0aCBvZmZzZXRcbiAgICAgIGNvbnN0IHRvZGF5ID0gZ2V0VG9kYXlEYXRlKCk7XG4gICAgICBjb25zdCBhdGhlbmFRdWVyeSA9IGBcbiAgICAgICAgU0VMRUNUIGlkLCB0aW1lc3RhbXAsIHN0YXR1cywgcHJvdmlkZXIsIG1vZGVsLCBsYXRlbmN5XG4gICAgICAgIEZST00gXCJhaV9nYXRld2F5X2xvZ3NcIlxuICAgICAgICBXSEVSRSBkYXRlIDwgJyR7dG9kYXl9J1xuICAgICAgICBPUkRFUiBCWSBkYXRlIERFU0MsIHRpbWVzdGFtcCBERVNDXG4gICAgICAgIExJTUlUICR7UEFHRV9TSVpFfSBPRkZTRVQgJHtvZmZzZXR9XG4gICAgICBgO1xuXG4gICAgICBjb25zdCBzdGFydFF1ZXJ5ID0gbmV3IFN0YXJ0UXVlcnlFeGVjdXRpb25Db21tYW5kKHtcbiAgICAgICAgUXVlcnlTdHJpbmc6IGF0aGVuYVF1ZXJ5LFxuICAgICAgICBXb3JrR3JvdXA6IEFUSEVOQV9XT1JLR1JPVVAsXG4gICAgICAgIFJlc3VsdENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICBPdXRwdXRMb2NhdGlvbjogYHMzOi8vJHtMT0dfQlVDS0VUX05BTUV9L2F0aGVuYS1yZXN1bHRzL2AsXG4gICAgICAgIH0sXG4gICAgICAgIFF1ZXJ5RXhlY3V0aW9uQ29udGV4dDoge1xuICAgICAgICAgIERhdGFiYXNlOiBBVEhFTkFfREFUQUJBU0UsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcXVlcnlFeGVjdXRpb24gPSBhd2FpdCBhdGhlbmFDbGllbnQuc2VuZChzdGFydFF1ZXJ5KTtcbiAgICAgIGNvbnN0IHF1ZXJ5RXhlY3V0aW9uSWQgPSBxdWVyeUV4ZWN1dGlvbi5RdWVyeUV4ZWN1dGlvbklkO1xuXG4gICAgICAvLyBQb2xsIGZvciBxdWVyeSBjb21wbGV0aW9uIHVzaW5nIEdldFF1ZXJ5RXhlY3V0aW9uQ29tbWFuZFxuICAgICAgbGV0IHF1ZXJ5U3RhdGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgIGRvIHtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMCkpOyAvLyBXYWl0IDEgc2Vjb25kXG4gICAgICAgIGNvbnN0IHF1ZXJ5RXhlY3V0aW9uUmVzdWx0ID0gYXdhaXQgYXRoZW5hQ2xpZW50LnNlbmQoXG4gICAgICAgICAgbmV3IEdldFF1ZXJ5RXhlY3V0aW9uQ29tbWFuZCh7IFF1ZXJ5RXhlY3V0aW9uSWQ6IHF1ZXJ5RXhlY3V0aW9uSWQgfSlcbiAgICAgICAgKTtcbiAgICAgICAgcXVlcnlTdGF0ZSA9IHF1ZXJ5RXhlY3V0aW9uUmVzdWx0LlF1ZXJ5RXhlY3V0aW9uPy5TdGF0dXM/LlN0YXRlO1xuICAgICAgfSB3aGlsZSAocXVlcnlTdGF0ZSA9PT0gJ1JVTk5JTkcnIHx8IHF1ZXJ5U3RhdGUgPT09ICdRVUVVRUQnKTtcblxuICAgICAgaWYgKHF1ZXJ5U3RhdGUgPT09ICdGQUlMRUQnKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnQXRoZW5hIHF1ZXJ5IGZhaWxlZDogJyArXG4gICAgICAgICAgICAoXG4gICAgICAgICAgICAgIGF3YWl0IGF0aGVuYUNsaWVudC5zZW5kKFxuICAgICAgICAgICAgICAgIG5ldyBHZXRRdWVyeUV4ZWN1dGlvbkNvbW1hbmQoe1xuICAgICAgICAgICAgICAgICAgUXVlcnlFeGVjdXRpb25JZDogcXVlcnlFeGVjdXRpb25JZCxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApLlF1ZXJ5RXhlY3V0aW9uPy5TdGF0dXM/LlN0YXRlQ2hhbmdlUmVhc29uXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIEZldGNoIHJlc3VsdHMgb25jZSBxdWVyeSBzdWNjZWVkc1xuICAgICAgY29uc3QgcXVlcnlSZXN1bHRzID0gYXdhaXQgYXRoZW5hQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXRRdWVyeVJlc3VsdHNDb21tYW5kKHsgUXVlcnlFeGVjdXRpb25JZDogcXVlcnlFeGVjdXRpb25JZCB9KVxuICAgICAgKTtcbiAgICAgIGxvZ3MgPSBxdWVyeVJlc3VsdHMuUmVzdWx0U2V0Py5Sb3dzPy5zbGljZSgxKS5tYXAobWFwQXRoZW5hUm93KSB8fCBbXTsgLy8gU2tpcCBoZWFkZXIgcm93XG5cbiAgICAgIC8vIENhbGN1bGF0ZSB0b3RhbCBwYWdlcyBmb3IgQXRoZW5hIG9ubHkgb24gcGFnZSAxXG4gICAgICBpZiAocGFnZSA9PT0gMSkge1xuICAgICAgICBjb25zdCBjb3VudFF1ZXJ5ID0gYFxuICAgICAgICAgIFNFTEVDVCBDT1VOVCgqKSBhcyB0b3RhbFxuICAgICAgICAgIEZST00gXCJhaV9nYXRld2F5X2xvZ3NcIlxuICAgICAgICAgIFdIRVJFIGRhdGUgPCAnJHt0b2RheX0nXG4gICAgICAgIGA7XG4gICAgICAgIGNvbnN0IHN0YXJ0Q291bnRRdWVyeSA9IG5ldyBTdGFydFF1ZXJ5RXhlY3V0aW9uQ29tbWFuZCh7XG4gICAgICAgICAgUXVlcnlTdHJpbmc6IGNvdW50UXVlcnksXG4gICAgICAgICAgV29ya0dyb3VwOiBBVEhFTkFfV09SS0dST1VQLFxuICAgICAgICAgIFJlc3VsdENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICAgIE91dHB1dExvY2F0aW9uOiBgczM6Ly8ke0xPR19CVUNLRVRfTkFNRX0vYXRoZW5hLXJlc3VsdHMvYCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIFF1ZXJ5RXhlY3V0aW9uQ29udGV4dDogeyBEYXRhYmFzZTogQVRIRU5BX0RBVEFCQVNFIH0sXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBjb3VudEV4ZWN1dGlvbiA9IGF3YWl0IGF0aGVuYUNsaWVudC5zZW5kKHN0YXJ0Q291bnRRdWVyeSk7XG4gICAgICAgIGxldCBjb3VudFN0YXRlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGRvIHtcbiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDAwKSk7XG4gICAgICAgICAgY29uc3QgY291bnRFeGVjdXRpb25SZXN1bHQgPSBhd2FpdCBhdGhlbmFDbGllbnQuc2VuZChcbiAgICAgICAgICAgIG5ldyBHZXRRdWVyeUV4ZWN1dGlvbkNvbW1hbmQoe1xuICAgICAgICAgICAgICBRdWVyeUV4ZWN1dGlvbklkOiBjb3VudEV4ZWN1dGlvbi5RdWVyeUV4ZWN1dGlvbklkLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvdW50U3RhdGUgPSBjb3VudEV4ZWN1dGlvblJlc3VsdC5RdWVyeUV4ZWN1dGlvbj8uU3RhdHVzPy5TdGF0ZTtcbiAgICAgICAgfSB3aGlsZSAoY291bnRTdGF0ZSA9PT0gJ1JVTk5JTkcnIHx8IGNvdW50U3RhdGUgPT09ICdRVUVVRUQnKTtcblxuICAgICAgICBpZiAoY291bnRTdGF0ZSA9PT0gJ1NVQ0NFRURFRCcpIHtcbiAgICAgICAgICBjb25zdCBjb3VudFJlc3VsdHMgPSBhd2FpdCBhdGhlbmFDbGllbnQuc2VuZChcbiAgICAgICAgICAgIG5ldyBHZXRRdWVyeVJlc3VsdHNDb21tYW5kKHtcbiAgICAgICAgICAgICAgUXVlcnlFeGVjdXRpb25JZDogY291bnRFeGVjdXRpb24uUXVlcnlFeGVjdXRpb25JZCxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCB0b3RhbFJvd3MgPSBwYXJzZUludChcbiAgICAgICAgICAgIGNvdW50UmVzdWx0cy5SZXN1bHRTZXQ/LlJvd3M/LlsxXS5EYXRhPy5bMF0uVmFyQ2hhclZhbHVlIHx8ICcwJyxcbiAgICAgICAgICAgIDEwXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0b3RhbFBhZ2VzID0gTWF0aC5jZWlsKHRvdGFsUm93cyAvIFBBR0VfU0laRSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gUXVlcnkgRHluYW1vREIgZm9yIHRvZGF5J3MgbG9ncyB3aXRoIG9mZnNldFxuICAgICAgY29uc3QgdG9kYXkgPSBnZXRUb2RheURhdGUoKTtcbiAgICAgIGNvbnN0IGR5bmFtb1F1ZXJ5ID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogTE9HX1RBQkxFX05BTUUsXG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdQSyA9IDpwayBBTkQgYmVnaW5zX3dpdGgoU0ssIDpzayknLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgJzpwayc6IHsgUzogJ0xPRycgfSwgLy8gQWRqdXN0IGlmIHlvdXIgUEsgaXMgZGlmZmVyZW50XG4gICAgICAgICAgJzpzayc6IHsgUzogdG9kYXkgfSwgLy8gU0sgc3RhcnRzIHdpdGggdG9kYXkncyBkYXRlXG4gICAgICAgIH0sXG4gICAgICAgIFNjYW5JbmRleEZvcndhcmQ6IHRydWUsIC8vIEFzY2VuZGluZyBvcmRlciAoYWRqdXN0IGlmIG5lZWRlZClcbiAgICAgIH0pO1xuXG4gICAgICAvLyBGZXRjaCBhbGwgaXRlbXMgYW5kIG1hbnVhbGx5IHBhZ2luYXRlXG4gICAgICBjb25zdCBkeW5hbW9SZXN1bHQgPSBhd2FpdCBkeW5hbW9DbGllbnQuc2VuZChkeW5hbW9RdWVyeSk7XG4gICAgICBjb25zdCBhbGxMb2dzID0gZHluYW1vUmVzdWx0Lkl0ZW1zPy5tYXAobWFwRHluYW1vSXRlbSkgfHwgW107XG4gICAgICBsb2dzID0gYWxsTG9ncy5zbGljZShvZmZzZXQsIG9mZnNldCArIFBBR0VfU0laRSk7IC8vIFNsaWNlIHRvIGdldCB0aGUgcmVxdWVzdGVkIHBhZ2VcbiAgICAgIHRvdGFsUGFnZXMgPSBNYXRoLmNlaWwoYWxsTG9ncy5sZW5ndGggLyBQQUdFX1NJWkUpOyAvLyBDYWxjdWxhdGUgdG90YWwgcGFnZXMgZm9yIER5bmFtb0RCXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgbG9ncyxcbiAgICAgICAgcGFnZSxcbiAgICAgICAgcGFnZVNpemU6IFBBR0VfU0laRSxcbiAgICAgICAgdG90YWxQYWdlcywgLy8gSW5jbHVkZWQgZm9yIER5bmFtb0RCIGFsd2F5cywgQXRoZW5hIG9uIHBhZ2UgMVxuICAgICAgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBsb2dzOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBtZXNzYWdlOiAnRXJyb3IgZmV0Y2hpbmcgbG9ncycsXG4gICAgICAgIGVycm9yOiBTdHJpbmcoZXJyb3IpLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxufTtcbiJdfQ==
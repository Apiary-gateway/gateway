"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = callLLM;
exports.callLLMWithGuardrail = callLLMWithGuardrail;
const constants_1 = require("./constants");
const token_js_1 = require("token.js");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const simpleCache_1 = require("./simpleCache");
const semanticCache_1 = require("./semanticCache");
const vectorSearch_1 = require("./vectorSearch");
const checkGuardrails_1 = require("./checkGuardrails");
const calculateCost_1 = require("./calculateCost");
const getConfig_1 = require("./getConfig");
const SECRET_NAME = 'llm-provider-api-keys';
const CACHE_USAGE_OBJECT = {
    prompt_tokens: 0,
    completion_tokens: 0,
    total_tokens: 0,
};
let cachedApiKeys = null;
async function loadApiKeys() {
    if (cachedApiKeys)
        return cachedApiKeys;
    const secretsManager = new client_secrets_manager_1.SecretsManagerClient();
    const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: SECRET_NAME });
    const response = await secretsManager.send(command);
    if (response && response.SecretString) {
        cachedApiKeys = JSON.parse(response.SecretString);
    }
    return;
}
async function callLLM({ history, prompt, provider, model, log, userId }) {
    try {
        const config = (0, getConfig_1.getConfig)();
        const simpleCacheResponse = config.cache.enableSimple
            ? await (0, simpleCache_1.checkSimpleCache)(prompt, userId, provider, model)
            : null;
        if (simpleCacheResponse) {
            log.cacheHit('simple');
            return {
                text: JSON.stringify(simpleCacheResponse),
                usage: CACHE_USAGE_OBJECT,
                provider,
                model,
                log: log.getLog(),
                simpleCacheHit: true,
            };
        }
        ;
        const requestEmbedding = config.cache.enableSemantic
            ? await (0, vectorSearch_1.getEmbedding)(prompt)
            : null;
        const semanticCacheResponse = config.cache.enableSemantic
            ? await (0, semanticCache_1.checkSemanticCache)(requestEmbedding, userId, provider, model)
            : null;
        if (semanticCacheResponse) {
            log.cacheHit('semantic');
            return {
                text: semanticCacheResponse,
                usage: CACHE_USAGE_OBJECT,
                provider,
                model,
                log: log.getLog(),
                semanticCacheHit: true
            };
        }
        await loadApiKeys();
        if (cachedApiKeys) {
            for (const [key, value] of Object.entries(cachedApiKeys)) {
                process.env[key] = value;
            }
        }
        const tokenjs = new token_js_1.TokenJS();
        const systemPrompt = process.env.SYSTEM_PROMPT || constants_1.SYSTEM_PROMPT;
        const response = await tokenjs.chat.completions.create({
            provider: provider,
            model: model,
            messages: [
                { role: 'system', content: systemPrompt },
                ...history,
                { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 500
        });
        let responseText = response.choices?.[0]?.message?.content || '';
        let tokensUsed = response.usage;
        const guardrailHit = config.guardrails.enabled
            ? await (0, checkGuardrails_1.checkGuardrails)(prompt, responseText, log)
            : { isBlocked: false };
        if (guardrailHit.isBlocked && guardrailHit.match) {
            if (config.guardrails.resendOnViolation) {
                const retryResponse = await callLLMWithGuardrail({
                    history,
                    prompt,
                    provider,
                    model,
                    log,
                    userId,
                    llmResponse: responseText,
                    match: guardrailHit.match,
                    embeddedPrompt: requestEmbedding
                });
                responseText = retryResponse.text;
                if (tokensUsed && retryResponse.usage) {
                    tokensUsed.prompt_tokens += retryResponse.usage?.prompt_tokens;
                    tokensUsed.completion_tokens += retryResponse.usage?.completion_tokens;
                }
            }
            else {
                responseText = config.guardrails.blockedContentResponse;
            }
        }
        // Asynchronously cache results
        if (config.cache.enableSimple)
            (0, simpleCache_1.addToSimpleCache)(prompt, responseText, userId, provider, model);
        if (config.cache.enableSemantic)
            (0, semanticCache_1.addToSemanticCache)(requestEmbedding, prompt, responseText, userId, provider, model);
        let cost;
        if (tokensUsed) {
            cost = (0, calculateCost_1.calculateCost)(provider, model, tokensUsed.prompt_tokens, tokensUsed.completion_tokens);
        }
        console.log('cost: ', cost);
        return {
            text: responseText,
            usage: tokensUsed,
            provider,
            model,
            log: log.getLog()
        };
    }
    catch (error) {
        console.error(`Error in ${provider} call:`, error);
        throw error;
    }
}
async function callLLMWithGuardrail({ history, prompt, provider, model, log, userId, llmResponse, match, embeddedPrompt }) {
    try {
        const config = (0, getConfig_1.getConfig)();
        const tokenjs = new token_js_1.TokenJS();
        log.guardrailRetry();
        const response = await tokenjs.chat.completions.create({
            provider: provider,
            model: model,
            messages: [
                { role: 'system', content: process.env.SYSTEM_PROMPT || constants_1.SYSTEM_PROMPT },
                ...history,
                {
                    role: 'user',
                    content: prompt,
                },
                {
                    role: 'system',
                    content: llmResponse,
                },
                {
                    role: 'user',
                    content: `I'd like a response that doesn't include the word or phrase ${match}. 
                    Can you please give me a different answer that doesn't include that sentiment?`
                }
            ],
            temperature: 0.7,
            max_tokens: 500
        });
        const responseText = response.choices?.[0]?.message?.content || '';
        const guardrailHit = await (0, checkGuardrails_1.checkGuardrails)(prompt, responseText, log);
        if (guardrailHit.isBlocked) {
            return {
                text: config.guardrails.blockedContentResponse,
                usage: response.usage,
            };
        }
        // don't await - no need to wait here
        (0, simpleCache_1.addToSimpleCache)(prompt, responseText, userId, provider, model);
        (0, semanticCache_1.addToSemanticCache)(embeddedPrompt, prompt, responseText, userId, provider, model);
        return {
            text: responseText,
            usage: response.usage,
        };
    }
    catch (error) {
        console.error(`Error in ${provider} call:`, error);
        throw error;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsbExMTS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xhbWJkYS91dGlsL2NhbGxMTE0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFzQ0EsMEJBZ0hDO0FBRUQsb0RBNERDO0FBcE5ELDJDQUE0QztBQUM1Qyx1Q0FBbUM7QUFFbkMsNEVBQThGO0FBQzlGLCtDQUFtRTtBQUNuRSxtREFHeUI7QUFDekIsaURBQThDO0FBQzlDLHVEQUFvRDtBQUNwRCxtREFBZ0Q7QUFFaEQsMkNBQXdDO0FBRXhDLE1BQU0sV0FBVyxHQUFHLHVCQUF1QixDQUFDO0FBQzVDLE1BQU0sa0JBQWtCLEdBQUc7SUFDekIsYUFBYSxFQUFFLENBQUM7SUFDaEIsaUJBQWlCLEVBQUUsQ0FBQztJQUNwQixZQUFZLEVBQUUsQ0FBQztDQUNoQixDQUFDO0FBRUYsSUFBSSxhQUFhLEdBQWtDLElBQUksQ0FBQztBQUV4RCxLQUFLLFVBQVUsV0FBVztJQUN0QixJQUFJLGFBQWE7UUFBRSxPQUFPLGFBQWEsQ0FBQztJQUV4QyxNQUFNLGNBQWMsR0FBRyxJQUFJLDZDQUFvQixFQUFFLENBQUM7SUFDbEQsTUFBTSxPQUFPLEdBQUcsSUFBSSw4Q0FBcUIsQ0FBQyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQ3JFLE1BQU0sUUFBUSxHQUFHLE1BQU0sY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVwRCxJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEMsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxPQUFPO0FBQ1gsQ0FBQztBQUVjLEtBQUssVUFBVSxPQUFPLENBQUMsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBZTtJQUVoRyxJQUFJLENB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O1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxZQUFZLFFBQVEsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE1BQU0sS0FBSyxDQUFDO0lBQ2hCLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU1lTVEVNX1BST01QVCB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IFRva2VuSlMgfSBmcm9tICd0b2tlbi5qcyc7XG5pbXBvcnQgeyBDYWxsTExNQXJncywgQ2FsbExMTVJlc3BvbnNlIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBTZWNyZXRzTWFuYWdlckNsaWVudCwgR2V0U2VjcmV0VmFsdWVDb21tYW5kIH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zZWNyZXRzLW1hbmFnZXJcIjtcbmltcG9ydCB7IGFkZFRvU2ltcGxlQ2FjaGUsIGNoZWNrU2ltcGxlQ2FjaGUgfSBmcm9tICcuL3NpbXBsZUNhY2hlJztcbmltcG9ydCB7XG4gIGFkZFRvU2VtYW50aWNDYWNoZSxcbiAgY2hlY2tTZW1hbnRpY0NhY2hlLFxufSBmcm9tICcuL3NlbWFudGljQ2FjaGUnO1xuaW1wb3J0IHsgZ2V0RW1iZWRkaW5nIH0gZnJvbSAnLi92ZWN0b3JTZWFyY2gnO1xuaW1wb3J0IHsgY2hlY2tHdWFyZHJhaWxzIH0gZnJvbSAnLi9jaGVja0d1YXJkcmFpbHMnO1xuaW1wb3J0IHsgY2FsY3VsYXRlQ29zdCB9IGZyb20gJy4vY2FsY3VsYXRlQ29zdCc7XG5pbXBvcnQgeyBDb21wbGV0aW9uUmVzcG9uc2UgfSBmcm9tICd0b2tlbi5qcyc7XG5pbXBvcnQgeyBnZXRDb25maWcgfSBmcm9tICcuL2dldENvbmZpZyc7XG5cbmNvbnN0IFNFQ1JFVF9OQU1FID0gJ2xsbS1wcm92aWRlci1hcGkta2V5cyc7XG5jb25zdCBDQUNIRV9VU0FHRV9PQkpFQ1QgPSB7XG4gIHByb21wdF90b2tlbnM6IDAsXG4gIGNvbXBsZXRpb25fdG9rZW5zOiAwLFxuICB0b3RhbF90b2tlbnM6IDAsXG59O1xuXG5sZXQgY2FjaGVkQXBpS2V5czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB8IG51bGwgPSBudWxsO1xuXG5hc3luYyBmdW5jdGlvbiBsb2FkQXBpS2V5cygpIHtcbiAgICBpZiAoY2FjaGVkQXBpS2V5cykgcmV0dXJuIGNhY2hlZEFwaUtleXM7IFxuICBcbiAgICBjb25zdCBzZWNyZXRzTWFuYWdlciA9IG5ldyBTZWNyZXRzTWFuYWdlckNsaWVudCgpO1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0U2VjcmV0VmFsdWVDb21tYW5kKHsgU2VjcmV0SWQ6IFNFQ1JFVF9OQU1FIH0pO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc2VjcmV0c01hbmFnZXIuc2VuZChjb21tYW5kKTtcblxuICAgIGlmIChyZXNwb25zZSAmJiByZXNwb25zZS5TZWNyZXRTdHJpbmcpIHtcbiAgICAgICAgY2FjaGVkQXBpS2V5cyA9IEpTT04ucGFyc2UocmVzcG9uc2UuU2VjcmV0U3RyaW5nKTtcbiAgICB9XG4gIFxuICAgIHJldHVybjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gY2FsbExMTSh7IGhpc3RvcnksIHByb21wdCwgcHJvdmlkZXIsIG1vZGVsLCBsb2csIHVzZXJJZCB9OiBDYWxsTExNQXJncyk6XG4gICAgUHJvbWlzZTxDYWxsTExNUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBjb25maWcgPSBnZXRDb25maWcoKTtcbiAgICAgICAgY29uc3Qgc2ltcGxlQ2FjaGVSZXNwb25zZSA9IGNvbmZpZy5jYWNoZS5lbmFibGVTaW1wbGUgXG4gICAgICAgICAgICA/IGF3YWl0IGNoZWNrU2ltcGxlQ2FjaGUocHJvbXB0LCB1c2VySWQsIHByb3ZpZGVyLCBtb2RlbCkgXG4gICAgICAgICAgICA6IG51bGw7XG4gICAgICAgIGlmIChzaW1wbGVDYWNoZVJlc3BvbnNlKSB7XG4gICAgICAgICAgICBsb2cuY2FjaGVIaXQoJ3NpbXBsZScpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQ6IEpTT04uc3RyaW5naWZ5KHNpbXBsZUNhY2hlUmVzcG9uc2UpLFxuICAgICAgICAgICAgdXNhZ2U6IENBQ0hFX1VTQUdFX09CSkVDVCxcbiAgICAgICAgICAgIHByb3ZpZGVyLFxuICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICBsb2c6IGxvZy5nZXRMb2coKSxcbiAgICAgICAgICAgIHNpbXBsZUNhY2hlSGl0OiB0cnVlLFxuICAgICAgICAgICAgfVxuICAgICAgICB9OyBcbiAgICAgIFxuICAgICAgICBjb25zdCByZXF1ZXN0RW1iZWRkaW5nID0gY29uZmlnLmNhY2hlLmVuYWJsZVNlbWFudGljIFxuICAgICAgICAgICAgPyBhd2FpdCBnZXRFbWJlZGRpbmcocHJvbXB0KVxuICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICBjb25zdCBzZW1hbnRpY0NhY2hlUmVzcG9uc2UgPSBjb25maWcuY2FjaGUuZW5hYmxlU2VtYW50aWMgXG4gICAgICAgICAgICA/IGF3YWl0IGNoZWNrU2VtYW50aWNDYWNoZShyZXF1ZXN0RW1iZWRkaW5nISwgdXNlcklkLCBwcm92aWRlciwgbW9kZWwpXG4gICAgICAgICAgICA6IG51bGw7XG4gICAgICAgIGlmIChzZW1hbnRpY0NhY2hlUmVzcG9uc2UpIHtcbiAgICAgICAgICAgIGxvZy5jYWNoZUhpdCgnc2VtYW50aWMnKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0ZXh0OiBzZW1hbnRpY0NhY2hlUmVzcG9uc2UsXG4gICAgICAgICAgICB1c2FnZTogQ0FDSEVfVVNBR0VfT0JKRUNULFxuICAgICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgICBtb2RlbCxcbiAgICAgICAgICAgIGxvZzogbG9nLmdldExvZygpLFxuICAgICAgICAgICAgc2VtYW50aWNDYWNoZUhpdDogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgXG4gICAgICAgIGF3YWl0IGxvYWRBcGlLZXlzKCk7XG4gICAgICAgIGlmIChjYWNoZWRBcGlLZXlzKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhjYWNoZWRBcGlLZXlzKSkge1xuICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52W2tleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRva2VuanMgPSBuZXcgVG9rZW5KUygpO1xuICAgICAgICBjb25zdCBzeXN0ZW1Qcm9tcHQgPSBwcm9jZXNzLmVudi5TWVNURU1fUFJPTVBUIHx8IFNZU1RFTV9QUk9NUFQ7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdG9rZW5qcy5jaGF0LmNvbXBsZXRpb25zLmNyZWF0ZSh7XG4gICAgICAgICAgICBwcm92aWRlcjogcHJvdmlkZXIsXG4gICAgICAgICAgICBtb2RlbDogbW9kZWwsXG4gICAgICAgICAgICBtZXNzYWdlczogW1xuICAgICAgICAgICAgICAgIHsgcm9sZTogJ3N5c3RlbScsIGNvbnRlbnQ6IHN5c3RlbVByb21wdCB9LFxuICAgICAgICAgICAgICAgIC4uLmhpc3RvcnksXG4gICAgICAgICAgICAgICAgeyByb2xlOiAndXNlcicsIGNvbnRlbnQ6IHByb21wdCB9XG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgdGVtcGVyYXR1cmU6IDAuNyxcbiAgICAgICAgICAgIG1heF90b2tlbnM6IDUwMFxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgcmVzcG9uc2VUZXh0ID0gcmVzcG9uc2UuY2hvaWNlcz8uWzBdPy5tZXNzYWdlPy5jb250ZW50IHx8ICcnO1xuICAgICAgICBsZXQgdG9rZW5zVXNlZCA9IHJlc3BvbnNlLnVzYWdlO1xuXG4gICAgICAgIGNvbnN0IGd1YXJkcmFpbEhpdCA9IGNvbmZpZy5ndWFyZHJhaWxzLmVuYWJsZWQgXG4gICAgICAgICAgICA/IGF3YWl0IGNoZWNrR3VhcmRyYWlscyhwcm9tcHQsIHJlc3BvbnNlVGV4dCwgbG9nKVxuICAgICAgICAgICAgOiB7IGlzQmxvY2tlZDogZmFsc2UgfTtcbiAgICAgICAgaWYgKGd1YXJkcmFpbEhpdC5pc0Jsb2NrZWQgJiYgZ3VhcmRyYWlsSGl0Lm1hdGNoKSB7XG4gICAgICAgICAgICBpZiAoY29uZmlnLmd1YXJkcmFpbHMucmVzZW5kT25WaW9sYXRpb24pIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXRyeVJlc3BvbnNlID0gYXdhaXQgY2FsbExMTVdpdGhHdWFyZHJhaWwoeyBcbiAgICAgICAgICAgICAgICAgICAgaGlzdG9yeSwgXG4gICAgICAgICAgICAgICAgICAgIHByb21wdCwgXG4gICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyLCBcbiAgICAgICAgICAgICAgICAgICAgbW9kZWwsIFxuICAgICAgICAgICAgICAgICAgICBsb2csIFxuICAgICAgICAgICAgICAgICAgICB1c2VySWQsIFxuICAgICAgICAgICAgICAgICAgICBsbG1SZXNwb25zZTogcmVzcG9uc2VUZXh0LCBcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2g6IGd1YXJkcmFpbEhpdC5tYXRjaCwgXG4gICAgICAgICAgICAgICAgICAgIGVtYmVkZGVkUHJvbXB0OiByZXF1ZXN0RW1iZWRkaW5nISB9KTtcblxuICAgICAgICAgICAgICAgIHJlc3BvbnNlVGV4dCA9IHJldHJ5UmVzcG9uc2UudGV4dDtcbiAgICAgICAgICAgICAgICBpZiAodG9rZW5zVXNlZCAmJiByZXRyeVJlc3BvbnNlLnVzYWdlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRva2Vuc1VzZWQucHJvbXB0X3Rva2VucyArPSByZXRyeVJlc3BvbnNlLnVzYWdlPy5wcm9tcHRfdG9rZW5zO1xuICAgICAgICAgICAgICAgICAgICB0b2tlbnNVc2VkLmNvbXBsZXRpb25fdG9rZW5zICs9IHJldHJ5UmVzcG9uc2UudXNhZ2U/LmNvbXBsZXRpb25fdG9rZW5zO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2VUZXh0ID0gY29uZmlnLmd1YXJkcmFpbHMuYmxvY2tlZENvbnRlbnRSZXNwb25zZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBBc3luY2hyb25vdXNseSBjYWNoZSByZXN1bHRzXG4gICAgICAgIGlmIChjb25maWcuY2FjaGUuZW5hYmxlU2ltcGxlKSBhZGRUb1NpbXBsZUNhY2hlKHByb21wdCwgcmVzcG9uc2VUZXh0LCB1c2VySWQsIHByb3ZpZGVyLCBtb2RlbCk7XG4gICAgICAgIGlmIChjb25maWcuY2FjaGUuZW5hYmxlU2VtYW50aWMpIGFkZFRvU2VtYW50aWNDYWNoZShyZXF1ZXN0RW1iZWRkaW5nISwgcHJvbXB0LCByZXNwb25zZVRleHQsIHVzZXJJZCwgcHJvdmlkZXIsIG1vZGVsKTtcblxuICAgICAgICBsZXQgY29zdDtcbiAgICAgICAgaWYgKHRva2Vuc1VzZWQpIHtcbiAgICAgICAgICBjb3N0ID0gY2FsY3VsYXRlQ29zdChcbiAgICAgICAgICAgIHByb3ZpZGVyLCBcbiAgICAgICAgICAgIG1vZGVsLCBcbiAgICAgICAgICAgIHRva2Vuc1VzZWQucHJvbXB0X3Rva2VucywgXG4gICAgICAgICAgICB0b2tlbnNVc2VkLmNvbXBsZXRpb25fdG9rZW5zXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZygnY29zdDogJywgY29zdCk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQ6IHJlc3BvbnNlVGV4dCxcbiAgICAgICAgICAgIHVzYWdlOiB0b2tlbnNVc2VkLFxuICAgICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgICBtb2RlbCxcbiAgICAgICAgICAgIGxvZzogbG9nLmdldExvZygpXG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBpbiAke3Byb3ZpZGVyfSBjYWxsOmAsIGVycm9yKTtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2FsbExMTVdpdGhHdWFyZHJhaWwoeyBoaXN0b3J5LCBwcm9tcHQsIHByb3ZpZGVyLCBtb2RlbCwgbG9nLCB1c2VySWQsIGxsbVJlc3BvbnNlLCBtYXRjaCwgZW1iZWRkZWRQcm9tcHQgfTogXG4gICAgQ2FsbExMTUFyZ3MgJiB7IGxsbVJlc3BvbnNlOiBzdHJpbmcsIG1hdGNoOiBzdHJpbmcsIGVtYmVkZGVkUHJvbXB0OiBudW1iZXJbXSB9KTpcbiAgICBQcm9taXNlPHsgdGV4dDogc3RyaW5nLCB1c2FnZTogQ29tcGxldGlvblJlc3BvbnNlW1widXNhZ2VcIl19PiB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY29uZmlnID0gZ2V0Q29uZmlnKCk7XG4gICAgICAgIGNvbnN0IHRva2VuanMgPSBuZXcgVG9rZW5KUygpO1xuXG4gICAgICAgIGxvZy5ndWFyZHJhaWxSZXRyeSgpO1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRva2VuanMuY2hhdC5jb21wbGV0aW9ucy5jcmVhdGUoe1xuICAgICAgICAgICAgcHJvdmlkZXI6IHByb3ZpZGVyLFxuICAgICAgICAgICAgbW9kZWw6IG1vZGVsLFxuICAgICAgICAgICAgbWVzc2FnZXM6IFtcbiAgICAgICAgICAgICAgICB7IHJvbGU6ICdzeXN0ZW0nLCBjb250ZW50OiBwcm9jZXNzLmVudi5TWVNURU1fUFJPTVBUIHx8IFNZU1RFTV9QUk9NUFQgfSxcbiAgICAgICAgICAgICAgICAuLi5oaXN0b3J5LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgcm9sZTogJ3VzZXInLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBwcm9tcHQsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHJvbGU6ICdzeXN0ZW0nLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBsbG1SZXNwb25zZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHsgXG4gICAgICAgICAgICAgICAgICAgIHJvbGU6ICd1c2VyJyxcbiAgICAgICAgICAgICAgICAgICAgY29udGVudDogYEknZCBsaWtlIGEgcmVzcG9uc2UgdGhhdCBkb2Vzbid0IGluY2x1ZGUgdGhlIHdvcmQgb3IgcGhyYXNlICR7bWF0Y2h9LiBcbiAgICAgICAgICAgICAgICAgICAgQ2FuIHlvdSBwbGVhc2UgZ2l2ZSBtZSBhIGRpZmZlcmVudCBhbnN3ZXIgdGhhdCBkb2Vzbid0IGluY2x1ZGUgdGhhdCBzZW50aW1lbnQ/YFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB0ZW1wZXJhdHVyZTogMC43LFxuICAgICAgICAgICAgbWF4X3Rva2VuczogNTAwXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlVGV4dCA9IHJlc3BvbnNlLmNob2ljZXM/LlswXT8ubWVzc2FnZT8uY29udGVudCB8fCAnJztcblxuICAgICAgICBjb25zdCBndWFyZHJhaWxIaXQgPSBhd2FpdCBjaGVja0d1YXJkcmFpbHMocHJvbXB0LCByZXNwb25zZVRleHQsIGxvZyk7XG4gICAgICAgIGlmIChndWFyZHJhaWxIaXQuaXNCbG9ja2VkKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHRleHQ6IGNvbmZpZy5ndWFyZHJhaWxzLmJsb2NrZWRDb250ZW50UmVzcG9uc2UsXG4gICAgICAgICAgICAgICAgdXNhZ2U6IHJlc3BvbnNlLnVzYWdlLFxuICAgICAgICAgICAgfSBcbiAgICAgICAgfVxuICAgICAgICAvLyBkb24ndCBhd2FpdCAtIG5vIG5lZWQgdG8gd2FpdCBoZXJlXG4gICAgICAgIGFkZFRvU2ltcGxlQ2FjaGUocHJvbXB0LCByZXNwb25zZVRleHQsIHVzZXJJZCwgcHJvdmlkZXIsIG1vZGVsKTtcbiAgICAgICAgYWRkVG9TZW1hbnRpY0NhY2hlKFxuICAgICAgICAgIGVtYmVkZGVkUHJvbXB0LFxuICAgICAgICAgIHByb21wdCxcbiAgICAgICAgICByZXNwb25zZVRleHQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIHByb3ZpZGVyLFxuICAgICAgICAgIG1vZGVsXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRleHQ6IHJlc3BvbnNlVGV4dCxcbiAgICAgICAgICAgIHVzYWdlOiByZXNwb25zZS51c2FnZSxcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGluICR7cHJvdmlkZXJ9IGNhbGw6YCwgZXJyb3IpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG59Il19